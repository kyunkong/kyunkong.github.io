<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/static/css/colorful.css">
    <link rel="Stylesheet" type="text/css" href="/static/css/style.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <!-- <link rel="icon" href="/favicon.ico" type="image/x-icon"> -->
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>DB2 All in One - Fung's wiki</title>
    <!-- <meta name="keywords" content=""/> -->
    <!-- <meta name="description" content=""/> -->
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
  </head>

  <body>
    <div id="container" class="typo">
      
<div id="header">
  <div id="post-nav">
    <a href="/">Fung's wiki</a>
    &nbsp;&#187;&nbsp;
    <a href="/#db2">db2</a>
    &nbsp;&#187;&nbsp;DB2 All in One
    <span class="updated">Last Update: &nbsp;
    2018-01-17 11:15:28
    </span>
  </div>
</div>
<div class="clearfix"></div>
<div id="content">
  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#db2-foudamentals-concepts">DB2 Foudamentals Concepts</a><ul>
<li><a href="#background-process">background process:</a></li>
</ul>
</li>
<li><a href="#db2cfexp-db2cfimp">db2cfexp &amp; db2cfimp</a><ul>
<li><a href="#db2-tablespace-status">DB2 tablespace status</a></li>
<li><a href="#how-to-find-table-space-status-in-db2">how to find table space status in DB2</a></li>
</ul>
</li>
<li><a href="#db2iupdt-u-db2inst1-db2inst1">./db2iupdt -u db2inst1 db2inst1</a></li>
<li><a href="#client">诊断Client连接问题</a></li>
<li><a href="#rename-column">Rename column</a></li>
<li><a href="#tablespace">tablespace 相关操作</a></li>
<li><a href="#bufferpool">查看bufferpool</a></li>
<li><a href="#db2">查看安装了哪些DB2组件</a></li>
<li><a href="#find-table-in-which-tablespaces">find table in which tablespaces</a></li>
<li><a href="#syscatcatalog-view">查看syscat所有的catalog view</a></li>
<li><a href="#memory-allocation">Memory allocation</a></li>
<li><a href="#_1">查看用户表空间</a></li>
<li><a href="#extract-the-whole-schema">Extract the whole schema</a></li>
<li><a href="#truncate-a-table-in-db2">truncate a table in DB2</a></li>
<li><a href="#db2-authorizations">DB2 authorizations</a></li>
<li><a href="#client-connections-relative">Client Connections Relative</a></li>
<li><a href="#catalog-node">catalog node</a></li>
<li><a href="#catalog-db">catalog db</a></li>
<li><a href="#login-using-client">login using client</a></li>
<li><a href="#db2_1">DB2随机启动</a></li>
<li><a href="#db2_2">DB2日志状态</a></li>
<li><a href="#monitor-log-space-usage">Monitor log space usage:</a></li>
<li><a href="#find-fence-id-owner">Find fence ID owner</a></li>
<li><a href="#change-log-mode-to-archive-log">Change log mode to archive log</a></li>
<li><a href="#archive-log-history">查找archive log history</a></li>
<li><a href="#_2">手动归档日志</a></li>
<li><a href="#_3">修改在线日志数目</a></li>
<li><a href="#_4">查看数据库是否处于归档模式</a></li>
<li><a href="#offline-backup">offline backup</a></li>
<li><a href="#online-backup-plus-logs">online backup plus logs</a></li>
<li><a href="#looking-for-db-backup-progress">Looking for DB backup progress</a></li>
<li><a href="#_5">备份介质管理</a></li>
<li><a href="#naming-convention">Naming convention</a></li>
<li><a href="#db2ckbkp-metadata">db2ckbkp命令--检查介质完整性，显示备份文件的metadata信息</a></li>
<li><a href="#-">检测前滚所需日志--增量恢复检查</a></li>
<li><a href="#incremental-restore">incremental restore</a></li>
<li><a href="#recovery">Recovery</a></li>
<li><a href="#restore-recovery-examples">Restore &amp; Recovery Examples</a><ul>
<li><a href="#end-of-logroll-forward">以end of log进行roll forward</a></li>
<li><a href="#end-of-backuproll-forward">以end of backup进行roll forward</a></li>
<li><a href="#backup-in-the-source-db">backup in the source db</a></li>
<li><a href="#restore-tablespace-on-the-target-db">restore tablespace on the target db</a></li>
</ul>
</li>
<li><a href="#_6">运维工具</a><ul>
<li><a href="#export-table-to-ixf">export table to ixf</a></li>
<li><a href="#import-table">import table</a></li>
</ul>
</li>
<li><a href="#reorg-history">Reorg history</a></li>
<li><a href="#_7">数据库占用空间的大小</a></li>
<li><a href="#_8">表空间占用大小</a></li>
<li><a href="#_9">表/索引占用空间大小</a><ul>
<li><a href="#perform-the-select-below-to-know-the-size-one-table">Perform the select below to know the size one table:</a></li>
<li><a href="#perform-the-select-below-to-know-the-size-all-tables-in-a-specific-schema">Perform the select below to know the size all tables in a specific schema:</a></li>
<li><a href="#perform-the-select-below-to-know-the-size-of-all-schema">Perform the select below to know the size of all schema:</a></li>
</ul>
</li>
<li><a href="#lock">Lock</a><ul>
<li><a href="#session-isolation-level">查询当前session isolation level</a></li>
</ul>
</li>
<li><a href="#db2_3">DB2内存使用查看</a></li>
<li><a href="#db2_4">DB2监控工具</a></li>
<li><a href="#db2gcfg">db2gcfg查看实例状态</a></li>
<li><a href="#finding-rebalance-status">finding rebalance status</a></li>
<li><a href="#db2rbind-db2-bind">db2rbind &amp; db2 bind</a><ul>
<li><a href="#db2relocation">DB2重命名或者relocation</a></li>
<li><a href="#restore">如果在restore中遇到</a></li>
<li><a href="#create-primary-constrain-counter-sql0542n">create primary constrain counter SQL0542N</a></li>
<li><a href="#performance-tunning-tips">Performance tunning tips</a></li>
<li><a href="#db2-utilities">DB2 utilities</a></li>
<li><a href="#generate-duplicate-database-ddl-by-using-db2look">generate duplicate database DDL by using db2look</a></li>
<li><a href="#data-movement">Data movement</a><ul>
<li><a href="#find-the-special-build-version-of-db2-source-code">find the special build version of db2 source code</a></li>
<li><a href="#db2updv97-sqlcode-912">db2updv97: sqlcode -912</a></li>
<li><a href="#finding-the-table-stataus">Finding the table stataus</a></li>
<li><a href="#finding-all-database-path">Finding all database path</a></li>
<li><a href="#finding-db2level-via-sys-views">Finding db2level via sys views</a></li>
<li><a href="#discovering-and-hiding-server-instances-and-databases">Discovering and hiding server instances and databases</a></li>
<li><a href="#finding-all-tables-status">Finding all tables status</a></li>
<li><a href="#health-monitor-tablespace">health monitor -- tablespace</a></li>
<li><a href="#log-utilization">Log utilization</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#windows-server-operations">Windows server operations</a><ul>
<li><a href="#multiple-instances-switch">Multiple instances switch</a></li>
<li><a href="#issues">Issues</a></li>
<li><a href="#converting-sms-tablespace-to-dms-tablespacemigrating-the-data-from-one-tablespace-to-another-tablespace">Converting SMS tablespace to DMS tablespace(Migrating the data from one tablespace to another tablespace)</a></li>
<li><a href="#option-1-extract-the-whole-ddls-by-the-specific-schema">Option 1. Extract the whole DDLs by the specific schema</a></li>
<li><a href="#option-2-extract-the-whole-ddls-by-the-specific-tablespace">Option 2. Extract the whole DDLs by the specific tablespace</a></li>
<li><a href="#2-export-all-the-data-belong-to-the-tbs">2. Export all the data belong to the TBS</a></li>
<li><a href="#3-create-new-tbs">3. Create new tbs</a></li>
<li><a href="#4-drop-the-tbs">4. Drop the tbs</a></li>
<li><a href="#5-replace-the-tablespace-to-convert1-in-the-fung_schemasql-and-db2inst1_schemasql">5. Replace the tablespace to convert1 in the fung_schema.sql and db2inst1_schema.sql</a></li>
<li><a href="#6-create-the-table">6. Create the table</a></li>
<li><a href="#7-load-the-data-back-to-the-new-tablespace">7. Load the data back to the new tablespace</a></li>
<li><a href="#8-set-integrity">8. Set integrity</a><ul>
<li><a href="#finding-the-table-status">Finding the table status</a></li>
<li><a href="#if-some-tables-are-co-dependents-tables-we-need-to-execute-the-tables-as-a-whole-set-integrity-command">If some tables are co-dependents tables, we need to execute the tables as a whole set integrity command</a></li>
</ul>
</li>
<li><a href="#privilege">Privilege</a></li>
<li><a href="#binding-packages">Binding Packages</a><ul>
<li><a href="#tsm-restart-db2vend">TSM restart db2vend</a></li>
</ul>
</li>
<li><a href="#sql0551n-user-do-not-have-the-required-authorization">SQL0551N user do not have the required authorization</a><ul>
<li><a href="#getting-the-quiesce-status-of-instancedatabase">getting the quiesce status of instance/database</a></li>
<li><a href="#tsm-kud-issue">TSM kud issue</a></li>
</ul>
</li>
<li><a href="#stop-tivoli-monitoring-before-upgrade">stop tivoli monitoring before upgrade</a></li>
<li><a href="#db2-error-code">db2 error code:</a></li>
<li><a href="#to-display-all-logged-error-messages-containing-the-db2-zrc-return-code">To display all logged error messages containing the DB2 ZRC return code</a></li>
<li><a href="#db2-privilege-catalog-view">DB2 privilege catalog view</a></li>
<li><a href="#snap-catalog-view">snap catalog view</a></li>
<li><a href="#db2-table-size">DB2 table size</a></li>
<li><a href="#db2-index-size">DB2 index size</a></li>
</ul>
</li>
<li><a href="#db2dart-demo">db2dart demo</a><ul>
<li><a href="#1-extract-the-ddl-with-db2look">1. extract the DDL with db2look</a></li>
<li><a href="#2-finding-the-specific-table-resided-in-which-tablespace">2. finding the specific table resided in which tablespace</a></li>
<li><a href="#3-extract-the-data-with-db2dart">3. extract the data with db2dart</a></li>
<li><a href="#4-load-the-data-into-the-table">4. load the data into the table</a></li>
</ul>
</li>
</ul>
</div>
<h2 id="db2-foudamentals-concepts">DB2 Foudamentals Concepts</h2>
<h3 id="background-process">background process:</h3>
<p>1.db2sysc<br />
DB2 main system controller or engine, starting from v9.5, there is only one mutil-threaded main engine process for the entire partition. All EDUs(Engine Dispatchable Units) are threads inside this process. Without this process, database server cannot funtion. The process responsible for start-up and shut-down and the management of the runing instance.<br />
2.db2wdog<br />
DB2 watch dog, is the parent of db2sysc, it clean up resources if the db2sysc process abnormally terminates. The daemon s funtion like PMON in oracle.<br />
3.db2acd<br />
The automatic computing daemon, it performs client side automatic tasks, such as health monitor, automatic maintenance utilities.<br />
4.db2vend<br />
Third party vendors process interact with DB2, such as TSM--dsmc in TSM client backup schedule.<br />
5.db2fmp<br />
Fenced processes that run user code on the server outside the firewall for both stored procedures and user defined functions.<br />
6.db2tcpcm<br />
TCP/IP communication protocal listener.<br />
7.db2agent<br />
Coordinator agent that perform database operations on behalf of applications.<br />
8.db2agentp ---------<strong><em>*</em></strong><strong><em>*</em></strong>-----------<br />
Perform database operations for the application. db2agent will coordinate the work between the different db2agentp subagents. The dbm parameter "INTRA_PARALLEL" set to YES.<br />
9.db2pfchr<br />
DB2 asynchronous I/O data prefetcher(NUM_IOSERVERS)--like Oracle server process<br />
10.db2pclnr<br />
DB2 asynchronous I/O data writer(NUM_IOCLEANERS)--like Oracle DBWn</p>
<h2 id="db2cfexp-db2cfimp">db2cfexp &amp; db2cfimp</h2>
<div class="hlcode"><pre><span class="p">[</span><span class="n">db2ace</span><span class="err">@</span><span class="n">oc7421025535</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">db2cfexp</span>
 <span class="n">db2cfexp</span> <span class="n">exports</span> <span class="n">configuration</span> <span class="n">information</span><span class="p">.</span>

   <span class="n">db2cfexp</span> <span class="n">fname</span> <span class="p">[</span> <span class="n">template</span> <span class="o">|</span> <span class="n">backup</span> <span class="o">|</span> <span class="n">maintain</span> <span class="p">]</span>
                    <span class="o">-</span>          <span class="o">-</span>        <span class="o">-</span>

     <span class="n">fname</span> <span class="o">-</span> <span class="n">path</span><span class="o">/</span><span class="n">filename</span> <span class="n">of</span> <span class="n">the</span> <span class="n">export</span> <span class="n">profile</span><span class="p">.</span>

<span class="nl">Options:</span>
   <span class="n">template</span> <span class="o">-</span> <span class="n">create</span> <span class="n">a</span> <span class="n">generic</span> <span class="n">export</span> <span class="n">profile</span> <span class="n">to</span>
              <span class="n">transfer</span> <span class="n">this</span> <span class="n">configuration</span> <span class="n">to</span> <span class="n">another</span>
              <span class="n">workstation</span><span class="p">.</span> <span class="p">(</span><span class="n">incl</span><span class="p">.</span> <span class="n">configuration</span> <span class="n">info</span><span class="p">,</span>
              <span class="n">catalog</span> <span class="n">info</span><span class="p">,</span> <span class="n">ODBC</span> <span class="n">info</span> <span class="p">).</span>

   <span class="n">maintain</span> <span class="o">-</span> <span class="n">create</span> <span class="n">a</span> <span class="n">Database</span> <span class="n">export</span> <span class="n">profile</span> <span class="n">to</span>
              <span class="n">transfer</span> <span class="n">the</span> <span class="n">Database</span> <span class="n">catalog</span> <span class="n">information</span>
              <span class="n">to</span> <span class="n">another</span> <span class="n">workstation</span><span class="p">.</span>

   <span class="n">backup</span>   <span class="o">-</span> <span class="n">create</span> <span class="n">a</span> <span class="n">backup</span> <span class="n">configuration</span> <span class="n">profile</span> <span class="k">for</span>
              <span class="n">backup</span> <span class="n">purposes</span> <span class="n">at</span> <span class="n">this</span> <span class="n">workstation</span> <span class="n">only</span><span class="p">.</span>

<span class="p">[</span><span class="n">db2ace</span><span class="err">@</span><span class="n">oc7421025535</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">db2cfimp</span>
 <span class="n">db2cfimp</span> <span class="n">imports</span> <span class="n">configuration</span> <span class="n">information</span><span class="p">.</span>

   <span class="n">db2cfimp</span> <span class="n">fname</span>

     <span class="n">fname</span> <span class="o">-</span> <span class="n">path</span><span class="o">/</span><span class="n">filename</span> <span class="n">of</span> <span class="n">the</span> <span class="n">profile</span> <span class="n">to</span> <span class="n">be</span> <span class="n">imported</span>
</pre></div>


<h3 id="db2-tablespace-status">DB2 tablespace status</h3>
<div class="hlcode"><pre><span class="mh">0x0</span>                 <span class="n">Normal</span>
<span class="mh">0x1</span>                 <span class="n">Quiesced</span><span class="o">:</span> <span class="n">SHARE</span>
<span class="mh">0x2</span>                 <span class="n">Quiesced</span><span class="o">:</span> <span class="n">UPDATE</span>
<span class="mh">0x4</span>                 <span class="n">Quiesced</span><span class="o">:</span> <span class="n">EXCLUSIVE</span>
<span class="mh">0x8</span>                 <span class="n">Load</span> <span class="n">pending</span>
<span class="mh">0x10</span>               <span class="n">Delete</span> <span class="n">pending</span>
<span class="mh">0x20</span>               <span class="n">Backup</span> <span class="n">pending</span>
<span class="mh">0x40</span>               <span class="n">Roll</span> <span class="n">forward</span> <span class="n">in</span> <span class="n">progress</span>
<span class="mh">0x80</span>               <span class="n">Roll</span> <span class="n">forward</span> <span class="n">pending</span>
<span class="mh">0x100</span>             <span class="n">Restore</span> <span class="n">pending</span>
<span class="mh">0x100</span>             <span class="n">Recovery</span> <span class="n">pending</span> <span class="p">(</span><span class="n">not</span> <span class="n">used</span><span class="p">)</span>
<span class="mh">0x200</span>             <span class="n">Disable</span> <span class="n">pending</span>
<span class="mh">0x400</span>             <span class="n">Reorg</span> <span class="n">in</span> <span class="n">progress</span>
<span class="mh">0x800</span>             <span class="n">Backup</span> <span class="n">in</span> <span class="n">progress</span>
<span class="mh">0x1000</span>           <span class="n">Storage</span> <span class="n">must</span> <span class="n">be</span> <span class="n">defined</span>
<span class="mh">0x2000</span>           <span class="n">Restore</span> <span class="n">in</span> <span class="n">progress</span>
<span class="mh">0x4000</span>           <span class="n">Offline</span> <span class="n">and</span> <span class="n">not</span> <span class="n">accessible</span>
<span class="mh">0x8000</span>           <span class="n">Drop</span> <span class="n">pending</span>
<span class="mh">0x2000000</span>     <span class="n">Storage</span> <span class="n">may</span> <span class="n">be</span> <span class="n">defined</span>
<span class="mh">0x4000000</span>     <span class="n">StorDef</span> <span class="n">is</span> <span class="n">in</span> <span class="err">&#39;</span><span class="n">final</span><span class="err">&#39;</span> <span class="n">state</span>
<span class="mh">0x8000000</span>     <span class="n">StorDef</span> <span class="n">was</span> <span class="n">changed</span> <span class="n">prior</span> <span class="n">to</span> <span class="n">rollforward</span>
<span class="mh">0x10000000</span>   <span class="n">DMS</span> <span class="n">rebalancer</span> <span class="n">is</span> <span class="n">active</span>
<span class="mh">0x20000000</span>   <span class="n">TBS</span> <span class="n">deletion</span> <span class="n">in</span> <span class="n">progress</span>
<span class="mh">0x40000000</span>   <span class="n">TBS</span> <span class="n">creation</span> <span class="n">in</span> <span class="n">progress</span>
<span class="mh">0x8</span>                 <span class="n">For</span> <span class="n">service</span> <span class="n">use</span> <span class="n">only</span>
</pre></div>


<h3 id="how-to-find-table-space-status-in-db2">how to find table space status in DB2</h3>
<div class="hlcode"><pre><span class="p">[</span><span class="n">db2v10i</span><span class="err">@</span><span class="n">hadr02</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">db2tbst</span> <span class="mh">0x8000</span>
<span class="n">State</span> <span class="o">=</span> <span class="n">Drop</span> <span class="n">pending</span>
</pre></div>


<p>db2iupgrade VS db2iupdt<br />
When upgrading an instance from one fixpack to a higher fixpack on the same release use db2iupdt.</p>
<p>If you are upgrading an instance from one release to another (Eg. from v9.7 to v10.1) use db2iupgrade.</p>
<p>If you try to use db2iupdt to upgrade an instance from one release to another, it will fail with a DBI1978E error.</p>
<p>Example: Trying to upgrade instance - db2inst1 from DB2 v9.7 to DB2 v10.1:</p>
<h2 id="db2iupdt-u-db2inst1-db2inst1">./db2iupdt -u db2inst1 db2inst1</h2>
<p>DBI1446I  The db2iupdt command is running.</p>
<p>DB2 installation is being initialized.</p>
<p>DBI1978E  Updating instance db2inst1 failed because the release<br />
      of the DB2 copy on which the instance is running is not the same<br />
      as the release of the target DB2 copy. Release of DB2 copy on<br />
      which the instance is running: 9.7. Release of<br />
      target DB2 copy: 10.1.</p>
<h2 id="client">诊断Client连接问题</h2>
<p>1.查看client是否有连接<br />
db2 list applications<br />
2.查看Server端环境变量设置<br />
db2set -all<br />
3.查看DB manager配置<br />
db2 get dbm cfg |grep -i svcename<br />
4.查看server端/etc/services<br />
cat /etc/services |grep -i db2<br />
5.查看端口是否有被监听<br />
netstat -apn |grep -i db2sysc</p>
<h2 id="rename-column">Rename column</h2>
<div class="hlcode"><pre><span class="n">db2</span> <span class="s">&quot;alter table table_name rename column COL_NAME to NEW_COL_NAME&quot;</span>
</pre></div>


<h2 id="tablespace">tablespace 相关操作</h2>
<div class="hlcode"><pre><span class="n">db2</span> <span class="n">list</span> <span class="n">tablespaces</span> <span class="p">[</span><span class="n">show</span> <span class="n">detail</span><span class="p">]</span>
<span class="n">db2</span> <span class="n">list</span> <span class="n">tablespace</span> <span class="n">container</span> <span class="k">for</span> <span class="n">container_id</span> <span class="p">[</span><span class="n">show</span> <span class="n">detail</span><span class="p">]</span>
<span class="n">db2</span> <span class="s">&quot;select * from syscat.tablespaces&quot;</span>
<span class="n">db2</span> <span class="n">get</span> <span class="n">snapshot</span> <span class="k">for</span> <span class="n">tablespaces</span> <span class="n">on</span> <span class="n">db_name</span>
<span class="n">db2pd</span> <span class="o">-</span><span class="n">db</span> <span class="n">db_name</span> <span class="o">-</span><span class="n">tablespaces</span>
<span class="o">--</span><span class="n">AR</span> <span class="err">#</span><span class="n">AutoReize</span>
<span class="o">--</span><span class="n">AS</span> <span class="err">#</span><span class="n">AutoStorage</span>

<span class="n">db2pd</span> <span class="o">-</span><span class="n">d</span> <span class="n">db_name</span> <span class="o">-</span><span class="n">storagepaths</span>
</pre></div>


<h2 id="bufferpool">查看bufferpool</h2>
<div class="hlcode"><pre><span class="n">db2</span> <span class="s">&quot;select char(bpname,20) as bpname,BUFFERPOOLID,char(DBPGNAME,20) as dbpgname,NPAGES,PAGESIZE,ESTORE,NUMBLOCKPAGES,BLOCKSIZE,char(NGNAME,20) as ngname from syscat.bufferpools&quot;</span>
<span class="n">db2pd</span> <span class="o">-</span><span class="n">d</span> <span class="n">db_name</span> <span class="o">-</span><span class="n">buff</span>
<span class="n">SELECT</span> <span class="n">TOTAL_HIT_RATIO_PERCENT</span><span class="p">,</span> <span class="n">DATA_HIT_RATIO_PERCENT</span><span class="p">,</span> <span class="n">INDEX_HIT_RATIO_PERCENT</span><span class="p">,</span> <span class="n">substr</span><span class="p">(</span><span class="n">BP_NAME</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">20</span><span class="p">)</span> <span class="n">as</span> <span class="n">bufferpool</span> <span class="n">FROM</span> <span class="n">SYSIBMADM</span><span class="p">.</span><span class="n">BP_HITRATIO</span>
</pre></div>


<h2 id="db2">查看安装了哪些DB2组件</h2>
<div class="hlcode"><pre><span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">db2ls</span> <span class="o">-</span><span class="n">a</span> <span class="o">-</span><span class="n">q</span> <span class="o">-</span><span class="n">b</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">ibm</span><span class="o">/</span><span class="n">db2</span><span class="o">/</span><span class="n">V9</span><span class="mf">.7</span><span class="o">/</span>
<span class="n">db2inst3</span><span class="err">@</span><span class="n">pokziscsrv40</span><span class="o">:/</span><span class="n">opt</span><span class="o">/</span><span class="n">ibm</span><span class="o">/</span><span class="n">db2</span><span class="o">/</span><span class="n">V9</span><span class="mf">.7</span><span class="n">_FP8</span><span class="o">&gt;</span> <span class="n">db2ls</span> <span class="o">-</span><span class="n">q</span> <span class="o">-</span><span class="n">p</span> <span class="o">-</span><span class="n">b</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">ibm</span><span class="o">/</span><span class="n">db2</span><span class="o">/</span><span class="n">V9</span><span class="mf">.7</span><span class="n">_FP11_SB_35317</span>

<span class="n">Install</span> <span class="n">Path</span> <span class="o">:</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">ibm</span><span class="o">/</span><span class="n">db2</span><span class="o">/</span><span class="n">V9</span><span class="mf">.7</span><span class="n">_FP11_SB_35317</span>

<span class="n">Product</span> <span class="n">Response</span> <span class="n">File</span> <span class="n">ID</span>                  <span class="n">Level</span>   <span class="n">Fix</span> <span class="n">Pack</span>   <span class="n">Product</span> <span class="n">Description</span>
<span class="o">---------------------------------------------------------------------------------------------------------------------</span>
<span class="n">ENTERPRISE_SERVER_EDITION</span>               <span class="mf">9.7.0.11</span>         <span class="mi">11</span>   <span class="n">DB2</span> <span class="n">Enterprise</span> <span class="n">Server</span> <span class="n">Edition</span>
</pre></div>


<h2 id="find-table-in-which-tablespaces">find table in which tablespaces</h2>
<div class="hlcode"><pre><span class="n">db2</span> <span class="s">&quot;select substr(tabname,1,20),substr(tbspace,1,30) from syscat.tables where TBSPACE=&#39;SYSTOOLSPACE&#39;&quot;</span>
<span class="n">db2</span> <span class="s">&quot;select substr(tabname,1,20),substr(tbspace,1,30) from syscat.tables where tabname=&#39;POLICY&#39;&quot;</span>
</pre></div>


<h2 id="syscatcatalog-view">查看syscat所有的catalog view</h2>
<div class="hlcode"><pre><span class="n">list</span> <span class="n">tables</span> <span class="k">for</span> <span class="n">schema</span> <span class="n">syscat</span>
<span class="n">select</span> <span class="n">tabname</span> <span class="n">from</span> <span class="n">syscat</span><span class="p">.</span><span class="n">tables</span> <span class="n">where</span> <span class="n">tabschema</span><span class="o">=</span><span class="err">&#39;</span><span class="n">SYSCAT</span><span class="err">&#39;</span>


<span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="n">worktmp</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="n">list</span> <span class="n">command</span> <span class="n">options</span>

     <span class="n">Command</span> <span class="n">Line</span> <span class="n">Processor</span> <span class="n">Option</span> <span class="n">Settings</span>

 <span class="n">Backend</span> <span class="n">process</span> <span class="n">wait</span> <span class="n">time</span> <span class="p">(</span><span class="n">seconds</span><span class="p">)</span>        <span class="p">(</span><span class="n">DB2BQTIME</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span>
 <span class="n">No</span><span class="p">.</span> <span class="n">of</span> <span class="n">retries</span> <span class="n">to</span> <span class="n">connect</span> <span class="n">to</span> <span class="n">backend</span>        <span class="p">(</span><span class="n">DB2BQTRY</span><span class="p">)</span> <span class="o">=</span> <span class="mi">60</span>
 <span class="n">Request</span> <span class="n">queue</span> <span class="n">wait</span> <span class="n">time</span> <span class="p">(</span><span class="n">seconds</span><span class="p">)</span>          <span class="p">(</span><span class="n">DB2RQTIME</span><span class="p">)</span> <span class="o">=</span> <span class="mi">5</span>
 <span class="n">Input</span> <span class="n">queue</span> <span class="n">wait</span> <span class="n">time</span> <span class="p">(</span><span class="n">seconds</span><span class="p">)</span>            <span class="p">(</span><span class="n">DB2IQTIME</span><span class="p">)</span> <span class="o">=</span> <span class="mi">5</span>
 <span class="n">Command</span> <span class="n">options</span>                           <span class="p">(</span><span class="n">DB2OPTIONS</span><span class="p">)</span> <span class="o">=</span>

 <span class="n">Option</span>  <span class="n">Description</span>                               <span class="n">Current</span> <span class="n">Setting</span>
 <span class="o">------</span>  <span class="o">----------------------------------------</span>  <span class="o">---------------</span>
   <span class="o">-</span><span class="n">a</span>    <span class="n">Display</span> <span class="n">SQLCA</span>                             <span class="n">OFF</span>
   <span class="o">-</span><span class="n">c</span>    <span class="n">Auto</span><span class="o">-</span><span class="n">Commit</span>                               <span class="n">ON</span>
   <span class="o">-</span><span class="n">d</span>    <span class="n">Retrieve</span> <span class="n">and</span> <span class="n">display</span> <span class="n">XML</span> <span class="n">declarations</span>     <span class="n">OFF</span>
   <span class="o">-</span><span class="n">e</span>    <span class="n">Display</span> <span class="n">SQLCODE</span><span class="o">/</span><span class="n">SQLSTATE</span>                  <span class="n">OFF</span>
   <span class="o">-</span><span class="n">f</span>    <span class="n">Read</span> <span class="n">from</span> <span class="n">input</span> <span class="n">file</span>                      <span class="n">OFF</span>
   <span class="o">-</span><span class="n">i</span>    <span class="n">Display</span> <span class="n">XML</span> <span class="n">data</span> <span class="n">with</span> <span class="n">indentation</span>         <span class="n">OFF</span>
   <span class="o">-</span><span class="n">l</span>    <span class="n">Log</span> <span class="n">commands</span> <span class="n">in</span> <span class="n">history</span> <span class="n">file</span>              <span class="n">OFF</span>
   <span class="o">-</span><span class="n">m</span>    <span class="n">Display</span> <span class="n">the</span> <span class="n">number</span> <span class="n">of</span> <span class="n">rows</span> <span class="n">affected</span>       <span class="n">OFF</span>
   <span class="o">-</span><span class="n">n</span>    <span class="n">Remove</span> <span class="n">new</span> <span class="n">line</span> <span class="n">character</span>                 <span class="n">OFF</span>
   <span class="o">-</span><span class="n">o</span>    <span class="n">Display</span> <span class="n">output</span>                            <span class="n">ON</span>
   <span class="o">-</span><span class="n">p</span>    <span class="n">Display</span> <span class="n">interactive</span> <span class="n">input</span> <span class="n">prompt</span>          <span class="n">ON</span>
   <span class="o">-</span><span class="n">q</span>    <span class="n">Preserve</span> <span class="n">whitespaces</span> <span class="o">&amp;</span> <span class="n">linefeeds</span>          <span class="n">OFF</span>
   <span class="o">-</span><span class="n">r</span>    <span class="n">Save</span> <span class="n">output</span> <span class="n">to</span> <span class="n">report</span> <span class="n">file</span>                <span class="n">OFF</span>
   <span class="o">-</span><span class="n">s</span>    <span class="n">Stop</span> <span class="n">execution</span> <span class="n">on</span> <span class="n">command</span> <span class="n">error</span>           <span class="n">OFF</span>
   <span class="o">-</span><span class="n">t</span>    <span class="n">Set</span> <span class="n">statement</span> <span class="n">termination</span> <span class="n">character</span>       <span class="n">OFF</span>
   <span class="o">-</span><span class="n">v</span>    <span class="n">Echo</span> <span class="n">current</span> <span class="n">command</span>                      <span class="n">OFF</span>
   <span class="o">-</span><span class="n">w</span>    <span class="n">Display</span> <span class="n">FETCH</span><span class="o">/</span><span class="n">SELECT</span> <span class="n">warning</span> <span class="n">messages</span>     <span class="n">ON</span>
   <span class="o">-</span><span class="n">x</span>    <span class="n">Suppress</span> <span class="n">printing</span> <span class="n">of</span> <span class="n">column</span> <span class="n">headings</span>      <span class="n">OFF</span>
   <span class="o">-</span><span class="n">z</span>    <span class="n">Save</span> <span class="n">all</span> <span class="n">output</span> <span class="n">to</span> <span class="n">output</span> <span class="n">file</span>            <span class="n">OFF</span>
</pre></div>


<h2 id="memory-allocation">Memory allocation</h2>
<p>DSS: evenly allocate between buffer pool and sort area, because OLAP need scan large of data and perform a number of sorts<br />
OLTP: dedicate approximately 75 percent of your available memory to the buffer pool and divide the rest among the sort heaps.</p>
<h2 id="_1">查看用户表空间</h2>
<div class="hlcode"><pre><span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="n">scripts</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="s">&quot;select tabname, tbspace from syscat.tables where tabschema=&#39;DB2INST1&#39;&quot;</span>
</pre></div>


<h2 id="extract-the-whole-schema">Extract the whole schema</h2>
<div class="hlcode"><pre><span class="n">db2look</span> <span class="o">-</span><span class="n">d</span> <span class="n">testdb</span> <span class="o">-</span><span class="n">z</span> <span class="n">FUNG</span> <span class="o">-</span><span class="n">e</span> <span class="o">-</span><span class="n">o</span> <span class="o">~/</span><span class="n">schema_db2look</span><span class="p">.</span><span class="n">sql</span>

<span class="n">db2look</span> <span class="o">-</span><span class="n">d</span> <span class="n">dn_name</span> <span class="o">-</span><span class="n">l</span> <span class="o">--</span><span class="n">extract</span> <span class="n">DDL</span> <span class="n">about</span> <span class="n">tablespaces</span>
<span class="n">db2look</span> <span class="o">-</span><span class="n">d</span> <span class="n">db_name</span> <span class="o">-</span><span class="n">t</span> <span class="n">table_name</span> <span class="o">-</span><span class="n">e</span> <span class="o">--</span><span class="n">extract</span> <span class="n">DDL</span> <span class="n">about</span> <span class="n">tables</span>
<span class="n">db2</span> <span class="s">&quot;select &#39;db2look -d testdb -t &#39;|| rtrim(TABSCHEMA) ||&#39;.&#39;||&#39;</span><span class="se">\&quot;</span><span class="s">&#39;||TABNAME||&#39;</span><span class="se">\&quot;</span><span class="s">&#39;|| &#39; -e&#39; from syscat.tables where TBSPACEID=&#39;2&#39;&quot;</span> <span class="o">&gt;</span> <span class="n">db2look</span><span class="p">.</span><span class="n">sql</span>
<span class="p">.</span><span class="o">/</span><span class="n">db2look</span><span class="p">.</span><span class="n">sql</span> <span class="o">&gt;</span><span class="n">o</span><span class="p">.</span><span class="n">txt</span>
<span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="err">&#39;</span><span class="o">/^</span><span class="n">COMMIT</span><span class="err">\</span> <span class="n">WORK</span><span class="o">/</span><span class="n">d</span><span class="err">&#39;</span> <span class="n">o</span><span class="p">.</span><span class="n">txt</span>
<span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="err">&#39;</span><span class="o">/^</span><span class="n">CONNECT</span><span class="err">\</span> <span class="n">RESET</span><span class="o">/</span><span class="n">d</span><span class="err">&#39;</span> <span class="n">o</span><span class="p">.</span><span class="n">txt</span>
<span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="err">&#39;</span><span class="o">/^</span><span class="n">TERMINATE</span><span class="o">/</span><span class="n">d</span><span class="err">&#39;</span> <span class="n">o</span><span class="p">.</span><span class="n">txt</span>
</pre></div>


<h2 id="truncate-a-table-in-db2">truncate a table in DB2</h2>
<div class="hlcode"><pre><span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="n">sqllib</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="s">&quot;select * from t&quot;</span>

<span class="n">ID</span>          <span class="n">NAME</span>                 <span class="n">LOCATION</span>
<span class="o">-----------</span> <span class="o">--------------------</span> <span class="o">----------</span>
      <span class="mi">51369</span> <span class="n">Fung</span>                 <span class="o">-</span>
      <span class="mi">51368</span> <span class="n">Kong</span>                 <span class="n">Shenzhen</span>
      <span class="mi">51370</span> <span class="n">Kyun</span>                 <span class="n">CQ</span>
<span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">touch</span> <span class="n">null</span><span class="p">.</span><span class="n">dat</span>
<span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="s">&quot;import from null.dat of del replace into T&quot;</span>
<span class="n">SQL3109N</span>  <span class="n">The</span> <span class="n">utility</span> <span class="n">is</span> <span class="n">beginning</span> <span class="n">to</span> <span class="n">load</span> <span class="n">data</span> <span class="n">from</span> <span class="n">file</span> <span class="s">&quot;null.dat&quot;</span><span class="p">.</span>

<span class="n">SQL3110N</span>  <span class="n">The</span> <span class="n">utility</span> <span class="n">has</span> <span class="n">completed</span> <span class="n">processing</span><span class="p">.</span>  <span class="s">&quot;0&quot;</span> <span class="n">rows</span> <span class="n">were</span> <span class="n">read</span> <span class="n">from</span> <span class="n">the</span>
<span class="n">input</span> <span class="n">file</span><span class="p">.</span>

<span class="n">SQL3221W</span>  <span class="p">...</span><span class="n">Begin</span> <span class="n">COMMIT</span> <span class="n">WORK</span><span class="p">.</span> <span class="n">Input</span> <span class="n">Record</span> <span class="n">Count</span> <span class="o">=</span> <span class="s">&quot;0&quot;</span><span class="p">.</span>

<span class="n">SQL3222W</span>  <span class="p">...</span><span class="n">COMMIT</span> <span class="n">of</span> <span class="n">any</span> <span class="n">database</span> <span class="n">changes</span> <span class="n">was</span> <span class="n">successful</span><span class="p">.</span>

<span class="n">SQL3149N</span>  <span class="s">&quot;0&quot;</span> <span class="n">rows</span> <span class="n">were</span> <span class="n">processed</span> <span class="n">from</span> <span class="n">the</span> <span class="n">input</span> <span class="n">file</span><span class="p">.</span>  <span class="s">&quot;0&quot;</span> <span class="n">rows</span> <span class="n">were</span>
<span class="n">successfully</span> <span class="n">inserted</span> <span class="n">into</span> <span class="n">the</span> <span class="n">table</span><span class="p">.</span>  <span class="s">&quot;0&quot;</span> <span class="n">rows</span> <span class="n">were</span> <span class="n">rejected</span><span class="p">.</span>


<span class="n">Number</span> <span class="n">of</span> <span class="n">rows</span> <span class="n">read</span>         <span class="o">=</span> <span class="mi">0</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">rows</span> <span class="n">skipped</span>      <span class="o">=</span> <span class="mi">0</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">rows</span> <span class="n">inserted</span>     <span class="o">=</span> <span class="mi">0</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">rows</span> <span class="n">updated</span>      <span class="o">=</span> <span class="mi">0</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">rows</span> <span class="n">rejected</span>     <span class="o">=</span> <span class="mi">0</span>
<span class="n">Number</span> <span class="n">of</span> <span class="n">rows</span> <span class="n">committed</span>    <span class="o">=</span> <span class="mi">0</span>

<span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="s">&quot;select * from t&quot;</span>

<span class="n">ID</span>          <span class="n">NAME</span>                 <span class="n">LOCATION</span>
<span class="o">-----------</span> <span class="o">--------------------</span> <span class="o">----------</span>

  <span class="mi">0</span> <span class="n">record</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">selected</span><span class="p">.</span>
</pre></div>


<h2 id="db2-authorizations">DB2 authorizations</h2>
<div class="hlcode"><pre><span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="n">get</span> <span class="n">AUTHORIZATIONS</span>

 <span class="n">Administrative</span> <span class="n">Authorizations</span> <span class="k">for</span> <span class="n">Current</span> <span class="n">User</span>

 <span class="n">Direct</span> <span class="n">SYSADM</span> <span class="n">authority</span>                    <span class="o">=</span> <span class="n">NO</span>
 <span class="n">Direct</span> <span class="n">SYSCTRL</span> <span class="n">authority</span>                   <span class="o">=</span> <span class="n">NO</span>
 <span class="n">Direct</span> <span class="n">SYSMAINT</span> <span class="n">authority</span>                  <span class="o">=</span> <span class="n">NO</span>
 <span class="n">Direct</span> <span class="n">DBADM</span> <span class="n">authority</span>                     <span class="o">=</span> <span class="n">YES</span>
 <span class="n">Direct</span> <span class="n">CREATETAB</span> <span class="n">authority</span>                 <span class="o">=</span> <span class="n">NO</span>
 <span class="n">Direct</span> <span class="n">BINDADD</span> <span class="n">authority</span>                   <span class="o">=</span> <span class="n">NO</span>
 <span class="n">Direct</span> <span class="n">CONNECT</span> <span class="n">authority</span>                   <span class="o">=</span> <span class="n">NO</span>
 <span class="n">Direct</span> <span class="n">CREATE_NOT_FENC</span> <span class="n">authority</span>           <span class="o">=</span> <span class="n">NO</span>
 <span class="n">Direct</span> <span class="n">IMPLICIT_SCHEMA</span> <span class="n">authority</span>           <span class="o">=</span> <span class="n">NO</span>
 <span class="n">Direct</span> <span class="n">LOAD</span> <span class="n">authority</span>                      <span class="o">=</span> <span class="n">NO</span>
 <span class="n">Direct</span> <span class="n">QUIESCE_CONNECT</span> <span class="n">authority</span>           <span class="o">=</span> <span class="n">NO</span>
 <span class="n">Direct</span> <span class="n">CREATE_EXTERNAL_ROUTINE</span> <span class="n">authority</span>   <span class="o">=</span> <span class="n">NO</span>
 <span class="n">Direct</span> <span class="n">SYSMON</span> <span class="n">authority</span>                    <span class="o">=</span> <span class="n">NO</span>

 <span class="n">Indirect</span> <span class="n">SYSADM</span> <span class="n">authority</span>                  <span class="o">=</span> <span class="n">YES</span>
 <span class="n">Indirect</span> <span class="n">SYSCTRL</span> <span class="n">authority</span>                 <span class="o">=</span> <span class="n">NO</span>
 <span class="n">Indirect</span> <span class="n">SYSMAINT</span> <span class="n">authority</span>                <span class="o">=</span> <span class="n">NO</span>
 <span class="n">Indirect</span> <span class="n">DBADM</span> <span class="n">authority</span>                   <span class="o">=</span> <span class="n">NO</span>
 <span class="n">Indirect</span> <span class="n">CREATETAB</span> <span class="n">authority</span>               <span class="o">=</span> <span class="n">YES</span>
 <span class="n">Indirect</span> <span class="n">BINDADD</span> <span class="n">authority</span>                 <span class="o">=</span> <span class="n">YES</span>
 <span class="n">Indirect</span> <span class="n">CONNECT</span> <span class="n">authority</span>                 <span class="o">=</span> <span class="n">YES</span>
 <span class="n">Indirect</span> <span class="n">CREATE_NOT_FENC</span> <span class="n">authority</span>         <span class="o">=</span> <span class="n">NO</span>
 <span class="n">Indirect</span> <span class="n">IMPLICIT_SCHEMA</span> <span class="n">authority</span>         <span class="o">=</span> <span class="n">YES</span>
 <span class="n">Indirect</span> <span class="n">LOAD</span> <span class="n">authority</span>                    <span class="o">=</span> <span class="n">NO</span>
 <span class="n">Indirect</span> <span class="n">QUIESCE_CONNECT</span> <span class="n">authority</span>         <span class="o">=</span> <span class="n">NO</span>
 <span class="n">Indirect</span> <span class="n">CREATE_EXTERNAL_ROUTINE</span> <span class="n">authority</span> <span class="o">=</span> <span class="n">NO</span>
 <span class="n">Indirect</span> <span class="n">SYSMON</span> <span class="n">authority</span>                  <span class="o">=</span> <span class="n">NO</span>
</pre></div>


<h2 id="client-connections-relative">Client Connections Relative</h2>
<p>1.Server端配置TCP/IP信息</p>
<div class="hlcode"><pre><span class="n">db2set</span> <span class="n">db2comm</span><span class="o">=</span><span class="n">tcpip</span>
<span class="n">db2</span> <span class="n">update</span> <span class="n">dbm</span> <span class="n">cfg</span> <span class="n">using</span> <span class="n">svcename</span> <span class="n">SERVICE_NAME</span><span class="o">/</span><span class="n">PORT_NUMBER</span><span class="p">(</span><span class="err">如果使用</span><span class="n">service_name</span><span class="err">，那么</span><span class="n">service</span> <span class="n">name</span><span class="err">要和</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">services</span><span class="err">里面的一致</span><span class="p">)</span>
</pre></div>


<p>设置完之后需重启实例使设置生效<br />
2.客户端配置</p>
<h2 id="catalog-node">catalog node</h2>
<div class="hlcode"><pre><span class="n">db2</span> <span class="n">catalog</span> <span class="n">tcpip</span> <span class="n">node</span> <span class="n">node_alias</span> <span class="n">remote</span> <span class="mf">192.168.122.144</span> <span class="n">server</span> <span class="mi">60000</span>
</pre></div>


<h2 id="catalog-db">catalog db</h2>
<div class="hlcode"><pre><span class="n">db2</span> <span class="n">catalog</span> <span class="n">database</span> <span class="n">db_name</span> <span class="n">as</span> <span class="n">db_alias</span> <span class="n">at</span> <span class="n">node</span> <span class="n">node_alias</span> <span class="p">[</span><span class="n">authentication</span> <span class="n">SERVER</span><span class="p">]</span>
</pre></div>


<p>3.客户端验证</p>
<div class="hlcode"><pre><span class="n">db2</span> <span class="n">list</span> <span class="n">node</span> <span class="n">directory</span>
<span class="n">db2</span> <span class="n">list</span> <span class="n">db</span> <span class="n">directory</span>
</pre></div>


<h2 id="login-using-client">login using client</h2>
<div class="hlcode"><pre><span class="n">db2</span> <span class="n">connect</span> <span class="n">to</span> <span class="n">db_alias</span> <span class="n">user</span> <span class="n">db2_inst_users_in_server</span>
</pre></div>


<h2 id="db2_1">DB2随机启动</h2>
<div class="hlcode"><pre><span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">db2iauto</span> <span class="o">-</span><span class="n">on</span> <span class="n">db2inst1</span>

<span class="cp">#Automatic maintenance configuration parameter</span>
<span class="mf">1.</span> <span class="n">AUTO_DB_BACKUP</span><span class="o">:</span> <span class="n">Default</span> <span class="n">set</span> <span class="n">to</span> <span class="n">OFF</span><span class="p">,</span>
<span class="mf">2.</span> <span class="n">AUTO_TBL_MAINT</span><span class="o">:</span> <span class="n">Default</span> <span class="n">set</span> <span class="n">to</span> <span class="n">ON</span><span class="p">,</span>
<span class="mf">3.</span> <span class="n">AUTO_RUNSTATS</span><span class="o">:</span> <span class="n">Default</span> <span class="n">set</span> <span class="n">to</span> <span class="n">ON</span><span class="p">,</span>
<span class="mf">4.</span> <span class="n">AUTO_STMT_STATS</span><span class="o">:</span> <span class="n">Default</span> <span class="n">set</span> <span class="n">to</span> <span class="n">ON</span><span class="p">,</span>
<span class="mf">5.</span> <span class="n">AUTO_STATS_VIEWS</span><span class="o">:</span> <span class="n">Default</span> <span class="n">set</span> <span class="n">to</span> <span class="n">OFF</span><span class="p">,</span>
<span class="mf">6.</span> <span class="n">AUTO_SAMPLING</span><span class="o">:</span> <span class="n">Default</span> <span class="n">set</span> <span class="n">to</span> <span class="n">OFF</span><span class="p">,</span>
<span class="mf">7.</span> <span class="n">AUTO_STATS_PROF</span><span class="o">:</span> <span class="n">Default</span> <span class="n">set</span> <span class="n">to</span> <span class="n">OFF</span><span class="p">,</span>
<span class="mf">8.</span> <span class="n">AUTO_PROF_UPD</span><span class="o">:</span> <span class="n">Default</span> <span class="n">set</span> <span class="n">to</span> <span class="n">OFF</span><span class="p">,</span>
<span class="mf">9.</span> <span class="n">AUTO_REORG</span><span class="o">:</span> <span class="n">Default</span> <span class="n">set</span> <span class="n">to</span> <span class="n">ON</span><span class="p">,</span>
<span class="mf">10.</span> <span class="n">AUTO_REVAL</span><span class="o">:</span> <span class="n">Default</span> <span class="n">set</span> <span class="n">to</span> <span class="n">DEFERRED</span><span class="p">,</span>
</pre></div>


<h2 id="db2_2">DB2日志状态</h2>
<p>DB2日志有三种状态<br />
1. active<br />
Active状态的日志，即此日志包含了已提交但尚未写入磁盘的数据、未提交但已写入磁盘的数据；尚未提交或者rollback的数据。总而言之，就是在crash recovery需要用到日志均为active日志。<br />
2.online archive log<br />
Online archive log在crash recovery时已经不需要使用到了，说它是online，仅仅是因为这些日志文件还在LOG_DIR中<br />
3.offline archive log<br />
已经归档到其他地方，如TSM中</p>
<p>--Infinite Active Logging<br />
条件：<br />
1.LOGARCHMETH1参数必须设置为USEREXIT, DISK, TSM, or VENDOR<br />
2.LOGSECOND参数设置为-1<br />
作用：<br />
在归档模式下，日志写满即归档，如果不是infinite archive的配置，则需要等待被归档完的日志状态变成inactive才会rename他们，如果事务比较大，在secondary log分配完后仍旧没有日志inactive，或者磁盘空间慢，数据库此时会hang住，无法写入日志，同时无法写日志的事务会进行回滚。但如果是处于infinite archive logging模式下，则日志写满即归档后，不会等待日志状态inactive才rename日志，而需要用到此日志时候会立即rename，在这种情况下，大事务也不会因为上述的情况而导致无法写日志。但infinite archive log也存在不好的地方，当crash recovery的时候，有可能需要从归档路径还原日志，因此，处于此模式下的db恢复的时候时间会长很多。</p>
<h2 id="monitor-log-space-usage">Monitor log space usage:</h2>
<div class="hlcode"><pre><span class="n">select</span> <span class="kt">int</span><span class="p">(</span><span class="n">total_log_used</span><span class="o">/</span><span class="mi">1024</span><span class="o">/</span><span class="mi">1024</span><span class="p">)</span> <span class="n">as</span> <span class="s">&quot;Log Used (Meg)&quot;</span><span class="p">,</span>
       <span class="kt">int</span><span class="p">(</span><span class="n">total_log_available</span><span class="o">/</span><span class="mi">1024</span><span class="o">/</span><span class="mi">1024</span><span class="p">)</span> <span class="n">as</span> <span class="s">&quot;Log Space Free (Meg)&quot;</span><span class="p">,</span>
       <span class="kt">int</span><span class="p">((</span><span class="kt">float</span><span class="p">(</span><span class="n">total_log_used</span><span class="p">)</span><span class="o">/</span> <span class="kt">float</span><span class="p">(</span><span class="n">total_log_used</span> <span class="o">+</span> <span class="n">total_log_available</span><span class="p">))</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span> <span class="n">as</span> <span class="s">&quot;Pct Used&quot;</span><span class="p">,</span>
       <span class="kt">int</span><span class="p">(</span><span class="n">tot_log_used_top</span><span class="o">/</span><span class="mi">1024</span><span class="o">/</span><span class="mi">1024</span><span class="p">)</span> <span class="n">as</span> <span class="s">&quot;Max Log Used (Meg)&quot;</span><span class="p">,</span>
       <span class="kt">int</span><span class="p">(</span><span class="n">sec_log_used_top</span><span class="o">/</span><span class="mi">1024</span><span class="o">/</span><span class="mi">1024</span><span class="p">)</span> <span class="n">as</span> <span class="s">&quot;Max Sec. Used (Meg)&quot;</span><span class="p">,</span>
       <span class="kt">int</span><span class="p">(</span><span class="n">sec_logs_allocated</span><span class="p">)</span> <span class="n">as</span> <span class="s">&quot;Secondaries&quot;</span>
<span class="n">from</span> <span class="n">sysibmadm</span><span class="p">.</span><span class="n">snapdb</span><span class="p">;</span>
</pre></div>


<h2 id="find-fence-id-owner">Find fence ID owner</h2>
<div class="hlcode"><pre><span class="p">[</span><span class="n">db2v97i</span><span class="err">@</span><span class="n">db2srv</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">ls</span> <span class="o">-</span><span class="n">l</span> <span class="err">$</span><span class="n">HOME</span><span class="o">/</span><span class="n">sqllib</span><span class="o">/</span><span class="n">adm</span><span class="o">/</span><span class="p">.</span><span class="n">fenced</span>
<span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span><span class="n">r</span><span class="o">--</span> <span class="mi">1</span> <span class="n">db2fenc1</span> <span class="n">db2fadm1</span> <span class="mi">0</span> <span class="n">Oct</span> <span class="mi">14</span> <span class="mi">17</span><span class="o">:</span><span class="mi">44</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">db2v97i</span><span class="o">/</span><span class="n">sqllib</span><span class="o">/</span><span class="n">adm</span><span class="o">/</span><span class="p">.</span><span class="n">fenced</span>
</pre></div>


<h2 id="change-log-mode-to-archive-log">Change log mode to archive log</h2>
<div class="hlcode"><pre><span class="n">db2</span> <span class="n">update</span> <span class="n">db</span> <span class="n">cfg</span> <span class="k">for</span> <span class="n">testdb</span> <span class="n">using</span> <span class="n">LOGARCHMETH1</span> <span class="n">disk</span><span class="o">:/</span><span class="n">data2</span><span class="o">/</span><span class="n">arch</span>
<span class="n">db2</span> <span class="n">force</span> <span class="n">application</span> <span class="n">all</span>
<span class="n">db2</span> <span class="n">backup</span> <span class="n">db</span> <span class="n">testdb</span> <span class="n">to</span> <span class="o">/</span><span class="n">data2</span><span class="o">/</span><span class="n">backup</span><span class="o">/</span>
</pre></div>


<p>--修改完归档模式后，需要对数据库做一次offline全备</p>
<h2 id="archive-log-history">查找archive log history</h2>
<div class="hlcode"><pre><span class="n">db2</span> <span class="n">list</span> <span class="n">history</span> <span class="n">archive</span> <span class="n">log</span> <span class="n">all</span> <span class="k">for</span> <span class="n">db_name</span>
</pre></div>


<h2 id="_2">手动归档日志</h2>
<div class="hlcode"><pre><span class="n">db2</span> <span class="n">connect</span> <span class="n">reset</span>
<span class="n">db2</span> <span class="n">archive</span> <span class="n">log</span> <span class="k">for</span> <span class="n">database</span> <span class="n">db_name</span>
</pre></div>


<h2 id="_3">修改在线日志数目</h2>
<div class="hlcode"><pre><span class="n">db2</span> <span class="n">update</span> <span class="n">db</span> <span class="n">cfg</span> <span class="k">for</span> <span class="n">testdb</span> <span class="n">using</span> <span class="n">logprimary</span> <span class="mi">10</span>
</pre></div>


<h2 id="_4">查看数据库是否处于归档模式</h2>
<div class="hlcode"><pre><span class="n">db2</span> <span class="n">get</span> <span class="n">db</span> <span class="n">cfg</span> <span class="k">for</span> <span class="n">testdb</span><span class="o">|</span><span class="n">grep</span> <span class="o">-</span><span class="n">i</span> <span class="n">log</span>
<span class="err">结果中，如果以下两个值为</span><span class="n">YES</span><span class="err">和不为空，一般可以判断当前数据库为归档模式</span>
 <span class="n">User</span> <span class="n">exit</span> <span class="k">for</span> <span class="n">logging</span> <span class="n">status</span>                            <span class="o">=</span> <span class="n">YES</span>
 <span class="n">First</span> <span class="n">log</span> <span class="n">archive</span> <span class="n">method</span>                 <span class="p">(</span><span class="n">LOGARCHMETH1</span><span class="p">)</span> <span class="o">=</span> <span class="n">DISK</span><span class="o">:/</span><span class="n">data2</span><span class="o">/</span><span class="n">arch</span><span class="o">/</span>
</pre></div>


<h2 id="offline-backup">offline backup</h2>
<div class="hlcode"><pre><span class="n">db2</span> <span class="n">backup</span> <span class="n">db</span> <span class="n">db_name</span> <span class="n">to</span> <span class="n">backup_path</span>
</pre></div>


<h2 id="online-backup-plus-logs">online backup plus logs</h2>
<div class="hlcode"><pre><span class="n">db2</span> <span class="n">backup</span> <span class="n">db</span> <span class="n">db_name</span> <span class="n">online</span> <span class="n">to</span> <span class="n">backup_path</span> <span class="n">include</span> <span class="n">logs</span>            <span class="o">--</span> <span class="n">normal</span> <span class="n">backup</span>
<span class="n">db2</span> <span class="n">backup</span> <span class="n">db</span> <span class="n">db_name</span> <span class="n">online</span> <span class="n">incremental</span> <span class="n">to</span> <span class="n">backup_path</span> <span class="n">include</span> <span class="n">logs</span>        <span class="o">--</span> <span class="n">incremental</span> <span class="n">backup</span>
<span class="n">db2</span> <span class="n">backup</span> <span class="n">db</span> <span class="n">db_name</span> <span class="n">online</span> <span class="n">incremental</span> <span class="n">delta</span> <span class="n">to</span> <span class="n">bk_path</span> <span class="n">include</span> <span class="n">logs</span>      <span class="o">--</span> <span class="n">incremental</span> <span class="n">delta</span> <span class="n">backup</span>
<span class="o">--</span><span class="err">增量备份需要开启</span><span class="n">TRACKMOD</span><span class="err">，且在做第一次增量备份前需有一次开启</span><span class="n">tracemod</span><span class="err">后的全备为基础，具体可以查看</span><span class="n">IBM</span> <span class="n">Knowledge</span> <span class="n">center</span><span class="err">中</span><span class="n">trackmod</span><span class="err">的解析</span>
<span class="n">db2</span> <span class="n">update</span> <span class="n">db</span> <span class="n">cfg</span> <span class="k">for</span> <span class="n">db_name</span> <span class="n">using</span> <span class="n">trackmod</span> <span class="n">yes</span> <span class="n">immediate</span>
</pre></div>


<h2 id="looking-for-db-backup-progress">Looking for DB backup progress</h2>
<div class="hlcode"><pre><span class="n">db2</span> <span class="n">list</span> <span class="n">utilities</span> <span class="n">show</span> <span class="n">detail</span>
</pre></div>


<h2 id="_5">备份介质管理</h2>
<p>--list backup history</p>
<div class="hlcode"><pre><span class="nx">db2</span> <span class="nb">list</span> <span class="nx">history</span> <span class="nx">backup</span> <span class="kc">all</span> <span class="nb">for</span> <span class="nx">db_name</span>
<span class="nx">db2</span> <span class="nb">list</span> <span class="nx">history</span> <span class="nx">backup</span> <span class="nx">since</span> <span class="o">&lt;</span><span class="nx">YYYYMMDD</span><span class="o">&gt;</span> <span class="nb">for</span> <span class="o">&lt;</span><span class="nx">db_name</span><span class="o">&gt;</span> <span class="o">|</span><span class="nx">grep</span> <span class="na">-v</span> <span class="s2">&quot;  00&quot;</span>
</pre></div>


<p>--delete backup set</p>
<div class="hlcode"><pre><span class="n">db2</span> <span class="n">prune</span> <span class="n">history</span>
</pre></div>


<h2 id="naming-convention">Naming convention</h2>
<div class="hlcode"><pre><span class="n">TESTDB</span><span class="mf">.0</span><span class="p">.</span><span class="n">db2inst1</span><span class="p">.</span><span class="n">NODE0000</span><span class="p">.</span><span class="n">CATN0000</span><span class="mf">.20150806143318.001</span>
<span class="err">对于</span><span class="n">DB2</span><span class="err">备份文件，字段间以“</span><span class="p">.</span><span class="err">”分割，分别的含义如下：</span>
<span class="nl">TESTDB:</span>         <span class="err">数据库名称</span>
<span class="mi">0</span><span class="o">:</span>          <span class="err">备份类型，</span><span class="mi">0</span><span class="err">为全备，</span><span class="mi">3</span><span class="err">为表空间备份，</span><span class="mi">4</span><span class="err">为</span><span class="n">Load</span> <span class="n">COPY</span><span class="err">备份</span>
<span class="nl">NODE0000:</span>       <span class="err">分区节点名称，单分区环境中，固定为</span><span class="n">node0000</span>
<span class="nl">CATN0000:</span>       <span class="n">catalog</span><span class="err">节点名称，单分区环境中，固定为</span><span class="n">catn0000</span>
<span class="mi">20150806143318</span><span class="err">：</span> <span class="err">备份时间戳</span>
<span class="mo">001</span><span class="o">:</span>            <span class="err">备份</span><span class="n">sequence</span> <span class="n">number</span>
</pre></div>


<h2 id="db2ckbkp-metadata">db2ckbkp命令--检查介质完整性，显示备份文件的metadata信息</h2>
<div class="hlcode"><pre><span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="n">backup</span><span class="p">]</span><span class="err">$</span> <span class="n">db2ckbkp</span> <span class="o">-</span><span class="n">h</span> <span class="n">TESTDB</span><span class="mf">.0</span><span class="p">.</span><span class="n">db2inst1</span><span class="p">.</span><span class="n">NODE0000</span><span class="p">.</span><span class="n">CATN0000</span><span class="mf">.20150806143318.001</span>
<span class="o">=====================</span>
<span class="n">MEDIA</span> <span class="n">HEADER</span> <span class="n">REACHED</span><span class="o">:</span>
<span class="o">=====================</span>
    <span class="n">Server</span> <span class="n">Database</span> <span class="n">Name</span>           <span class="o">--</span> <span class="n">TESTDB</span>
    <span class="n">Server</span> <span class="n">Database</span> <span class="n">Alias</span>          <span class="o">--</span> <span class="n">TESTDB</span>
    <span class="n">Client</span> <span class="n">Database</span> <span class="n">Alias</span>          <span class="o">--</span> <span class="n">TESTDB</span>
    <span class="n">Timestamp</span>                      <span class="o">--</span> <span class="mi">20150806143318</span>
    <span class="n">Database</span> <span class="n">Partition</span> <span class="n">Number</span>      <span class="o">--</span> <span class="mi">0</span>
    <span class="n">Instance</span>                       <span class="o">--</span> <span class="n">db2inst1</span>
    <span class="n">Sequence</span> <span class="n">Number</span>                <span class="o">--</span> <span class="mi">1</span>
    <span class="n">Release</span> <span class="n">ID</span>                     <span class="o">--</span> <span class="n">D00</span>           <span class="o">--</span><span class="err">版本号，</span><span class="mi">900</span><span class="o">-</span><span class="n">v7</span><span class="p">,</span> <span class="n">A00</span><span class="o">-</span><span class="n">v8</span><span class="p">,</span> <span class="n">B00</span><span class="o">-</span><span class="n">v9</span><span class="mf">.1</span> <span class="n">C00</span><span class="o">-</span><span class="n">v9</span><span class="mf">.5</span> <span class="n">D00</span><span class="o">-</span><span class="n">v9</span><span class="mf">.7</span><span class="p">,</span> <span class="n">F00</span><span class="o">-</span><span class="n">v10</span><span class="mf">.1</span>
    <span class="n">Database</span> <span class="n">Seed</span>                  <span class="o">--</span> <span class="n">CCD849F4</span>
    <span class="n">DB</span> <span class="n">Comment</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">Codepage</span> <span class="p">(</span><span class="n">Volume</span><span class="p">)</span> <span class="o">--</span> <span class="mi">0</span>
    <span class="n">DB</span> <span class="n">Comment</span> <span class="p">(</span><span class="n">Volume</span><span class="p">)</span>            <span class="o">--</span>
    <span class="n">DB</span> <span class="n">Comment</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">Codepage</span> <span class="p">(</span><span class="n">System</span><span class="p">)</span> <span class="o">--</span> <span class="mi">0</span>
    <span class="n">DB</span> <span class="n">Comment</span> <span class="p">(</span><span class="n">System</span><span class="p">)</span>            <span class="o">--</span>
    <span class="n">Authentication</span> <span class="n">Value</span>           <span class="o">--</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">Backup</span> <span class="n">Mode</span>                    <span class="o">--</span> <span class="mi">1</span>             <span class="o">--</span><span class="mi">0</span><span class="o">-</span><span class="n">offline</span> <span class="n">backup</span>  <span class="mi">1</span><span class="o">-</span><span class="n">online</span> <span class="n">backup</span>
    <span class="n">Includes</span> <span class="n">Logs</span>                  <span class="o">--</span> <span class="mi">1</span>           <span class="o">--</span><span class="mi">0</span><span class="o">-</span><span class="n">no</span>            <span class="mi">1</span><span class="o">-</span><span class="n">yes</span>
    <span class="n">Compression</span>                    <span class="o">--</span> <span class="mi">0</span>
    <span class="n">Backup</span> <span class="n">Type</span>                    <span class="o">--</span> <span class="mi">0</span>         <span class="o">--</span><span class="mi">0</span><span class="o">-</span><span class="n">full</span> <span class="n">backup</span>     <span class="mi">1</span><span class="o">-</span><span class="n">tablesapce</span>
    <span class="n">Backup</span> <span class="n">Gran</span><span class="p">.</span>                   <span class="o">--</span> <span class="mi">0</span>         <span class="o">--</span><span class="mi">0</span><span class="o">-</span><span class="n">normal</span> <span class="n">backup</span>   <span class="mi">16</span><span class="o">-</span><span class="n">incremental</span>      <span class="mi">48</span><span class="o">-</span><span class="n">delta</span>
    <span class="n">Merged</span> <span class="n">Backup</span> <span class="n">Image</span>            <span class="o">--</span> <span class="mi">0</span>
    <span class="n">Status</span> <span class="n">Flags</span>                   <span class="o">--</span> <span class="mi">21</span>
    <span class="n">System</span> <span class="n">Cats</span> <span class="n">inc</span>                <span class="o">--</span> <span class="mi">1</span>
    <span class="n">Catalog</span> <span class="n">Partition</span> <span class="n">Number</span>       <span class="o">--</span> <span class="mi">0</span>
    <span class="n">DB</span> <span class="n">Codeset</span>                     <span class="o">--</span> <span class="n">UTF</span><span class="o">-</span><span class="mi">8</span>
    <span class="n">DB</span> <span class="n">Territory</span>                   <span class="o">--</span>
    <span class="n">LogID</span>                          <span class="o">--</span> <span class="mi">1438758002</span>
    <span class="n">LogPath</span>                        <span class="o">--</span> <span class="o">/</span><span class="n">data1</span><span class="o">/</span><span class="n">db2inst1</span><span class="o">/</span><span class="n">NODE0000</span><span class="o">/</span><span class="n">SQL00001</span><span class="o">/</span><span class="n">SQLOGDIR</span><span class="o">/</span>
    <span class="n">Backup</span> <span class="n">Buffer</span> <span class="n">Size</span>             <span class="o">--</span> <span class="mi">3280896</span>
    <span class="n">Number</span> <span class="n">of</span> <span class="n">Sessions</span>             <span class="o">--</span> <span class="mi">1</span>
    <span class="n">Platform</span>                       <span class="o">--</span> <span class="mi">1</span><span class="n">E</span>
 <span class="n">The</span> <span class="n">proper</span> <span class="n">image</span> <span class="n">file</span> <span class="n">name</span> <span class="n">would</span> <span class="n">be</span><span class="o">:</span>
<span class="n">TESTDB</span><span class="mf">.0</span><span class="p">.</span><span class="n">db2inst1</span><span class="p">.</span><span class="n">NODE0000</span><span class="p">.</span><span class="n">CATN0000</span><span class="mf">.20150806143318.001</span>
<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="n">Buffers</span> <span class="n">processed</span><span class="o">:</span>  <span class="err">#################################</span>
<span class="n">Image</span> <span class="n">Verification</span> <span class="n">Complete</span> <span class="o">-</span> <span class="n">successful</span><span class="p">.</span>
</pre></div>


<h2 id="-">检测前滚所需日志--增量恢复检查</h2>
<div class="hlcode"><pre><span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="n">backup</span><span class="p">]</span><span class="err">$</span> <span class="n">db2ckbkp</span> <span class="o">-</span><span class="n">a</span> <span class="n">TESTDB</span><span class="mf">.0</span><span class="p">.</span><span class="n">db2inst1</span><span class="p">.</span><span class="n">NODE0000</span><span class="p">.</span><span class="n">CATN0000</span><span class="mf">.20150806143318.001</span> <span class="o">|</span><span class="n">grep</span> <span class="o">-</span><span class="n">i</span> <span class="s">&quot;File Number&quot;</span>
                      <span class="n">File</span> <span class="n">Number</span>   <span class="p">[</span><span class="mo">000</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
                      <span class="n">File</span> <span class="n">Number</span>   <span class="p">[</span><span class="mo">001</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
                      <span class="n">File</span> <span class="n">Number</span>   <span class="p">[</span><span class="mo">002</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
                      <span class="n">File</span> <span class="n">Number</span>   <span class="p">[</span><span class="mo">003</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>
                      <span class="n">File</span> <span class="n">Number</span>   <span class="p">[</span><span class="mo">004</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span>
                      <span class="n">File</span> <span class="n">Number</span>   <span class="p">[</span><span class="mo">005</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span>
                      <span class="n">File</span> <span class="n">Number</span>   <span class="p">[</span><span class="mo">006</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span>
                      <span class="n">File</span> <span class="n">Number</span>   <span class="p">[</span><span class="mo">007</span><span class="p">]</span> <span class="o">=</span> <span class="mi">9</span>
                      <span class="n">File</span> <span class="n">Number</span>   <span class="p">[</span><span class="mo">00</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
                      <span class="n">File</span> <span class="n">Number</span>   <span class="p">[</span><span class="mo">00</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="mi">11</span>
</pre></div>


<h2 id="incremental-restore">incremental restore</h2>
<p>--finding whick backup image needed when restore from an incremental backup</p>
<div class="hlcode"><pre><span class="p">[</span><span class="n">db2v97i</span><span class="err">@</span><span class="n">db2srv</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="n">backup</span> <span class="n">db</span> <span class="n">mysample</span> <span class="n">online</span> <span class="n">incremental</span> <span class="n">to</span> <span class="o">/</span><span class="n">db2</span><span class="o">/</span><span class="n">backup</span><span class="o">/</span><span class="n">db2v97i</span><span class="o">/</span><span class="n">mysample</span><span class="o">/</span>

<span class="n">Backup</span> <span class="n">successful</span><span class="p">.</span> <span class="n">The</span> <span class="n">timestamp</span> <span class="k">for</span> <span class="n">this</span> <span class="n">backup</span> <span class="n">image</span> <span class="n">is</span> <span class="o">:</span> <span class="mi">20160302165459</span>

<span class="p">[</span><span class="n">db2v97i</span><span class="err">@</span><span class="n">db2srv</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">db2ckrst</span> <span class="o">-</span><span class="n">d</span> <span class="n">mysample</span> <span class="o">-</span><span class="n">t</span> <span class="mi">20160302165459</span>

<span class="n">Suggested</span> <span class="n">restore</span> <span class="n">order</span> <span class="n">of</span> <span class="n">images</span> <span class="n">using</span> <span class="n">timestamp</span> <span class="mi">20160302165459</span> <span class="k">for</span>
<span class="n">database</span> <span class="n">mysample</span><span class="p">.</span>
<span class="o">====================================================================</span>
 <span class="n">restore</span> <span class="n">db</span> <span class="n">mysample</span> <span class="n">incremental</span> <span class="n">taken</span> <span class="n">at</span> <span class="mi">20160302165459</span>
 <span class="n">restore</span> <span class="n">db</span> <span class="n">mysample</span> <span class="n">incremental</span> <span class="n">taken</span> <span class="n">at</span> <span class="mi">20160225201758</span>
 <span class="n">restore</span> <span class="n">db</span> <span class="n">mysample</span> <span class="n">incremental</span> <span class="n">taken</span> <span class="n">at</span> <span class="mi">20160302165459</span>
<span class="o">--</span><span class="n">restore</span> <span class="n">incremental</span> <span class="n">backup</span> <span class="n">image</span>
<span class="n">db2</span> <span class="n">restore</span> <span class="n">db</span> <span class="n">mysample</span> <span class="n">incremental</span> <span class="n">taken</span> <span class="n">at</span> <span class="mi">20160302165459</span>
<span class="n">db2</span>  <span class="n">restore</span> <span class="n">db</span> <span class="n">mysample</span> <span class="n">incremental</span> <span class="n">taken</span> <span class="n">at</span> <span class="mi">20160225201758</span>
<span class="n">db2</span> <span class="n">restore</span> <span class="n">db</span> <span class="n">mysample</span> <span class="n">incremental</span> <span class="n">taken</span> <span class="n">at</span> <span class="mi">20160302165459</span>
<span class="o">--</span><span class="n">automatic</span> <span class="n">restore</span> <span class="n">incremental</span> <span class="n">backup</span>
<span class="n">db2</span> <span class="n">restore</span> <span class="n">db</span> <span class="n">mysample</span> <span class="n">incremental</span> <span class="n">automatic</span> <span class="n">taken</span> <span class="n">at</span> <span class="mi">20160302165459</span>
</pre></div>


<h2 id="recovery">Recovery</h2>
<p>DB2支持三种模式恢复：<br />
1.Crash Recover:    类似oracle的Crash recover，有个db cfg的AUTORESTART参数可以让crash recover在重新启动的时候自动运行，一般此参数设置为YES<br />
2.Version Recover：  类似oracle的restore，如果从online backup中restore，则有可能需要roll forward<br />
3.Rollforward：      类似oracle的recover，需要注意的是，roll forward有两个选项，end of backup和end of log，如果是backup，则恢复到backup时间段，如果是log，则恢复到log的时间段<br />
同时，DB2提供db2ckrst工具，该工具能提供恢复增量恢复的顺序，如下（建议直接使用incremental automatic进行恢复）</p>
<div class="hlcode"><pre><span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="n">backup</span><span class="p">]</span><span class="err">$</span> <span class="n">db2ckrst</span> <span class="o">-</span><span class="n">d</span> <span class="n">testdb</span> <span class="o">-</span><span class="n">t</span> <span class="mi">20150807105110</span> <span class="o">-</span><span class="n">r</span> <span class="n">database</span>
<span class="n">Suggested</span> <span class="n">restore</span> <span class="n">order</span> <span class="n">of</span> <span class="n">images</span> <span class="n">using</span> <span class="n">timestamp</span> <span class="mi">20150807105110</span> <span class="k">for</span>
<span class="n">database</span> <span class="n">testdb</span><span class="p">.</span>
<span class="o">====================================================================</span>
 <span class="n">restore</span> <span class="n">db</span> <span class="n">testdb</span> <span class="n">incremental</span> <span class="n">taken</span> <span class="n">at</span> <span class="mi">20150807105110</span>
 <span class="n">restore</span> <span class="n">db</span> <span class="n">testdb</span> <span class="n">incremental</span> <span class="n">taken</span> <span class="n">at</span> <span class="mi">20150807101213</span>
 <span class="n">restore</span> <span class="n">db</span> <span class="n">testdb</span> <span class="n">incremental</span> <span class="n">taken</span> <span class="n">at</span> <span class="mi">20150807104804</span>
 <span class="n">restore</span> <span class="n">db</span> <span class="n">testdb</span> <span class="n">incremental</span> <span class="n">taken</span> <span class="n">at</span> <span class="mi">20150807105110</span>
<span class="o">====================================================================</span>
</pre></div>


<h2 id="restore-recovery-examples">Restore &amp; Recovery Examples</h2>
<p>1.end of backup 和 end of log的区别（完全恢复）</p>
<div class="hlcode"><pre><span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="n">backup</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="n">backup</span> <span class="n">db</span> <span class="n">testdb</span> <span class="n">online</span> <span class="n">to</span> <span class="o">/</span><span class="n">data2</span><span class="o">/</span><span class="n">backup</span><span class="o">/</span> <span class="n">include</span> <span class="n">logs</span>
<span class="n">Backup</span> <span class="n">successful</span><span class="p">.</span> <span class="n">The</span> <span class="n">timestamp</span> <span class="k">for</span> <span class="n">this</span> <span class="n">backup</span> <span class="n">image</span> <span class="n">is</span> <span class="o">:</span> <span class="mi">20150807101213</span>
<span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="n">backup</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="n">connect</span> <span class="n">to</span> <span class="n">testdb</span>
   <span class="n">Database</span> <span class="n">Connection</span> <span class="n">Information</span>
 <span class="n">Database</span> <span class="n">server</span>        <span class="o">=</span> <span class="n">DB2</span><span class="o">/</span><span class="n">LINUXX8664</span> <span class="mf">9.7.10</span>
 <span class="n">SQL</span> <span class="n">authorization</span> <span class="n">ID</span>   <span class="o">=</span> <span class="n">DB2INST1</span>
 <span class="n">Local</span> <span class="n">database</span> <span class="n">alias</span>   <span class="o">=</span> <span class="n">TESTDB</span>
<span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="n">backup</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="n">list</span> <span class="n">tables</span>
<span class="n">Table</span><span class="o">/</span><span class="n">View</span>                      <span class="n">Schema</span>          <span class="n">Type</span>  <span class="n">Creation</span> <span class="n">time</span>
<span class="o">-------------------------------</span> <span class="o">---------------</span> <span class="o">-----</span> <span class="o">--------------------------</span>
  <span class="mi">0</span> <span class="n">record</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">selected</span><span class="p">.</span>
</pre></div>


<p>在备份前是没有用户表的，创建一张表，然后进行restore</p>
<div class="hlcode"><pre><span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="n">backup</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="s">&quot;create table t(id int,name varchar(20)) in fung&quot;</span>
<span class="n">DB20000I</span>  <span class="n">The</span> <span class="n">SQL</span> <span class="n">command</span> <span class="n">completed</span> <span class="n">successfully</span><span class="p">.</span>
<span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="n">backup</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="n">list</span> <span class="n">tables</span>
<span class="n">Table</span><span class="o">/</span><span class="n">View</span>                      <span class="n">Schema</span>          <span class="n">Type</span>  <span class="n">Creation</span> <span class="n">time</span>
<span class="o">-------------------------------</span> <span class="o">---------------</span> <span class="o">-----</span> <span class="o">--------------------------</span>
<span class="n">T</span>                               <span class="n">DB2INST1</span>        <span class="n">T</span>     <span class="mi">2015</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mo">07</span><span class="o">-</span><span class="mf">10.19.22.891815</span>
</pre></div>


<h3 id="end-of-logroll-forward">以end of log进行roll forward</h3>
<div class="hlcode"><pre><span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="n">backup</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="n">restore</span> <span class="n">db</span> <span class="n">testdb</span> <span class="n">from</span> <span class="o">/</span><span class="n">data2</span><span class="o">/</span><span class="n">backup</span> <span class="n">taken</span> <span class="n">at</span> <span class="mi">20150807101213</span>
<span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="n">backup</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="n">rollforward</span> <span class="n">db</span> <span class="n">testdb</span> <span class="n">to</span> <span class="n">end</span> <span class="n">of</span> <span class="n">logs</span> <span class="n">and</span> <span class="n">stop</span>
<span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="n">backup</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="n">connect</span> <span class="n">to</span> <span class="n">testdb</span>
<span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="n">backup</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="n">list</span> <span class="n">tables</span>
<span class="n">Table</span><span class="o">/</span><span class="n">View</span>                      <span class="n">Schema</span>          <span class="n">Type</span>  <span class="n">Creation</span> <span class="n">time</span>
<span class="o">-------------------------------</span> <span class="o">---------------</span> <span class="o">-----</span> <span class="o">--------------------------</span>
<span class="n">T</span>                               <span class="n">DB2INST1</span>        <span class="n">T</span>     <span class="mi">2015</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mo">07</span><span class="o">-</span><span class="mf">10.19.22.891815</span>
</pre></div>


<h3 id="end-of-backuproll-forward">以end of backup进行roll forward</h3>
<div class="hlcode"><pre><span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="n">backup</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="n">restore</span> <span class="n">db</span> <span class="n">testdb</span> <span class="n">from</span> <span class="o">/</span><span class="n">data2</span><span class="o">/</span><span class="n">backup</span> <span class="n">taken</span> <span class="n">at</span> <span class="mi">20150807101213</span>
<span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="n">backup</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="n">rollforward</span> <span class="n">db</span> <span class="n">testdb</span> <span class="n">to</span> <span class="n">end</span> <span class="n">of</span> <span class="n">backup</span> <span class="n">and</span> <span class="n">stop</span>
<span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="n">backup</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="n">list</span> <span class="n">tables</span>
<span class="n">Table</span><span class="o">/</span><span class="n">View</span>                      <span class="n">Schema</span>          <span class="n">Type</span>  <span class="n">Creation</span> <span class="n">time</span>
<span class="o">-------------------------------</span> <span class="o">---------------</span> <span class="o">-----</span> <span class="o">--------------------------</span>
  <span class="mi">0</span> <span class="n">record</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">selected</span><span class="p">.</span>
</pre></div>


<p>2.增量备份及完全恢复</p>
<div class="hlcode"><pre><span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="n">backup</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="n">backup</span> <span class="n">db</span> <span class="n">testdb</span> <span class="n">online</span> <span class="n">incremental</span> <span class="n">to</span> <span class="o">/</span><span class="n">data2</span><span class="o">/</span><span class="n">backup</span><span class="o">/</span> <span class="n">include</span> <span class="n">logs</span>
<span class="n">Backup</span> <span class="n">successful</span><span class="p">.</span> <span class="n">The</span> <span class="n">timestamp</span> <span class="k">for</span> <span class="n">this</span> <span class="n">backup</span> <span class="n">image</span> <span class="n">is</span> <span class="o">:</span> <span class="mi">20150807104804</span>
<span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="n">backup</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="s">&quot;create table t(id int,name varchar(20))&quot;</span>
<span class="n">DB20000I</span>  <span class="n">The</span> <span class="n">SQL</span> <span class="n">command</span> <span class="n">completed</span> <span class="n">successfully</span><span class="p">.</span>
<span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="n">backup</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="s">&quot;insert into t values(&#39;51369&#39;,&#39;Fung&#39;)&quot;</span>
<span class="n">DB20000I</span>  <span class="n">The</span> <span class="n">SQL</span> <span class="n">command</span> <span class="n">completed</span> <span class="n">successfully</span><span class="p">.</span>
<span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="n">backup</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="n">commit</span>
<span class="n">DB20000I</span>  <span class="n">The</span> <span class="n">SQL</span> <span class="n">command</span> <span class="n">completed</span> <span class="n">successfully</span><span class="p">.</span>
<span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="n">backup</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="s">&quot;select * from t&quot;</span>
<span class="n">ID</span>          <span class="n">NAME</span>
<span class="o">-----------</span> <span class="o">--------------------</span>
      <span class="mi">51369</span> <span class="n">Fung</span>
  <span class="mi">1</span> <span class="n">record</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">selected</span><span class="p">.</span>
<span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="n">backup</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="n">backup</span> <span class="n">db</span> <span class="n">testdb</span> <span class="n">online</span> <span class="n">incremental</span> <span class="n">delta</span> <span class="n">to</span> <span class="o">/</span><span class="n">data2</span><span class="o">/</span><span class="n">backup</span><span class="o">/</span> <span class="n">include</span> <span class="n">logs</span>
<span class="n">Backup</span> <span class="n">successful</span><span class="p">.</span> <span class="n">The</span> <span class="n">timestamp</span> <span class="k">for</span> <span class="n">this</span> <span class="n">backup</span> <span class="n">image</span> <span class="n">is</span> <span class="o">:</span> <span class="mi">20150807105110</span>
<span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="n">backup</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="n">restore</span> <span class="n">db</span> <span class="n">testdb</span> <span class="n">incremental</span> <span class="n">automatic</span> <span class="n">from</span> <span class="o">/</span><span class="n">data2</span><span class="o">/</span><span class="n">backup</span><span class="o">/</span> <span class="n">taken</span> <span class="n">at</span> <span class="mi">20150807105110</span>
<span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="n">backup</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="n">rollforward</span> <span class="n">db</span> <span class="n">testdb</span> <span class="n">to</span> <span class="n">end</span> <span class="n">of</span> <span class="n">logs</span> <span class="n">and</span> <span class="n">stop</span>
<span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="n">backup</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="s">&quot;select * from t&quot;</span>
<span class="n">ID</span>          <span class="n">NAME</span>
<span class="o">-----------</span> <span class="o">--------------------</span>
      <span class="mi">51369</span> <span class="n">Fung</span>
</pre></div>


<p>restore incremental automatic表示自动恢复，即从db2ckrst中列出的items中自动恢复，如果没有automatic选项，则需要手动从list中一个个以incremental恢复。</p>
<p>3.不完全恢复</p>
<div class="hlcode"><pre><span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="n">backup</span><span class="p">]</span><span class="err">$</span> <span class="n">date</span>
<span class="n">Fri</span> <span class="n">Aug</span>  <span class="mi">7</span> <span class="mi">10</span><span class="o">:</span><span class="mi">59</span><span class="o">:</span><span class="mi">14</span> <span class="n">CST</span> <span class="mi">2015</span>
<span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="n">backup</span><span class="p">]</span><span class="err">$</span>
<span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="n">backup</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="s">&quot;delete from (select * from t where id=&#39;51369&#39;)&quot;</span>
<span class="n">DB20000I</span>  <span class="n">The</span> <span class="n">SQL</span> <span class="n">command</span> <span class="n">completed</span> <span class="n">successfully</span><span class="p">.</span>
<span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="n">backup</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="n">commit</span>
<span class="n">DB20000I</span>  <span class="n">The</span> <span class="n">SQL</span> <span class="n">command</span> <span class="n">completed</span> <span class="n">successfully</span><span class="p">.</span>
<span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="n">backup</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="n">restore</span> <span class="n">db</span> <span class="n">testdb</span> <span class="n">incremental</span> <span class="n">automatic</span> <span class="n">from</span> <span class="o">/</span><span class="n">data2</span><span class="o">/</span><span class="n">backup</span><span class="o">/</span> <span class="n">taken</span> <span class="n">at</span> <span class="mi">20150807105110</span>
<span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="n">backup</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="n">rollforward</span> <span class="n">db</span> <span class="n">testdb</span> <span class="n">to</span> <span class="mi">2015</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mf">07.10.57.41.00000</span> <span class="n">using</span> <span class="n">local</span> <span class="n">time</span>
<span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="n">backup</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="n">rollforward</span> <span class="n">db</span> <span class="n">testdb</span> <span class="n">stop</span>
<span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="n">backup</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="s">&quot;select * from t&quot;</span>
<span class="n">ID</span>          <span class="n">NAME</span>
<span class="o">-----------</span> <span class="o">--------------------</span>
      <span class="mi">51369</span> <span class="n">Fung</span>
</pre></div>


<p>4.表空间的恢复</p>
<div class="hlcode"><pre><span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="n">backup</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="s">&quot;restore db testdb tablespace ( FUNG) online from /data2/backup taken at 20150807101213&quot;</span>
</pre></div>


<p>--指定online表示其他用户可以连接，并且访问其他表空间</p>
<div class="hlcode"><pre><span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="n">backup</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="s">&quot;rollforward db testdb to end of logs tablespace (FUNG)&quot;</span>
</pre></div>


<p>5.日志的恢复<br />
对于include log的备份，可以指定在某个位置仅恢复日志文件，然后利用这些日志进行前滚</p>
<div class="hlcode"><pre><span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="n">backup</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="n">backup</span> <span class="n">db</span> <span class="n">testdb</span> <span class="n">online</span> <span class="n">to</span> <span class="o">/</span><span class="n">data2</span><span class="o">/</span><span class="n">backup</span> <span class="n">include</span> <span class="n">logs</span>
<span class="n">Backup</span> <span class="n">successful</span><span class="p">.</span> <span class="n">The</span> <span class="n">timestamp</span> <span class="k">for</span> <span class="n">this</span> <span class="n">backup</span> <span class="n">image</span> <span class="n">is</span> <span class="o">:</span> <span class="mi">20150807145504</span>
</pre></div>


<p>仅恢复日志：</p>
<div class="hlcode"><pre><span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="n">backup</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="n">restore</span> <span class="n">db</span> <span class="n">testdb</span> <span class="n">logs</span> <span class="n">from</span> <span class="o">/</span><span class="n">data2</span><span class="o">/</span><span class="n">backup</span><span class="o">/</span> <span class="n">taken</span> <span class="n">at</span> <span class="mi">20150807145504</span> <span class="n">logtarget</span> <span class="o">/</span><span class="n">data2</span><span class="o">/</span><span class="n">logs</span><span class="o">/</span>
<span class="n">DB20000I</span>  <span class="n">The</span> <span class="n">RESTORE</span> <span class="n">DATABASE</span> <span class="n">command</span> <span class="n">completed</span> <span class="n">successfully</span><span class="p">.</span>
<span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="n">backup</span><span class="p">]</span><span class="err">$</span> <span class="n">ll</span> <span class="o">/</span><span class="n">data2</span><span class="o">/</span><span class="n">logs</span><span class="o">/</span>
<span class="n">total</span> <span class="mi">12</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-------</span><span class="p">.</span> <span class="mi">1</span> <span class="n">db2inst1</span> <span class="n">db2iadm1</span> <span class="mi">12288</span> <span class="n">Aug</span>  <span class="mi">7</span> <span class="mi">15</span><span class="o">:</span><span class="mo">02</span> <span class="n">S0000022</span><span class="p">.</span><span class="n">LOG</span>
</pre></div>


<p>如果需要连数据库一起恢复，再通过日志进行rollforward，则不需要指定logs参数：</p>
<div class="hlcode"><pre><span class="n">db2</span> <span class="n">restore</span> <span class="n">db</span> <span class="n">testdb</span> <span class="n">from</span> <span class="o">/</span><span class="n">data2</span><span class="o">/</span><span class="n">backup</span><span class="o">/</span> <span class="n">taken</span> <span class="n">at</span> <span class="mi">20150807145504</span> <span class="n">logtarget</span> <span class="o">/</span><span class="n">data2</span><span class="o">/</span><span class="n">logs</span><span class="o">/</span>
<span class="n">db2</span> <span class="s">&quot;rollforward db testdb to end of logs and stop overflow log path (/data2/logs) &quot;</span>
</pre></div>


<p>6.异机恢复<br />
异机或者需要恢复到另一个目录，restore提供了三个选项：<br />
I.TO target_directory<br />
II.DBPATH ON target_directory<br />
III.ON path_list<br />
如果目标库不存在，restore的TO和DBPATH ON选项指定目标库的数据库目录，ON指定automatic storage路径，如果只有ON，则数据库目录放在ON指定的第一个目录。</p>
<p>7.redirect恢复<br />
Redirect指在restore过程中，重新定义表空间container，类似Oracle RMAN中的set new name。但对于使用了automatic storage管理的TBS不能用此选项。</p>
<div class="hlcode"><pre><span class="n">db2</span> <span class="n">restore</span> <span class="n">db</span> <span class="n">db_name</span> <span class="n">into</span> <span class="n">target_dbname</span> <span class="n">redirect</span>
</pre></div>


<p>接着修改container属性</p>
<div class="hlcode"><pre><span class="n">db2</span> <span class="s">&quot;set tablespace containers for 3 using (file &#39;/tbs/ts1/cont000&#39; 3000)&quot;</span>
<span class="n">db2</span> <span class="n">restore</span> <span class="n">db</span> <span class="n">db_name</span> <span class="k">continue</span>
</pre></div>


<p>对于多个表空间，DB2 V9提供了一个可以产生脚本的工具：redirect generate scripts，这个脚本可以帮助我们改善"set tablespace containers"的可操作性。</p>
<div class="hlcode"><pre><span class="n">db2</span> <span class="n">restore</span> <span class="n">db</span> <span class="n">db_name</span> <span class="n">redirect</span> <span class="n">generate</span> <span class="n">script</span> <span class="n">redirect</span><span class="p">.</span><span class="n">dll</span>
</pre></div>


<p>然后通过db2 -tvf redirect.dll进行重定向恢复</p>
<p>--example</p>
<h3 id="backup-in-the-source-db">backup in the source db</h3>
<div class="hlcode"><pre><span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="n">backup</span> <span class="n">db</span> <span class="n">testdb</span> <span class="n">online</span> <span class="n">to</span> <span class="o">/</span><span class="n">restore</span><span class="o">/</span>
<span class="n">Backup</span> <span class="n">successful</span><span class="p">.</span> <span class="n">The</span> <span class="n">timestamp</span> <span class="k">for</span> <span class="n">this</span> <span class="n">backup</span> <span class="n">image</span> <span class="n">is</span> <span class="o">:</span> <span class="mi">20160112175052</span>
<span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">chmod</span> <span class="mi">775</span> <span class="o">/</span><span class="n">restore</span><span class="o">/</span><span class="n">TESTDB</span><span class="mf">.0</span><span class="p">.</span><span class="n">db2inst1</span><span class="p">.</span><span class="n">NODE0000</span><span class="p">.</span><span class="n">CATN0000</span><span class="mf">.20160112175052.001</span>
</pre></div>


<h3 id="restore-tablespace-on-the-target-db">restore tablespace on the target db</h3>
<div class="hlcode"><pre><span class="p">[</span><span class="n">db2inst3</span><span class="err">@</span><span class="n">db2srv</span> <span class="n">restore</span><span class="p">]</span><span class="err">$</span> <span class="n">db2set</span> <span class="n">DB2_RESTORE_GRANT_ADMIN_AUTHORITIES</span><span class="o">=</span><span class="n">ON</span>
<span class="p">[</span><span class="n">db2inst3</span><span class="err">@</span><span class="n">db2srv</span> <span class="n">restore</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="s">&quot;restore db testdb  REBUILD WITH tablespace (FUNG,SYSCATSPACE) taken at  20160112175240 on /restore/datafile dbpath on /restore/datafile  into  tmpdb logtarget  /restore/actlog newlogpath /restore/actlog redirect generate script redirect.clp&quot;</span>
<span class="n">DB20000I</span>  <span class="n">The</span> <span class="n">RESTORE</span> <span class="n">DATABASE</span> <span class="n">command</span> <span class="n">completed</span> <span class="n">successfully</span><span class="p">.</span>
<span class="p">[</span><span class="n">db2inst3</span><span class="err">@</span><span class="n">db2srv</span> <span class="n">restore</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="o">-</span><span class="n">tvf</span> <span class="n">redirect</span><span class="p">.</span><span class="n">clp</span>
<span class="n">UPDATE</span> <span class="n">COMMAND</span> <span class="n">OPTIONS</span> <span class="n">USING</span> <span class="n">S</span> <span class="n">ON</span> <span class="n">Z</span> <span class="n">ON</span> <span class="n">TESTDB_NODE0000</span><span class="p">.</span><span class="n">out</span> <span class="n">V</span> <span class="n">ON</span>
<span class="n">DB20000I</span>  <span class="n">The</span> <span class="n">UPDATE</span> <span class="n">COMMAND</span> <span class="n">OPTIONS</span> <span class="n">command</span> <span class="n">completed</span> <span class="n">successfully</span><span class="p">.</span>

<span class="n">SET</span> <span class="n">CLIENT</span> <span class="n">ATTACH_DBPARTITIONNUM</span>  <span class="mi">0</span>
<span class="n">DB20000I</span>  <span class="n">The</span> <span class="n">SET</span> <span class="n">CLIENT</span> <span class="n">command</span> <span class="n">completed</span> <span class="n">successfully</span><span class="p">.</span>

<span class="n">SET</span> <span class="n">CLIENT</span> <span class="n">CONNECT_DBPARTITIONNUM</span> <span class="mi">0</span>
<span class="n">DB20000I</span>  <span class="n">The</span> <span class="n">SET</span> <span class="n">CLIENT</span> <span class="n">command</span> <span class="n">completed</span> <span class="n">successfully</span><span class="p">.</span>

<span class="n">RESTORE</span> <span class="n">DATABASE</span> <span class="n">TESTDB</span> <span class="n">REBUILD</span> <span class="n">WITH</span> <span class="n">TABLESPACE</span> <span class="p">(</span> <span class="n">SYSCATSPACE</span> <span class="p">,</span> <span class="n">TEMPSPACE1</span> <span class="p">,</span> <span class="n">FUNG</span> <span class="p">,</span> <span class="n">SYSTOOLSTMPSPACE</span> <span class="p">)</span> <span class="n">FROM</span> <span class="err">&#39;</span><span class="o">/</span><span class="n">restore</span><span class="err">&#39;</span> <span class="n">TAKEN</span> <span class="n">AT</span> <span class="mi">20160112175240</span> <span class="n">ON</span> <span class="err">&#39;</span><span class="o">/</span><span class="n">restore</span><span class="o">/</span><span class="n">datafile</span><span class="err">&#39;</span> <span class="n">DBPATH</span> <span class="n">ON</span> <span class="err">&#39;</span><span class="o">/</span><span class="n">restore</span><span class="o">/</span><span class="n">datafile</span><span class="err">&#39;</span> <span class="n">INTO</span> <span class="n">TMPDB</span> <span class="n">LOGTARGET</span> <span class="err">&#39;</span><span class="o">/</span><span class="n">restore</span><span class="o">/</span><span class="n">actlog</span><span class="o">/</span><span class="err">&#39;</span> <span class="n">NEWLOGPATH</span> <span class="err">&#39;</span><span class="o">/</span><span class="n">restore</span><span class="o">/</span><span class="n">actlog</span><span class="o">/</span><span class="err">&#39;</span> <span class="n">REDIRECT</span>
<span class="n">SQL1277W</span>  <span class="n">A</span> <span class="n">redirected</span> <span class="n">restore</span> <span class="n">operation</span> <span class="n">is</span> <span class="n">being</span> <span class="n">performed</span><span class="p">.</span>  <span class="n">Table</span> <span class="n">space</span>
<span class="n">configuration</span> <span class="n">can</span> <span class="n">now</span> <span class="n">be</span> <span class="n">viewed</span> <span class="n">and</span> <span class="n">table</span> <span class="n">spaces</span> <span class="n">that</span> <span class="k">do</span> <span class="n">not</span> <span class="n">use</span> <span class="n">automatic</span>
<span class="n">storage</span> <span class="n">can</span> <span class="n">have</span> <span class="n">their</span> <span class="n">containers</span> <span class="n">reconfigured</span><span class="p">.</span>
<span class="n">DB20000I</span>  <span class="n">The</span> <span class="n">RESTORE</span> <span class="n">DATABASE</span> <span class="n">command</span> <span class="n">completed</span> <span class="n">successfully</span><span class="p">.</span>

<span class="n">RESTORE</span> <span class="n">DATABASE</span> <span class="n">TESTDB</span> <span class="n">CONTINUE</span>
<span class="n">DB20000I</span>  <span class="n">The</span> <span class="n">RESTORE</span> <span class="n">DATABASE</span> <span class="n">command</span> <span class="n">completed</span> <span class="n">successfully</span><span class="p">.</span>

<span class="p">[</span><span class="n">db2inst3</span><span class="err">@</span><span class="n">db2srv</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="n">list</span> <span class="n">utilities</span> <span class="p">[</span><span class="n">show</span> <span class="n">detail</span><span class="p">]</span>

<span class="n">ID</span>                               <span class="o">=</span> <span class="mi">1</span>
<span class="n">Type</span>                             <span class="o">=</span> <span class="n">RESTORE</span>
<span class="n">Database</span> <span class="n">Name</span>                    <span class="o">=</span> <span class="n">TMPDB</span>
<span class="n">Partition</span> <span class="n">Number</span>                 <span class="o">=</span> <span class="mi">0</span>
<span class="n">Description</span>                      <span class="o">=</span> <span class="n">automatic</span> <span class="n">db</span> <span class="n">rebuild</span> <span class="n">SYSCATSPACE</span><span class="p">...</span>
<span class="n">Start</span> <span class="n">Time</span>                       <span class="o">=</span> <span class="mo">01</span><span class="o">/</span><span class="mi">13</span><span class="o">/</span><span class="mi">2016</span> <span class="mi">18</span><span class="o">:</span><span class="mo">02</span><span class="o">:</span><span class="mf">13.623404</span>
<span class="n">State</span>                            <span class="o">=</span> <span class="n">Executing</span>
<span class="n">Invocation</span> <span class="n">Type</span>                  <span class="o">=</span> <span class="n">User</span>

<span class="p">[</span><span class="n">db2inst3</span><span class="err">@</span><span class="n">db2srv</span> <span class="n">restore</span><span class="p">]</span><span class="err">$</span>  <span class="n">db2</span> <span class="n">rollforward</span> <span class="n">db</span> <span class="n">tmpdb</span> <span class="n">query</span> <span class="n">status</span>

                                 <span class="n">Rollforward</span> <span class="n">Status</span>

 <span class="n">Input</span> <span class="n">database</span> <span class="n">alias</span>                   <span class="o">=</span> <span class="n">tmpdb</span>
 <span class="n">Number</span> <span class="n">of</span> <span class="n">nodes</span> <span class="n">have</span> <span class="n">returned</span> <span class="n">status</span>   <span class="o">=</span> <span class="mi">1</span>

 <span class="n">Node</span> <span class="n">number</span>                            <span class="o">=</span> <span class="mi">0</span>
 <span class="n">Rollforward</span> <span class="n">status</span>                     <span class="o">=</span> <span class="n">DB</span>  <span class="n">pending</span>
 <span class="n">Next</span> <span class="n">log</span> <span class="n">file</span> <span class="n">to</span> <span class="n">be</span> <span class="n">read</span>               <span class="o">=</span> <span class="n">S0000008</span><span class="p">.</span><span class="n">LOG</span>
 <span class="n">Log</span> <span class="n">files</span> <span class="n">processed</span>                    <span class="o">=</span>  <span class="o">-</span>
 <span class="n">Last</span> <span class="n">committed</span> <span class="n">transaction</span>             <span class="o">=</span> <span class="mi">2016</span><span class="o">-</span><span class="mo">01</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mf">09.52.40.000000</span> <span class="n">UTC</span>


<span class="p">[</span><span class="n">db2inst3</span><span class="err">@</span><span class="n">db2srv</span> <span class="n">restore</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="n">rollforward</span> <span class="n">db</span> <span class="n">tmpdb</span> <span class="n">to</span> <span class="n">end</span> <span class="n">of</span> <span class="n">logs</span> <span class="n">and</span> <span class="n">stop</span>
<span class="n">SQL1271W</span>  <span class="n">Database</span> <span class="s">&quot;TMPDB&quot;</span> <span class="n">is</span> <span class="n">recovered</span> <span class="n">but</span> <span class="n">one</span> <span class="n">or</span> <span class="n">more</span> <span class="n">table</span> <span class="n">spaces</span> <span class="n">are</span> <span class="n">off</span><span class="o">-</span><span class="n">line</span> <span class="n">on</span> <span class="n">node</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="s">&quot;0&quot;</span><span class="p">.</span>
</pre></div>


<p>8.前滚恢复<br />
--前滚到某个时间点</p>
<div class="hlcode"><pre><span class="n">db2</span> <span class="s">&quot;select current timestamp from sysibm.sysdummy1&quot;</span>
<span class="n">db2</span> <span class="n">rollforward</span> <span class="n">db</span> <span class="n">testdb</span> <span class="n">to</span> <span class="mi">2015</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mf">09.24.55.858964</span> <span class="n">using</span> <span class="n">local</span> <span class="n">time</span>
</pre></div>


<p>--前滚到日志结尾</p>
<div class="hlcode"><pre><span class="n">db2</span> <span class="n">rollforward</span> <span class="n">db</span> <span class="n">testdb</span> <span class="n">to</span> <span class="n">end</span> <span class="n">of</span> <span class="n">logs</span> <span class="n">and</span> <span class="n">stop</span>
</pre></div>


<p>--前滚到备份结尾</p>
<div class="hlcode"><pre><span class="n">db2</span> <span class="n">rollforward</span> <span class="n">db</span> <span class="n">testdb</span> <span class="n">to</span> <span class="n">end</span> <span class="n">of</span> <span class="n">backup</span> <span class="n">and</span> <span class="n">stop</span>
</pre></div>


<ol>
<li>Recovering a dropped table<br />
1) finding the tablespace status whether enable "DROPPED TABLE RECOVERY"</li>
</ol>
<div class="hlcode"><pre>  <span class="n">db2</span> <span class="s">&quot;select substr(TBSPACE,1,20) as TBS,TBSPACETYPE,DROP_RECOVERY from SYSCAT.TABLESPACES&quot;</span>
</pre></div>


<p>2) finding the dropped tables</p>
<div class="hlcode"><pre>  <span class="n">db2</span> <span class="n">list</span> <span class="n">history</span> <span class="n">dropped</span> <span class="n">table</span> <span class="n">all</span> <span class="k">for</span> <span class="n">mysample</span>
</pre></div>


<p>3) restore a database-level or tablespace-level backup image taken before the table was dropped</p>
<div class="hlcode"><pre>  <span class="n">db2</span> <span class="s">&quot;restore db mysample tablespace (FUNG) online from /db2/backup/db2v97i/mysample/ taken at 20160218174445&quot;</span>
</pre></div>


<p>4) create a export directory to which files contaning the table data are to be written</p>
<div class="hlcode"><pre>  <span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">restore</span>
</pre></div>


<p>5) rollforward to a PIT</p>
<div class="hlcode"><pre>  <span class="n">db2</span> <span class="s">&quot;ROLLFORWARD DB mysample TO END OF LOGS TABLESPACE ONLINE RECOVER DROPPED TABLE 000000000000f35c00060004 TO /restore&quot;</span>
<span class="o">--</span><span class="n">db2</span> <span class="s">&quot;ROLLFORWARD DB db_name TO END OF LOGS TABLESPACE ONLINE RECOVER DROPPED TABLE dropped_table_id TO export_dir&quot;</span>
</pre></div>


<p>--dropped table ID can get from list history command<br />
6) re-create the dropped table (DDL can obtain from list history command )<br />
7) import the data from that was export during the roll forward operation into the table</p>
<div class="hlcode"><pre>  <span class="n">db2</span> <span class="s">&quot;IMPORT FROM /restore/NODE0000/data OF DEL INSERT INTO T&quot;</span>
  <span class="o">--</span><span class="n">db2</span> <span class="s">&quot;IMPORT FROM export_dir OF DEL INSERT INTO table&quot;</span>
</pre></div>


<h2 id="_6">运维工具</h2>
<p>1.runstats<br />
runstats为DB2收集统计信息的工具。它可以使用distribution参数收集数据分布，数据分布有两种，一种为Frequency(频率采样)，另一种为Quantile（百分比采样）<br />
--收集表及索引信息，包括数据分布</p>
<div class="hlcode"><pre><span class="n">db2</span> <span class="n">runstats</span> <span class="n">on</span> <span class="n">table</span> <span class="n">schema_name</span><span class="p">.</span><span class="n">table_name</span> <span class="n">on</span> <span class="n">all</span> <span class="n">columns</span> <span class="n">with</span> <span class="n">distribution</span> <span class="n">and</span> <span class="n">detailed</span> <span class="n">indexes</span> <span class="n">all</span>
</pre></div>


<p>--收集索引统计信息</p>
<div class="hlcode"><pre><span class="n">db2</span> <span class="n">runstats</span> <span class="n">on</span> <span class="n">table</span> <span class="n">schema_name</span><span class="p">.</span><span class="n">table_name</span> <span class="k">for</span> <span class="n">indexes</span> <span class="n">all</span>
</pre></div>


<p>--收集表和索引统计信息</p>
<div class="hlcode"><pre><span class="n">db2</span> <span class="n">runstats</span> <span class="n">on</span> <span class="n">table</span> <span class="n">schema_name</span><span class="p">.</span><span class="n">table_name</span> <span class="n">and</span> <span class="n">detailed</span> <span class="n">indexes</span> <span class="n">all</span>
</pre></div>


<p>--收集统计信息的同时，让该表可读写</p>
<div class="hlcode"><pre><span class="n">db2</span> <span class="n">runstats</span> <span class="n">on</span> <span class="n">table</span> <span class="n">db2user</span><span class="p">.</span><span class="n">employee</span> <span class="n">allow</span> <span class="n">write</span> <span class="n">access</span>
</pre></div>


<p>--收集表的统计信息，同时收集empid, empname的直方图信息，同时指定此表在runstats的时候只读</p>
<div class="hlcode"><pre><span class="n">db2</span> <span class="n">runstats</span> <span class="n">on</span> <span class="n">table</span> <span class="n">db2user</span><span class="p">.</span><span class="n">employee</span> <span class="n">with</span> <span class="n">distribution</span> <span class="n">on</span> <span class="n">columns</span> <span class="p">(</span> <span class="n">empid</span><span class="p">,</span> <span class="n">empname</span> <span class="p">)</span> <span class="n">allow</span> <span class="n">read</span> <span class="n">access</span>
</pre></div>


<p>--查看一张表是否有收集统计信息</p>
<div class="hlcode"><pre><span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="s">&quot;select char(tabname,10) as tabname, stats_time from syscat.tables where tabname=&#39;T&#39;&quot;</span>
<span class="n">TABNAME</span>    <span class="n">STATS_TIME</span>
<span class="o">----------</span> <span class="o">--------------------------</span>
<span class="n">T</span>          <span class="mi">2015</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mf">09.46.54.131244</span>

  <span class="mi">1</span> <span class="n">record</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">selected</span><span class="p">.</span>
</pre></div>


<p>--runstats脚本</p>
<table class="hlcodetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="hlcode"><pre><span class="c">#!/bin/bash</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$#&quot;</span> &lt; 3 <span class="o">]</span> ; <span class="k">then</span>
<span class="nb">echo</span> <span class="s2">&quot;USAGE:$0 DB_NAME DB_USER_NAME DB_PASSWORD&quot;</span>
<span class="nb">exit</span>
<span class="k">fi</span>
<span class="nv">DB</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">DB_USER</span><span class="o">=</span><span class="nv">$2</span>
<span class="nv">DB_PWD</span><span class="o">=</span><span class="nv">$3</span>
db2 connect to <span class="nv">$DB</span> user <span class="nv">$DB_USER</span> using <span class="nv">$DB_PWD</span>
db2 <span class="s2">&quot;select trim(&#39;RUNSTATS ON TABLE &#39; || trim(tabschema) || &#39;.&#39; || tabname || &#39; ON ALL COLUMNS WITH DISTRIBUTION ON ALL COLUMNS AND SAMPLED DETAILED INDEXES ALL ALLOW WRITE ACCESS;&#39;) from syscat.tables where type=&#39;T&#39;&quot;</span> &gt; createRunstats.txt
grep RUNSTATS createRunstats.txt &gt; runstats_detailed.sql
<span class="c">#db2 -tvf runstats_detailed.sql</span>
</pre></div>
</td></tr></table>

<h3 id="export-table-to-ixf">export table to ixf</h3>
<div class="hlcode"><pre><span class="n">db2</span> <span class="s">&quot;export to account_revocation.txt2 of ixf select * from wiusrapp.account_revocation&quot;</span>


<span class="n">SELECT</span> <span class="err">&#39;</span><span class="n">DB2</span> <span class="n">EXPORT</span> <span class="n">TO</span> <span class="err">&#39;</span> <span class="o">||</span> <span class="n">tabname</span> <span class="o">||</span><span class="err">&#39;</span><span class="p">.</span><span class="n">DEL</span> <span class="n">OF</span> <span class="n">DEL</span> <span class="n">MODIFIED</span> <span class="n">BY</span> <span class="n">COLDEL</span><span class="err">@</span> <span class="n">CODEPAGE</span><span class="o">=</span><span class="mi">1208</span> <span class="n">MESSAGES</span> <span class="err">&#39;</span> <span class="o">||</span> <span class="n">tabname</span> <span class="o">||</span> <span class="err">&#39;</span><span class="p">.</span><span class="n">expout</span> <span class="n">SELECT</span> <span class="o">*</span> <span class="n">FROM</span> <span class="err">&#39;</span> <span class="o">||</span> <span class="n">tabname</span> <span class="n">AS</span> <span class="n">Exports</span><span class="p">,</span> <span class="err">&#39;</span><span class="n">IMPORT</span> <span class="n">FROM</span> <span class="err">&#39;</span> <span class="o">||</span> <span class="n">tabname</span> <span class="o">||</span> <span class="err">&#39;</span><span class="p">.</span><span class="n">del</span> <span class="n">OF</span> <span class="n">DEL</span> <span class="n">MODIFIED</span> <span class="n">BY</span> <span class="n">CODEPAGE</span><span class="o">=</span><span class="mi">1208</span> <span class="n">COLDEL</span><span class="err">@</span> <span class="n">MESSAGES</span> <span class="err">&#39;</span> <span class="o">||</span> <span class="n">tabname</span> <span class="o">||</span> <span class="err">&#39;</span><span class="p">.</span><span class="n">impout</span> <span class="n">REPLACE</span> <span class="n">INTO</span> <span class="err">&#39;</span> <span class="o">||</span> <span class="n">tabname</span> <span class="n">AS</span> <span class="n">Imports</span> <span class="n">FROM</span>  <span class="n">syscat</span><span class="p">.</span><span class="n">tables</span>  <span class="n">WHERE</span> <span class="n">tabschema</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">DB2INST1</span><span class="err">&#39;</span>
</pre></div>


<h3 id="import-table">import table</h3>
<div class="hlcode"><pre><span class="cp">#replace_create means delete old data and insert new data, if no table, will create table first</span>
<span class="n">db2</span> <span class="s">&quot;import from t.txt2 of ixf messages msg.out replace_create into t&quot;</span>

<span class="cp">#append data</span>
<span class="n">db2</span> <span class="s">&quot;import from t.txt2 of ixf messages msg.out insert into t&quot;</span>

<span class="cp">#append and update data</span>
<span class="n">db2</span> <span class="s">&quot;import from t.txt2 of ixf messages msg.out replace into t&quot;</span>
</pre></div>


<p>INSERT :<br />
Adds the imported data to the table without changing the existing table data. The target table must already exist.<br />
INSERT_UPDATE :<br />
Adds the imported data to the target table or updates existing rows with matching primary keys. The target table must already exist defined with primary keys.<br />
CREATE :<br />
Creates the table, index definitions, and row contents. The input file must use the IXF format because this is the only format that stores table and index definitions.<br />
REPLACE :<br />
Deletes all existing data from the table and inserts the imported data. The table definition and index definitions are not changed.<br />
REPLACE_CREATE:<br />
If the table exists, this option behaves like the replace option. If the table does not exist,this option behaves like the create option, which creates the table and index definitions and then inserts the row contents. This option requires the input file to be in IXF format.</p>
<p>--db2 load</p>
<div class="hlcode"><pre><span class="n">db2</span> <span class="s">&quot;load from db2inst.t.ixf of ixf \</span>
<span class="s">savecount 1000 \</span>
<span class="s">warningcount 10 \</span>
<span class="s">messages db2inst.t.ixf.out \</span>
<span class="s">insert into t&quot;</span>

<span class="n">Four</span> <span class="n">phase</span> <span class="n">of</span> <span class="n">LOAD</span><span class="o">:</span>
<span class="nl">Load:</span>
<span class="nl">Build:</span>
<span class="nl">Delete:</span>
<span class="n">Index</span> <span class="n">Copy</span><span class="o">:</span>
</pre></div>


<p>2.reorg<br />
reorg整理碎片，减少overflow(Oracle中的行迁移)，减少索引层次，但鉴于对资源消耗较大，建议停机或者业务空闲时间做。<br />
reorgchk工具用来判断一张表或索引是否需要reorg，同时sysibmadm.snaptab也能判断一张表或索引是否需要reorg。<br />
reorgchk利用8个公式，3个表公式，5个索引公式判断表或者索引是否需要重组，F1~F3标记为"<em>"，表明表需要重组，F4~F8标记为"</em>"，表明index需要reorg。</p>
<div class="hlcode"><pre><span class="n">db2</span> <span class="n">reorgchk</span> <span class="n">on</span> <span class="n">schema</span> <span class="n">db2inst1</span>
</pre></div>


<p>--离线重组<br />
离线重组默认是allow read access</p>
<div class="hlcode"><pre><span class="n">db2</span> <span class="n">reorg</span> <span class="n">table</span> <span class="n">db2inst1</span><span class="p">.</span><span class="n">t</span>
</pre></div>


<p>检查reorg是否完成<br />
--db2 get snapshot</p>
<div class="hlcode"><pre><span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="n">get</span> <span class="n">snapshot</span> <span class="k">for</span> <span class="n">tables</span> <span class="n">on</span> <span class="n">testdb</span>
 <span class="n">Table</span> <span class="n">Schema</span>        <span class="o">=</span> <span class="n">DB2INST1</span>
 <span class="n">Table</span> <span class="n">Name</span>          <span class="o">=</span> <span class="n">T</span>
 <span class="n">Table</span> <span class="n">Type</span>          <span class="o">=</span> <span class="n">User</span>
 <span class="n">Data</span> <span class="n">Object</span> <span class="n">Pages</span>   <span class="o">=</span> <span class="mi">1</span>
 <span class="n">Index</span> <span class="n">Object</span> <span class="n">Pages</span>  <span class="o">=</span> <span class="mi">4</span>
 <span class="n">Rows</span> <span class="n">Read</span>           <span class="o">=</span> <span class="n">Not</span> <span class="n">Collected</span>
 <span class="n">Rows</span> <span class="n">Written</span>        <span class="o">=</span> <span class="mi">0</span>
 <span class="n">Overflows</span>           <span class="o">=</span> <span class="mi">0</span>
 <span class="n">Page</span> <span class="n">Reorgs</span>         <span class="o">=</span> <span class="mi">0</span>
 <span class="n">Table</span> <span class="n">Reorg</span> <span class="n">Information</span><span class="o">:</span>
   <span class="n">Reorg</span> <span class="n">Type</span>        <span class="o">=</span>
        <span class="n">Reclaiming</span>
        <span class="n">Table</span> <span class="n">Reorg</span>
        <span class="n">Allow</span> <span class="n">Read</span> <span class="n">Access</span>
        <span class="n">Reorg</span> <span class="n">Data</span> <span class="n">Only</span>
   <span class="n">Reorg</span> <span class="n">Index</span>       <span class="o">=</span> <span class="mi">0</span>                <span class="o">--</span><span class="n">reorg</span> <span class="n">index</span> <span class="n">id</span>
   <span class="n">Reorg</span> <span class="n">Tablespace</span>  <span class="o">=</span> <span class="mi">4</span>                <span class="o">--</span><span class="n">reorg</span> <span class="n">tablespace</span>
   <span class="n">Start</span> <span class="n">Time</span>        <span class="o">=</span> <span class="mi">08</span><span class="o">/</span><span class="mi">10</span><span class="o">/</span><span class="mi">2015</span> <span class="mi">10</span><span class="o">:</span><span class="mi">52</span><span class="o">:</span><span class="mf">38.625729</span>   <span class="o">--</span><span class="n">reorg</span> <span class="n">start</span> <span class="n">time</span>
   <span class="n">Reorg</span> <span class="n">Phase</span>       <span class="o">=</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">Index</span> <span class="n">Recreate</span>
   <span class="n">Max</span> <span class="n">Phase</span>         <span class="o">=</span> <span class="mi">3</span>
   <span class="n">Phase</span> <span class="n">Start</span> <span class="n">Time</span>  <span class="o">=</span> <span class="mi">08</span><span class="o">/</span><span class="mi">10</span><span class="o">/</span><span class="mi">2015</span> <span class="mi">10</span><span class="o">:</span><span class="mi">52</span><span class="o">:</span><span class="mf">39.444076</span>
   <span class="n">Status</span>            <span class="o">=</span> <span class="n">Completed</span>            <span class="o">--</span><span class="n">reorg</span> <span class="n">status</span>
   <span class="n">Current</span> <span class="n">Counter</span>   <span class="o">=</span> <span class="mi">0</span>
   <span class="n">Max</span> <span class="n">Counter</span>       <span class="o">=</span> <span class="mi">0</span>
   <span class="n">Completion</span>        <span class="o">=</span> <span class="mi">0</span>
   <span class="n">End</span> <span class="n">Time</span>          <span class="o">=</span> <span class="mi">08</span><span class="o">/</span><span class="mi">10</span><span class="o">/</span><span class="mi">2015</span> <span class="mi">10</span><span class="o">:</span><span class="mi">52</span><span class="o">:</span><span class="mf">39.572889</span>   <span class="o">--</span><span class="n">reorg</span> <span class="n">end</span> <span class="n">time</span>
</pre></div>


<p>--db2pd</p>
<div class="hlcode"><pre><span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">db2pd</span> <span class="o">-</span><span class="n">d</span> <span class="n">testdb</span> <span class="o">-</span><span class="n">reorg</span>
</pre></div>


<p>--db2 list history reorg all for testdb</p>
<div class="hlcode"><pre><span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="n">list</span> <span class="n">history</span> <span class="n">reorg</span> <span class="n">all</span> <span class="k">for</span> <span class="n">testdb</span>
 <span class="n">Op</span> <span class="n">Obj</span> <span class="n">Timestamp</span><span class="o">+</span><span class="n">Sequence</span> <span class="n">Type</span> <span class="n">Dev</span> <span class="n">Earliest</span> <span class="n">Log</span> <span class="n">Current</span> <span class="n">Log</span>  <span class="n">Backup</span> <span class="n">ID</span>
 <span class="o">--</span> <span class="o">---</span> <span class="o">------------------</span> <span class="o">----</span> <span class="o">---</span> <span class="o">------------</span> <span class="o">------------</span> <span class="o">--------------</span>
  <span class="n">G</span>  <span class="n">T</span>  <span class="mi">20150810105238</span>      <span class="n">F</span>       <span class="n">S0000025</span><span class="p">.</span><span class="n">LOG</span> <span class="n">S0000029</span><span class="p">.</span><span class="n">LOG</span>
 <span class="o">----------------------------------------------------------------------------</span>
  <span class="nl">Table:</span>  <span class="s">&quot;DB2INST1&quot;</span><span class="p">.</span><span class="s">&quot;T&quot;</span>

 <span class="o">----------------------------------------------------------------------------</span>
    <span class="nl">Comment:</span> <span class="n">REORG</span>
 <span class="n">Start</span> <span class="n">Time</span><span class="o">:</span> <span class="mi">20150810105238</span>
   <span class="n">End</span> <span class="n">Time</span><span class="o">:</span> <span class="mi">20150810105239</span>
     <span class="nl">Status:</span> <span class="n">A</span>
 <span class="o">----------------------------------------------------------------------------</span>
  <span class="nl">EID:</span> <span class="mi">127</span>
<span class="o">--</span><span class="err">其中</span><span class="n">Op</span><span class="o">=</span><span class="n">G</span><span class="err">表示</span><span class="n">reorg</span><span class="err">，</span><span class="n">Obj</span><span class="o">=</span><span class="n">T</span><span class="err">表示</span><span class="n">table</span><span class="err">，</span><span class="n">Obj</span><span class="o">=</span><span class="n">I</span><span class="err">表示</span><span class="n">index</span><span class="err">，</span><span class="n">Type</span><span class="o">=</span><span class="n">F</span><span class="err">表示</span><span class="n">offline</span><span class="err">，</span><span class="n">type</span><span class="o">=</span><span class="n">N</span><span class="err">表示</span><span class="n">online</span>
</pre></div>


<p>--在线重组，会记录大量日志，可以随时启动和终止</p>
<div class="hlcode"><pre><span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="n">reorg</span> <span class="n">table</span> <span class="n">db2inst1</span><span class="p">.</span><span class="n">t</span> <span class="n">inplace</span> <span class="n">allow</span> <span class="n">write</span> <span class="n">access</span>
</pre></div>


<p>--reorg index</p>
<div class="hlcode"><pre><span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="n">reorg</span> <span class="n">indexes</span> <span class="n">all</span> <span class="k">for</span> <span class="n">table</span> <span class="n">t</span>
</pre></div>


<p>对于索引reorg的监控，只能通过db2 list history all查看，或者查看diaglog。</p>
<h2 id="reorg-history">Reorg history</h2>
<div class="hlcode"><pre><span class="n">db2</span> <span class="s">&quot;</span>
<span class="n">SELECT</span> <span class="n">SUBSTR</span><span class="p">(</span><span class="n">TABNAME</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span> <span class="n">AS</span> <span class="n">TAB_NAME</span><span class="p">,</span>
<span class="n">SUBSTR</span><span class="p">(</span><span class="n">TABSCHEMA</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span> <span class="n">AS</span> <span class="n">TAB_SCHEMA</span><span class="p">,</span>
<span class="n">REORG_PHASE</span><span class="p">,</span> <span class="n">SUBSTR</span><span class="p">(</span><span class="n">REORG_TYPE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span> <span class="n">AS</span> <span class="n">REORG_TYPE</span><span class="p">,</span>
<span class="n">REORG_STATUS</span><span class="p">,</span> <span class="n">REORG_COMPLETION</span><span class="p">,</span> <span class="n">DBPARTITIONNUM</span>
<span class="n">FROM</span> <span class="n">SYSIBMADM</span><span class="p">.</span><span class="n">SNAPTAB_REORG</span> <span class="n">ORDER</span> <span class="n">BY</span> <span class="n">DBPARTITIONNUM</span>
<span class="s">&quot;</span>
</pre></div>


<h2 id="_7">数据库占用空间的大小</h2>
<div class="hlcode"><pre><span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="n">db2dump</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="s">&quot;call get_dbsize_info(?,?,?,0)&quot;</span>

  <span class="n">Value</span> <span class="n">of</span> <span class="n">output</span> <span class="n">parameters</span>
  <span class="o">--------------------------</span>
  <span class="n">Parameter</span> <span class="n">Name</span>  <span class="o">:</span> <span class="n">SNAPSHOTTIMESTAMP</span>           <span class="o">--</span><span class="err">执行快照的时间戳</span>
  <span class="n">Parameter</span> <span class="n">Value</span> <span class="o">:</span> <span class="mi">2015</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mf">11.09.06.992189</span>

  <span class="n">Parameter</span> <span class="n">Name</span>  <span class="o">:</span> <span class="n">DATABASESIZE</span>            <span class="o">--</span><span class="err">返回数据库的大小（</span><span class="n">bytes</span><span class="err">）</span>
  <span class="n">Parameter</span> <span class="n">Value</span> <span class="o">:</span> <span class="mi">101294080</span>

  <span class="n">Parameter</span> <span class="n">Name</span>  <span class="o">:</span> <span class="n">DATABASECAPACITY</span>
  <span class="n">Parameter</span> <span class="n">Value</span> <span class="o">:</span> <span class="mi">35067944960</span>             <span class="o">--</span><span class="err">数据库容量大小（</span><span class="n">bytes</span><span class="err">）</span><span class="p">,</span><span class="err">即</span><span class="n">OS</span><span class="err">或者存储的总空间</span>

  <span class="n">Return</span> <span class="n">Status</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>


<p>0表示0分钟，即立刻刷新</p>
<h2 id="_8">表空间占用大小</h2>
<div class="hlcode"><pre><span class="n">list</span> <span class="n">tablespaces</span> <span class="n">show</span> <span class="n">detail</span><span class="err">只能查看</span><span class="n">DMS</span><span class="err">的表空间大小，无法查看</span><span class="n">SMS</span><span class="err">的。对于</span><span class="n">automatic</span><span class="err">，只要该目录有空间，</span><span class="n">DB2</span><span class="err">会自动扩展。</span>
<span class="n">tablespace_usage</span><span class="p">.</span><span class="n">xx</span><span class="o">:</span>
<span class="n">db2</span> <span class="s">&quot;select substr(tbsp_name,1,30) as TBS_NAME,\</span>
<span class="s">substr(tbsp_type,1,10) as TBSP_TYPE,\</span>
<span class="s">substr(tbsp_content_type,1,10) as TBS_TYPE,\</span>
<span class="s">sum(tbsp_total_size_kb)/1024 as TOTAL_MB,\</span>
<span class="s">sum(tbsp_used_size_kb)/1024 as USED_MB,\</span>
<span class="s">sum(tbsp_free_size_kb)/1024 as FREE_MB,\</span>
<span class="s">tbsp_page_size as PAGE_SIZE \</span>
<span class="s">from sysibmadm.tbsp_utilization \</span>
<span class="s">where tbsp_type!=&#39;SMS&#39; \</span>
<span class="s">group by tbsp_name,tbsp_type,tbsp_content_type,tbsp_page_size order by 1&quot;</span>
<span class="n">db2</span> <span class="o">-</span><span class="n">tvf</span> <span class="n">tablspace_uage</span><span class="p">.</span><span class="n">xx</span>
</pre></div>


<h2 id="_9">表/索引占用空间大小</h2>
<div class="hlcode"><pre><span class="o">--</span><span class="n">table</span><span class="err">占用空间有</span><span class="n">db2pd</span> <span class="o">-</span><span class="n">d</span> <span class="n">db_name</span> <span class="o">-</span><span class="n">tcbstats</span><span class="p">,</span> <span class="n">admin_get_tab_inf</span><span class="err">函数和</span><span class="n">sysibmadm</span><span class="p">.</span><span class="n">admintabinfo</span><span class="o">:</span>
</pre></div>


<h3 id="perform-the-select-below-to-know-the-size-one-table">Perform the select below to know the size one table:</h3>
<div class="hlcode"><pre><span class="nx">db2</span> <span class="s2">&quot;SELECT TABSCHEMA, TABNAME, SUM(DATA_OBJECT_P_SIZE)+</span>
<span class="s2">SUM(INDEX_OBJECT_P_SIZE)+ SUM(LONG_OBJECT_P_SIZE)+</span>
<span class="s2">SUM(LOB_OBJECT_P_SIZE)+ SUM(XML_OBJECT_P_SIZE) FROM</span>
<span class="s2">SYSIBMADM.ADMINTABINFO where tabschema=&#39;&lt;tabschema_name&gt;&#39; and tabname=&#39;&lt;table_name&gt;&#39; group by tabschema,tabname&quot;</span>
</pre></div>


<h3 id="perform-the-select-below-to-know-the-size-all-tables-in-a-specific-schema">Perform the select below to know the size all tables in a specific schema:</h3>
<div class="hlcode"><pre><span class="nx">db2</span> <span class="s2">&quot;SELECT tabname,TABSCHEMA, SUM(DATA_OBJECT_P_SIZE)+</span>
<span class="s2">SUM(INDEX_OBJECT_P_SIZE)+ SUM(LONG_OBJECT_P_SIZE)+</span>
<span class="s2">SUM(LOB_OBJECT_P_SIZE)+ SUM(XML_OBJECT_P_SIZE) FROM</span>
<span class="s2">SYSIBMADM.ADMINTABINFO where TABSCHEMA=&lt;tabschema_name&gt; group by tabname,tabschema&quot;</span>
</pre></div>


<h3 id="perform-the-select-below-to-know-the-size-of-all-schema">Perform the select below to know the size of all schema:</h3>
<div class="hlcode"><pre> <span class="n">db2</span> <span class="s">&quot;SELECT TABSCHEMA, SUM(DATA_OBJECT_P_SIZE)+</span>
 <span class="n">SUM</span><span class="p">(</span><span class="n">INDEX_OBJECT_P_SIZE</span><span class="p">)</span><span class="o">+</span> <span class="n">SUM</span><span class="p">(</span><span class="n">LONG_OBJECT_P_SIZE</span><span class="p">)</span><span class="o">+</span>
 <span class="n">SUM</span><span class="p">(</span><span class="n">LOB_OBJECT_P_SIZE</span><span class="p">)</span><span class="o">+</span> <span class="n">SUM</span><span class="p">(</span><span class="n">XML_OBJECT_P_SIZE</span><span class="p">)</span> <span class="n">FROM</span>
 <span class="n">SYSIBMADM</span><span class="p">.</span><span class="n">ADMINTABINFO</span> <span class="n">GROUP</span> <span class="n">BY</span> <span class="n">TABSCHEMA</span><span class="s">&quot;</span>
</pre></div>


<h2 id="lock">Lock</h2>
<p>DB2事务隔离级别<br />
1.Uncommitted Read<br />
2.Cursor Stability      --Default Isolation Level<br />
3.Read Stability<br />
4.Repeatable Read<br />
在DB2 V9.7之前，在default isolation leve（CS）下，读取数据的事务遇到正在被其他事务更新的数据必须等待更新事务的结束，9.7后，提供连Current Committed机制，类似Oracle中的Read consistency，用来解决高并发中的此问题</p>
<h3 id="session-isolation-level">查询当前session isolation level</h3>
<div class="hlcode"><pre><span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="s">&quot;SELECT CURRENT ISOLATION FROM sysibm.sysdummy1&quot;</span>

<span class="mi">1</span>
<span class="o">--</span>
  <span class="mi">1</span> <span class="n">record</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="n">selected</span><span class="p">.</span>
</pre></div>


<p>空白表示为默认级别</p>
<p>Oracle事务隔离级别(isolation level)<br />
1.read committed<br />
2.read only<br />
3.serializable</p>
<p>锁：<br />
共享锁,Share lock<br />
排它锁,eXclusive lock</p>
<p>DB2中常见的锁主要包括表锁及行锁，锁有三个基本属性：锁的模式、锁的对象及锁的持久性。<br />
--表锁模式<br />
表锁分为强类型锁和弱类型锁，强类型锁适用于表里的所有行，主要包括S，U，X，Z四种类型。弱锁类型也叫意向锁(intent),主要包括IN，IS，IX和SIX，意向锁的目的是配合行锁，在获得行锁前必须先获得表锁(Intent)<br />
默认情况下，DB2不会实施强锁类型，只有通过lock table锁表或者发生锁升级的时候才会使用。<br />
--弱锁类型（intent，意向锁，配合行锁使用，即在申请行锁前，必须先获得表级意向锁）<br />
IN（Intent None）：            无意向锁，锁的拥有者可以读取表中的任何数据，包括其他事务未提交的数据，但不能修改任何一行，其他并发应用可以读写表中任意行<br />
IS（Intent Share）：           意向共享锁，lock owner可以读，但不能修改，其他并发应用可以读写。当需要读表中的行时，需要先获取表上的IS锁<br />
IX（Intent eXclusive）：           意向排它锁，lock owner和其他application都可以读写数据，一般当需要修改表中的行时（DML），需要先获取表上的IX锁<br />
SIX（Shard with Intent eXclusive）：   lock owner可以读取表中所有行，如果owner有行级X锁，则可以修改该行。其他并发应用可以读取该表数据, S+IX或者IX+S<br />
IS、IX、SIX方式用于表一级并需要行锁配合，他们可以阻止其他应用程序对该表加上排它锁。<br />
--强锁类型<br />
S（Share）：       lock owner和其他应用都可以读取表中任何数据，但不能更改<br />
U（Update）：      lock owner可以读取表中任何数据，如果升级到X锁后，可以更新表中任何数据。该锁是处于等待对数据进行处理的中间状态（类似select for update）<br />
X（eXclusive）：       lock owner能读写表中的任何数据，其他应用程序只有在Uncommitted Read事务隔离级别才可以读取未提交的数据<br />
Z（Super eXclusive）： 当create、alter、drop时，需要Z锁（DDL语句），如果某表加上Z锁，那么其他应用程序，包括UR级别都无法读取该表数据</p>
<p>--行锁模式<br />
行锁主要分为读锁和写锁，在获得行锁前，必须先获得表级锁<br />
S（Share）：           lock owner和其他应用都可以读取该行，但不能更改                        要求表锁最低模式为IS<br />
U（Update）：          lock owner可以读取该行，并且有可能修改该行，其他并发应用只能读取该行             要求表锁最低模式为IX<br />
X（eXclusive）：           lock owner可以读写该行，其他应用不能读写该行，但在UR可以读取                    要求表锁最低模式为IX<br />
W（Weak exclusive）：      当一行数据被插入表中时，该行会获得W锁，lock owner能修改该行，基本和X锁相同，但W锁同时兼容NW锁      要求表锁最低模式为IX<br />
NS（next key share）：     在CS或者RS隔离级别替代S锁                                 要求表锁最低模式为IS<br />
NW（next ket weak share）：    与X和W类似，当插入索引时候，该行下一键获得NW锁                           要求表锁最低模式为IX<br />
当有索引时才会用到W、NW，NS和S是在不同事务隔离级别下读锁的模式，CS和RS读锁为NS，RR读锁为S<br />
db2pd -d db_name -locks可以查看到当前DB的所有锁</p>
<p>--锁等待<br />
DB2中db cfg的locktimeout参数，锁超时时间，默认为-1，即为无限。可以根据不同应用类型修改此参数。</p>
<div class="hlcode"><pre><span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="n">get</span> <span class="n">db</span> <span class="n">cfg</span> <span class="k">for</span> <span class="n">sample</span> <span class="o">|</span><span class="n">grep</span> <span class="o">-</span><span class="n">i</span> <span class="n">locktimeout</span>
 <span class="n">Lock</span> <span class="n">timeout</span> <span class="p">(</span><span class="n">sec</span><span class="p">)</span>                        <span class="p">(</span><span class="n">LOCKTIMEOUT</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="n">update</span> <span class="n">db</span> <span class="n">cfg</span> <span class="k">for</span> <span class="n">testdb</span> <span class="n">using</span> <span class="n">locktimeout</span> <span class="mi">10</span>
</pre></div>


<p>重启实例后生效</p>
<div class="hlcode"><pre><span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="n">get</span> <span class="n">db</span> <span class="n">cfg</span> <span class="k">for</span> <span class="n">testdb</span> <span class="o">|</span><span class="n">grep</span> <span class="o">-</span><span class="n">i</span> <span class="n">locktimeout</span>
 <span class="n">Lock</span> <span class="n">timeout</span> <span class="p">(</span><span class="n">sec</span><span class="p">)</span>                        <span class="p">(</span><span class="n">LOCKTIMEOUT</span><span class="p">)</span> <span class="o">=</span> <span class="mi">10</span>
<span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="o">+</span><span class="n">c</span> <span class="s">&quot;delete from t where name=&#39;Kyun&#39;&quot;</span>
<span class="n">DB20000I</span>  <span class="n">The</span> <span class="n">SQL</span> <span class="n">command</span> <span class="n">completed</span> <span class="n">successfully</span><span class="p">.</span>
</pre></div>


<p>--在另一session</p>
<div class="hlcode"><pre><span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="o">+</span><span class="n">c</span> <span class="s">&quot;delete from t where location=&#39;CQ&#39;&quot;</span>
<span class="n">DB21034E</span>  <span class="n">The</span> <span class="n">command</span> <span class="n">was</span> <span class="n">processed</span> <span class="n">as</span> <span class="n">an</span> <span class="n">SQL</span> <span class="n">statement</span> <span class="n">because</span> <span class="n">it</span> <span class="n">was</span> <span class="n">not</span> <span class="n">a</span>
<span class="n">valid</span> <span class="n">Command</span> <span class="n">Line</span> <span class="n">Processor</span> <span class="n">command</span><span class="p">.</span>  <span class="n">During</span> <span class="n">SQL</span> <span class="n">processing</span> <span class="n">it</span> <span class="n">returned</span><span class="o">:</span>
<span class="n">SQL0911N</span>  <span class="n">The</span> <span class="n">current</span> <span class="n">transaction</span> <span class="n">has</span> <span class="n">been</span> <span class="n">rolled</span> <span class="n">back</span> <span class="n">because</span> <span class="n">of</span> <span class="n">a</span> <span class="n">deadlock</span>
<span class="n">or</span> <span class="n">timeout</span><span class="p">.</span>  <span class="n">Reason</span> <span class="n">code</span> <span class="s">&quot;68&quot;</span><span class="p">.</span>  <span class="n">SQLSTATE</span><span class="o">=</span><span class="mi">40001</span>
</pre></div>


<p>--查找引起锁等待的语句</p>
<div class="hlcode"><pre><span class="n">db2pd</span> <span class="o">-</span><span class="n">d</span> <span class="n">testdb</span> <span class="o">-</span><span class="n">locks</span> <span class="n">showlocks</span> <span class="n">wait</span> <span class="o">-</span><span class="n">tra</span> <span class="o">-</span><span class="n">app</span> <span class="o">-</span><span class="n">dyn</span> <span class="o">&gt;</span> <span class="n">db2pd</span><span class="p">.</span><span class="n">out</span>
<span class="n">db2pd</span> <span class="o">-</span><span class="n">d</span> <span class="n">mysample</span> <span class="o">-</span><span class="n">locks</span> <span class="o">-</span><span class="n">transactioins</span> <span class="o">-</span><span class="n">applications</span> <span class="o">-</span><span class="n">dynamic</span>
</pre></div>


<p>--死锁<br />
DB2中，死锁的发生最少要4条SQL语句，DB2中有个参数默认每隔十秒检查是否存在死锁，如果有，将会随机终止一个，然后让另一方继续进程事务。</p>
<div class="hlcode"><pre><span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="n">get</span> <span class="n">db</span> <span class="n">cfg</span> <span class="k">for</span> <span class="n">sample</span> <span class="o">|</span><span class="n">grep</span> <span class="o">-</span><span class="n">i</span> <span class="n">dlchktime</span>
 <span class="n">Interval</span> <span class="k">for</span> <span class="n">checking</span> <span class="n">deadlock</span> <span class="p">(</span><span class="n">ms</span><span class="p">)</span>         <span class="p">(</span><span class="n">DLCHKTIME</span><span class="p">)</span> <span class="o">=</span> <span class="mi">10000</span>
</pre></div>


<p>--Lock escalation ， 锁升级<br />
DB2通过locklist和maxlocks触发锁升级。locklist指定每个数据库可以使用的最大锁内存大小，maxlocks指定每个应用可以占用内存的百分比。在V9版本之后，这两个参数可以调整为automatic，即自动调整</p>
<div class="hlcode"><pre><span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="n">get</span> <span class="n">db</span> <span class="n">cfg</span> <span class="k">for</span> <span class="n">sample</span> <span class="o">|</span><span class="n">grep</span> <span class="n">LOCK</span>
 <span class="n">Max</span> <span class="n">storage</span> <span class="k">for</span> <span class="n">lock</span> <span class="n">list</span> <span class="p">(</span><span class="mi">4</span><span class="n">KB</span><span class="p">)</span>              <span class="p">(</span><span class="n">LOCKLIST</span><span class="p">)</span> <span class="o">=</span> <span class="mi">4096</span>
 <span class="n">Percent</span><span class="p">.</span> <span class="n">of</span> <span class="n">lock</span> <span class="n">lists</span> <span class="n">per</span> <span class="n">application</span>       <span class="p">(</span><span class="n">MAXLOCKS</span><span class="p">)</span> <span class="o">=</span> <span class="mi">10</span>
</pre></div>


<p>锁升级的条件：锁内存使用超出了locklist大小，某个应用使用的锁空间内存达到连locklist*maxlocks%，当发生锁升级的时候，diag.log会记录锁升级的详细信息</p>
<h2 id="db2_3">DB2内存使用查看</h2>
<div class="hlcode"><pre><span class="n">db2mtrk</span> <span class="o">-</span><span class="n">i</span> <span class="o">-</span><span class="n">d</span> <span class="o">-</span><span class="n">p</span> <span class="o">-</span><span class="n">v</span>
<span class="n">db2pd</span> <span class="o">-</span><span class="n">dbptnmem</span>  <span class="o">--</span><span class="err">实例范围，不需要指定</span><span class="n">dbname</span>
<span class="n">db2pd</span> <span class="o">-</span><span class="n">memset</span> <span class="o">-</span><span class="n">db</span> <span class="n">db_name</span> <span class="o">--</span><span class="err">实例或者数据库范围，指定</span><span class="n">dbname</span><span class="err">仅查询指定</span><span class="n">db</span><span class="err">内存</span>
<span class="n">db2pd</span> <span class="o">-</span><span class="n">mempool</span>      <span class="o">--</span><span class="err">用法类似</span><span class="n">memset</span>
</pre></div>


<h2 id="db2_4">DB2监控工具</h2>
<p>1.snapshot命令行<br />
2.snapshot管理视图<br />
3.db2pd<br />
4.db2top<br />
5.事件监控器 --尽量少用，对生产环境会有很大影响</p>
<p>--查看本机安装了几个DB版本</p>
<div class="hlcode"><pre><span class="n">db2greg</span> <span class="o">-</span><span class="n">dump</span>
</pre></div>


<h2 id="db2gcfg">db2gcfg查看实例状态</h2>
<div class="hlcode"><pre><span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">db2gcf</span> <span class="o">-</span><span class="n">s</span> <span class="o">-</span><span class="n">i</span> <span class="n">db2inst1</span>

<span class="n">Instance</span>  <span class="o">:</span> <span class="n">db2inst1</span>
<span class="n">DB2</span> <span class="n">State</span> <span class="o">:</span> <span class="n">Available</span>
</pre></div>


<p>--export multiple tables in DB2</p>
<table class="hlcodetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31</pre></div></td><td class="code"><div class="hlcode"><pre><span class="c">#!/usr/bin/sh</span>

db2 connect to sourcedb
<span class="nv">list</span><span class="o">=</span><span class="s2">&quot;</span>
<span class="s2">db2v97i.ACCESS_ID</span>
<span class="s2">db2v97i.ACCESS_ID_HIST</span>
<span class="s2">db2v97i.APPL_PRIV_CODE_RULE_BLUE_GROUP</span>
<span class="s2">db2v97i.CUST_RFC_BATCH_ERR</span>
<span class="s2">db2v97i.CUST_DTRMNTN_LOOKUP_HIST</span>
<span class="s2">db2v97i.NOTIFIED_USER</span>
<span class="s2">db2v97i.NOTIFIED_USER_HIST</span>
<span class="s2">db2v97i.SAMETIME_USERS</span>
<span class="s2">db2v97i.SAP_IDOC_USER_ID_XREF</span>
<span class="s2">db2v97i.SAP_IDOC_USER_ID_XREF_HIST</span>
<span class="s2">db2v97i.USER_PRIV</span>
<span class="s2">db2v97i.USER_PRIV_HIST</span>
<span class="s2">db2v97i.USERS</span>
<span class="s2">db2v97i.USERS_HIST</span>
<span class="s2">db2v97i.WEB_AUTH_REG</span>
<span class="s2">&quot;</span>

<span class="k">for </span>one in <span class="nv">$list</span>
<span class="k">do</span>

<span class="k"> </span>db2 -v <span class="s2">&quot;export to $one.ixf of ixf select * from $one with ur&quot;</span> &gt;&gt;export.log


<span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -ne 0 <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;error table: $one&quot;</span>&gt;&gt;error.log
<span class="k">fi</span>
<span class="k">done</span>
</pre></div>
</td></tr></table>

<h2 id="finding-rebalance-status">finding rebalance status</h2>
<div class="hlcode"><pre><span class="n">db2</span> <span class="s">&quot;</span>
<span class="n">select</span>
<span class="n">varchar</span><span class="p">(</span><span class="n">tbsp_name</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span> <span class="n">as</span> <span class="n">tbsp_name</span><span class="p">,</span>
<span class="n">dbpartitionnum</span><span class="p">,</span>
<span class="n">member</span><span class="p">,</span>
<span class="n">rebalancer_mode</span><span class="p">,</span>
<span class="n">rebalancer_status</span><span class="p">,</span>
<span class="n">rebalancer_extents_remaining</span><span class="p">,</span>
<span class="n">rebalancer_extents_processed</span><span class="p">,</span>
<span class="n">rebalancer_start_time</span>
<span class="n">from</span> <span class="n">table</span><span class="p">(</span><span class="n">mon_get_rebalance_status</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span> <span class="n">as</span> <span class="n">t</span>
<span class="s">&quot;</span>
</pre></div>


<p>--DB2 Oracle数据字典的兼容</p>
<div class="hlcode"><pre><span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">db2set</span> <span class="n">DB2_COMPATIBILITY_VECTOR</span><span class="o">=</span><span class="n">ORA</span>
<span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">db2stop</span>
<span class="mi">08</span><span class="o">/</span><span class="mi">11</span><span class="o">/</span><span class="mi">2015</span> <span class="mi">09</span><span class="o">:</span><span class="mi">33</span><span class="o">:</span><span class="mi">42</span>     <span class="mi">0</span>   <span class="mi">0</span>   <span class="n">SQL1025N</span>  <span class="n">The</span> <span class="n">database</span> <span class="n">manager</span> <span class="n">was</span> <span class="n">not</span> <span class="n">stopped</span> <span class="n">because</span> <span class="n">databases</span> <span class="n">are</span> <span class="n">still</span> <span class="n">active</span><span class="p">.</span>
<span class="n">SQL1025N</span>  <span class="n">The</span> <span class="n">database</span> <span class="n">manager</span> <span class="n">was</span> <span class="n">not</span> <span class="n">stopped</span> <span class="n">because</span> <span class="n">databases</span> <span class="n">are</span> <span class="n">still</span> <span class="n">active</span><span class="p">.</span>
<span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">db2start</span>
<span class="mi">08</span><span class="o">/</span><span class="mi">11</span><span class="o">/</span><span class="mi">2015</span> <span class="mi">09</span><span class="o">:</span><span class="mi">33</span><span class="o">:</span><span class="mi">44</span>     <span class="mi">0</span>   <span class="mi">0</span>   <span class="n">SQL1026N</span>  <span class="n">The</span> <span class="n">database</span> <span class="n">manager</span> <span class="n">is</span> <span class="n">already</span> <span class="n">active</span><span class="p">.</span>
<span class="n">SQL1026N</span>  <span class="n">The</span> <span class="n">database</span> <span class="n">manager</span> <span class="n">is</span> <span class="n">already</span> <span class="n">active</span><span class="p">.</span>

<span class="nl">CLPPlus:</span> <span class="n">Version</span> <span class="mf">1.6</span>
<span class="n">Copyright</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="mi">2009</span><span class="p">,</span> <span class="mi">2011</span><span class="p">,</span> <span class="n">IBM</span> <span class="n">CORPORATION</span><span class="p">.</span>  <span class="n">All</span> <span class="n">rights</span> <span class="n">reserved</span><span class="p">.</span>
<span class="n">SQL</span><span class="o">&gt;</span> <span class="n">connect</span> <span class="n">db2v10i</span><span class="err">@</span><span class="mf">192.168.122.144</span><span class="o">:</span><span class="mi">50001</span><span class="o">/</span><span class="n">testdb</span>

<span class="n">Database</span> <span class="n">Connection</span> <span class="n">Information</span> <span class="o">:</span>
<span class="o">---------------------------------</span>
<span class="n">Hostname</span> <span class="o">=</span> <span class="mf">192.168.122.144</span>
<span class="n">Database</span> <span class="n">server</span> <span class="o">=</span> <span class="n">DB2</span><span class="o">/</span><span class="n">LINUXX8664</span>  <span class="n">SQL10055</span>
<span class="n">SQL</span> <span class="n">authorization</span> <span class="n">ID</span> <span class="o">=</span> <span class="n">db2v10i</span>
<span class="n">Local</span> <span class="n">database</span> <span class="n">alias</span> <span class="o">=</span> <span class="n">TESTDB</span>
<span class="n">Port</span> <span class="o">=</span> <span class="mi">50001</span>

<span class="n">SQL</span><span class="o">&gt;</span> <span class="n">select</span> <span class="n">sysdate</span> <span class="n">from</span> <span class="n">dual</span><span class="p">;</span>

<span class="mi">1</span>
<span class="o">---------------------</span>
<span class="mi">2015</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mi">31</span> <span class="mi">17</span><span class="o">:</span><span class="mi">31</span><span class="o">:</span><span class="mi">22</span>



<span class="n">db2</span> <span class="n">get</span> <span class="n">dbm</span> <span class="n">cfg</span> <span class="o">&gt;</span> <span class="n">dbmcfg</span><span class="p">.</span><span class="n">bk</span>
<span class="n">db2</span> <span class="n">get</span> <span class="n">db</span> <span class="n">cfg</span> <span class="k">for</span> <span class="n">database_name</span> <span class="o">&gt;</span> <span class="n">dbcfg</span><span class="p">.</span><span class="n">bk</span>
<span class="n">db2set</span> <span class="o">-</span><span class="n">all</span> <span class="o">&gt;</span> <span class="n">db2set</span><span class="p">.</span><span class="n">bk</span>
<span class="n">db2</span> <span class="n">list</span> <span class="n">db</span> <span class="n">directory</span> <span class="o">&gt;</span> <span class="n">systemdbdir</span><span class="p">.</span><span class="n">bk</span>
<span class="n">db2</span> <span class="n">list</span> <span class="n">node</span> <span class="n">directory</span> <span class="o">&gt;</span> <span class="n">nodedir</span><span class="p">.</span><span class="n">bk</span>
<span class="n">db2</span> <span class="n">list</span> <span class="n">dcs</span> <span class="n">directory</span> <span class="o">&gt;</span> <span class="n">dcsdir</span><span class="p">.</span><span class="n">bk</span>
</pre></div>


<h1 id="db2rbind-db2-bind">db2rbind &amp; db2 bind</h1>
<p>db2rbind:<br />
Usage notes</p>
<div class="hlcode"><pre><span class="n">This</span> <span class="n">command</span> <span class="n">uses</span> <span class="n">the</span> <span class="n">rebind</span> <span class="n">API</span> <span class="p">(</span><span class="n">sqlarbnd</span><span class="p">)</span> <span class="n">to</span> <span class="n">attempt</span> <span class="n">the</span> <span class="n">re</span><span class="o">-</span><span class="n">validation</span> <span class="n">of</span> <span class="n">all</span> <span class="n">packages</span> <span class="n">in</span> <span class="n">a</span> <span class="n">database</span><span class="p">.</span>
<span class="n">Use</span> <span class="n">of</span> <span class="n">db2rbind</span> <span class="n">is</span> <span class="n">not</span> <span class="n">mandatory</span><span class="p">.</span>
<span class="n">For</span> <span class="n">packages</span> <span class="n">that</span> <span class="n">are</span> <span class="n">invalid</span><span class="p">,</span> <span class="n">you</span> <span class="n">can</span> <span class="n">choose</span> <span class="n">to</span> <span class="n">allow</span> <span class="n">package</span> <span class="n">revalidation</span> <span class="n">to</span> <span class="n">occur</span> <span class="n">implicitly</span> <span class="n">when</span> <span class="n">the</span> <span class="n">package</span> <span class="n">is</span> <span class="n">first</span> <span class="n">used</span><span class="p">.</span> <span class="n">You</span> <span class="n">can</span> <span class="n">choose</span> <span class="n">to</span> <span class="n">selectively</span> <span class="n">revalidate</span> <span class="n">packages</span> <span class="n">with</span> <span class="n">either</span> <span class="n">the</span> <span class="n">REBIND</span> <span class="n">or</span> <span class="n">the</span> <span class="n">BIND</span> <span class="n">command</span><span class="p">.</span>
<span class="n">If</span> <span class="n">the</span> <span class="n">rebind</span> <span class="n">of</span> <span class="n">any</span> <span class="n">of</span> <span class="n">the</span> <span class="n">packages</span> <span class="n">encounters</span> <span class="n">a</span> <span class="n">deadlock</span> <span class="n">or</span> <span class="n">a</span> <span class="n">lock</span> <span class="n">timeout</span> <span class="n">the</span> <span class="n">rebind</span> <span class="n">of</span> <span class="n">all</span> <span class="n">the</span> <span class="n">packages</span> <span class="n">will</span> <span class="n">be</span> <span class="n">rolled</span> <span class="n">back</span><span class="p">.</span>
<span class="n">If</span> <span class="n">you</span> <span class="n">issue</span> <span class="n">the</span> <span class="n">db2rbind</span> <span class="n">command</span> <span class="n">and</span> <span class="n">the</span> <span class="n">instance</span> <span class="n">is</span> <span class="n">active</span><span class="p">,</span> <span class="n">you</span> <span class="n">will</span> <span class="n">see</span> <span class="n">the</span> <span class="n">SQL1026N</span> <span class="n">error</span> <span class="n">message</span><span class="p">.</span>
<span class="n">Every</span> <span class="n">compiled</span> <span class="n">SQL</span> <span class="n">object</span> <span class="n">has</span> <span class="n">a</span> <span class="n">dependent</span> <span class="n">package</span><span class="p">.</span> <span class="n">The</span> <span class="n">package</span> <span class="n">can</span> <span class="n">be</span> <span class="n">rebound</span> <span class="n">at</span> <span class="n">any</span> <span class="n">time</span> <span class="n">by</span> <span class="n">using</span> <span class="n">the</span> <span class="n">REBIND_ROUTINE_PACKAGE</span> <span class="n">procedure</span><span class="p">.</span> <span class="n">Explicitly</span> <span class="n">rebinding</span> <span class="n">the</span> <span class="n">dependent</span> <span class="n">package</span> <span class="n">does</span> <span class="n">not</span> <span class="n">revalidate</span> <span class="n">an</span> <span class="n">invalid</span> <span class="n">object</span><span class="p">.</span> <span class="n">Revalidate</span> <span class="n">an</span> <span class="n">invalid</span> <span class="n">object</span> <span class="n">with</span> <span class="n">automatic</span> <span class="n">revalidation</span> <span class="n">or</span> <span class="n">explicitly</span> <span class="n">by</span> <span class="n">using</span> <span class="n">the</span> <span class="n">ADMIN_REVALIDATE_DB_OBJECTS</span> <span class="n">procedure</span><span class="p">.</span> <span class="n">Object</span> <span class="n">revalidation</span> <span class="n">automatically</span> <span class="n">rebinds</span> <span class="n">the</span> <span class="n">dependent</span> <span class="n">package</span><span class="p">.</span>
</pre></div>


<p>BIND command</p>
<p>Invokes the bind utility, which prepares SQL statements stored in the bind file generated by the precompiler, and creates a package that is stored in the database.<br />
Scope</p>
<p>This command can be issued from any database partition in db2nodes.cfg. It updates the database catalogs on the catalog database partition. Its effects are visible to all database partitions.</p>
<p>Usage notes</p>
<p>Binding a package using the REOPT option with the ONCE or ALWAYS value specified might change the static and dynamic statement compilation and performance.</p>
<p>Binding can be done as part of the precompile process for an application program source file, or as a separate step at a later time. Use BIND when binding is performed as a separate process.</p>
<p>The name used to create the package is stored in the bind file, and is based on the source file name from which it was generated (existing paths or extensions are discarded). For example, a precompiled source file called myapp.sql generates a default bind file called myapp.bnd and a default package name of MYAPP. However, the bind file name and the package name can be overridden at precompile time by using the BINDFILE and the PACKAGE options.</p>
<p>Binding a package with a schema name that does not already exist results in the implicit creation of that schema. The schema owner is SYSIBM. The CREATEIN privilege on the schema is granted to PUBLIC.</p>
<p>BIND executes under the transaction that was started. After performing the bind, BIND issues a COMMIT or a ROLLBACK to terminate the current transaction and start another one.</p>
<p>Binding stops if a fatal error or more than 100 errors occur. If a fatal error occurs, the utility stops binding, attempts to close all files, and discards the package.<br />
When a package exhibits bind behavior, the following will be true:</p>
<div class="hlcode"><pre><span class="n">The</span> <span class="n">implicit</span> <span class="n">or</span> <span class="n">explicit</span> <span class="n">value</span> <span class="n">of</span> <span class="n">the</span> <span class="n">BIND</span> <span class="n">option</span> <span class="n">OWNER</span> <span class="n">will</span> <span class="n">be</span> <span class="n">used</span> <span class="k">for</span> <span class="n">authorization</span> <span class="n">checking</span> <span class="n">of</span> <span class="n">dynamic</span> <span class="n">SQL</span> <span class="n">statements</span><span class="p">.</span>
<span class="n">The</span> <span class="n">implicit</span> <span class="n">or</span> <span class="n">explicit</span> <span class="n">value</span> <span class="n">of</span> <span class="n">the</span> <span class="n">BIND</span> <span class="n">option</span> <span class="n">QUALIFIER</span> <span class="n">will</span> <span class="n">be</span> <span class="n">used</span> <span class="n">as</span> <span class="n">the</span> <span class="n">implicit</span> <span class="n">qualifier</span> <span class="k">for</span> <span class="n">qualification</span> <span class="n">of</span> <span class="n">unqualified</span> <span class="n">objects</span> <span class="n">within</span> <span class="n">dynamic</span> <span class="n">SQL</span> <span class="n">statements</span><span class="p">.</span>
<span class="n">The</span> <span class="n">value</span> <span class="n">of</span> <span class="n">the</span> <span class="n">special</span> <span class="k">register</span> <span class="n">CURRENT</span> <span class="n">SCHEMA</span> <span class="n">has</span> <span class="n">no</span> <span class="n">effect</span> <span class="n">on</span> <span class="n">qualification</span><span class="p">.</span>
</pre></div>


<p>In the event that multiple packages are referenced during a single connection, all dynamic SQL statements prepared by those packages will exhibit the behavior as specified by the DYNAMICRULES option for that specific package and the environment they are used in.</p>
<p>Parameters displayed in the SQL0020W message are correctly noted as errors, and will be ignored as indicated by the message.</p>
<p>If an SQL statement is found to be in error and the BIND option SQLERROR CONTINUE was specified, the statement will be marked as invalid. In order to change the state of the SQL statement, another BIND must be issued . Implicit and explicit rebind will not change the state of an invalid statement. In a package bound with VALIDATE RUN, a statement can change from static to incremental bind or incremental bind to static across implicit and explicit rebinds depending on whether or not object existence or authority problems exist during the rebind.</p>
<p>The privileges from the roles granted to the authorization identifier used to bind the package (the value of the OWNER bind option) or to PUBLIC, are taken into account when binding a package. Roles acquired through groups, in which the authorization identifier used to bind the package is a member, will not be used.</p>
<p>For an embedded SQL program, if the bind option is not explicitly specified the static statements in the package are bound using the FEDERATED_ASYNC configuration parameter. If the FEDERATED_ASYNCHRONY bind option is specified explicitly, that value is used for binding the packages and is also the initial value of the special register. Otherwise, the value of the database manager configuration parameter is used as the initial value of the special register. The FEDERATED_ASYNCHRONY bind option influences dynamic SQL only when it is explicitly set.</p>
<p>The value of the FEDERATED_ASYNCHRONY bind option is recorded in the FEDERATED_ASYNCHRONY column in the SYSCAT.PACKAGES catalog table. When the bind option is not explicitly specified, the value of FEDERATED_ASYNC configuration parameter is used and the catalog shows a value of -2 for the FEDERATED_ASYNCHRONY column.</p>
<p>If the FEDERATED_ASYNCHRONY bind option is not explicitly specified when a package is bound, and if this package is implicitly or explicitly rebound, the package is rebound using the current value of the FEDERATED_ASYNC configuration parameter.</p>
<h2 id="db2relocation">DB2重命名或者relocation</h2>
<p>DB2提供了可供重命名及迁移数据文件的命令：db2relocatedb</p>
<div class="hlcode"><pre><span class="n">db2relocatedb</span> <span class="o">-</span><span class="n">f</span> <span class="n">param</span><span class="p">.</span><span class="n">file</span>
<span class="n">param</span><span class="p">.</span><span class="n">file</span><span class="err">内容如下：</span>
<span class="n">DB_NAME</span><span class="o">=</span><span class="n">oldName</span><span class="p">,</span><span class="n">newName</span>
<span class="n">DB_PATH</span><span class="o">=</span><span class="n">oldName</span><span class="p">,</span><span class="n">newName</span>
<span class="n">INSTANCE</span><span class="o">=</span><span class="n">oldInst</span><span class="p">,</span><span class="n">newInst</span>
<span class="n">NODENUM</span><span class="o">=</span><span class="n">nodeNumber</span>
<span class="n">LOG_DIR</span><span class="o">=</span><span class="n">oldDirPath</span><span class="p">,</span><span class="n">newDirPath</span>
<span class="n">CONT_PATH</span><span class="o">=</span><span class="n">oldContPath</span><span class="p">,</span><span class="n">newContPath</span>
</pre></div>


<p>Trouble shooting</p>
<h2 id="restore">如果在restore中遇到</h2>
<div class="hlcode"><pre><span class="n">SQL2583N</span>  <span class="n">The</span> <span class="n">intended</span> <span class="n">restore</span> <span class="n">command</span> <span class="n">cannot</span> <span class="n">be</span> <span class="n">processed</span> <span class="n">because</span> <span class="n">a</span> <span class="n">previous</span> <span class="n">incremental</span> <span class="n">restore</span> <span class="n">is</span> <span class="n">still</span> <span class="n">in</span> <span class="n">progress</span><span class="p">.</span>
</pre></div>


<p>可考虑用incremental abort命令终止此restore动作，然后重新执行restore：</p>
<div class="hlcode"><pre><span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="n">backup</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="n">restore</span> <span class="n">db</span> <span class="n">testdb</span> <span class="n">incremental</span> <span class="n">automatic</span> <span class="n">from</span> <span class="o">/</span><span class="n">data2</span><span class="o">/</span><span class="n">backup</span><span class="o">/</span> <span class="n">taken</span> <span class="n">at</span> <span class="mi">20150807105110</span>
<span class="n">SQL2583N</span>  <span class="n">The</span> <span class="n">intended</span> <span class="n">restore</span> <span class="n">command</span> <span class="n">cannot</span> <span class="n">be</span> <span class="n">processed</span> <span class="n">because</span> <span class="n">a</span> <span class="n">previous</span>
<span class="n">incremental</span> <span class="n">restore</span> <span class="n">is</span> <span class="n">still</span> <span class="n">in</span> <span class="n">progress</span><span class="p">.</span>
<span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="n">backup</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="n">restore</span> <span class="n">db</span> <span class="n">testdb</span> <span class="n">incremental</span> <span class="n">abort</span> <span class="n">from</span> <span class="o">/</span><span class="n">data2</span><span class="o">/</span><span class="n">backup</span><span class="o">/</span> <span class="n">taken</span> <span class="n">at</span> <span class="mi">20150807105110</span>
<span class="n">SQL2001N</span>  <span class="n">The</span> <span class="n">utility</span> <span class="n">was</span> <span class="n">interrupted</span><span class="p">.</span>  <span class="n">The</span> <span class="n">output</span> <span class="n">data</span> <span class="n">may</span> <span class="n">be</span> <span class="n">incomplete</span><span class="p">.</span>
<span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="n">backup</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="n">restore</span> <span class="n">db</span> <span class="n">testdb</span> <span class="n">incremental</span> <span class="n">automatic</span> <span class="n">from</span> <span class="o">/</span><span class="n">data2</span><span class="o">/</span><span class="n">backup</span><span class="o">/</span> <span class="n">taken</span> <span class="n">at</span> <span class="mi">20150807105110</span>
</pre></div>


<h2 id="create-primary-constrain-counter-sql0542n">create primary constrain counter SQL0542N</h2>
<div class="hlcode"><pre><span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="s">&quot;alter table db2inst1.t add constraint t_pk primary key(id)&quot;</span>
<span class="n">DB21034E</span>  <span class="n">The</span> <span class="n">command</span> <span class="n">was</span> <span class="n">processed</span> <span class="n">as</span> <span class="n">an</span> <span class="n">SQL</span> <span class="n">statement</span> <span class="n">because</span> <span class="n">it</span> <span class="n">was</span> <span class="n">not</span> <span class="n">a</span> <span class="n">valid</span> <span class="n">Command</span> <span class="n">Line</span> <span class="n">Processor</span> <span class="n">command</span><span class="p">.</span>  <span class="n">During</span> <span class="n">SQL</span> <span class="n">processing</span> <span class="n">it</span> <span class="n">returned</span><span class="o">:</span>
<span class="n">SQL0542N</span>  <span class="n">The</span> <span class="n">column</span> <span class="n">named</span> <span class="s">&quot;ID&quot;</span> <span class="n">cannot</span> <span class="n">be</span> <span class="n">a</span> <span class="n">column</span> <span class="n">of</span> <span class="n">a</span> <span class="n">primary</span> <span class="n">key</span> <span class="n">or</span> <span class="n">unique</span> <span class="n">key</span> <span class="n">constraint</span> <span class="n">because</span> <span class="n">it</span> <span class="n">can</span> <span class="n">contain</span> <span class="n">null</span> <span class="n">values</span><span class="p">.</span>  <span class="n">SQLSTATE</span><span class="o">=</span><span class="mi">42831</span>
<span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="s">&quot;alter table db2inst1.t alter column id set not null&quot;</span>
<span class="n">DB20000I</span>  <span class="n">The</span> <span class="n">SQL</span> <span class="n">command</span> <span class="n">completed</span> <span class="n">successfully</span><span class="p">.</span>
<span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="s">&quot;alter table db2inst1.t add constraint t_pk primary key (id)&quot;</span>
<span class="n">DB21034E</span>  <span class="n">The</span> <span class="n">command</span> <span class="n">was</span> <span class="n">processed</span> <span class="n">as</span> <span class="n">an</span> <span class="n">SQL</span> <span class="n">statement</span> <span class="n">because</span> <span class="n">it</span> <span class="n">was</span> <span class="n">not</span> <span class="n">a</span> <span class="n">valid</span> <span class="n">Command</span> <span class="n">Line</span> <span class="n">Processor</span> <span class="n">command</span><span class="p">.</span>  <span class="n">During</span> <span class="n">SQL</span> <span class="n">processing</span> <span class="n">it</span> <span class="n">returned</span><span class="o">:</span>
<span class="n">SQL0668N</span>  <span class="n">Operation</span> <span class="n">not</span> <span class="n">allowed</span> <span class="k">for</span> <span class="n">reason</span> <span class="n">code</span> <span class="s">&quot;7&quot;</span> <span class="n">on</span> <span class="n">table</span> <span class="s">&quot;DB2INST1.T&quot;</span><span class="p">.</span>
<span class="n">SQLSTATE</span><span class="o">=</span><span class="mi">57016</span>
<span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="n">reorg</span> <span class="n">table</span> <span class="n">db2inst1</span><span class="p">.</span><span class="n">t</span>
<span class="n">DB20000I</span>  <span class="n">The</span> <span class="n">REORG</span> <span class="n">command</span> <span class="n">completed</span> <span class="n">successfully</span><span class="p">.</span>
<span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="s">&quot;alter table db2inst1.t add constraint t_pk primary key (id)&quot;</span>
<span class="n">DB20000I</span>  <span class="n">The</span> <span class="n">SQL</span> <span class="n">command</span> <span class="n">completed</span> <span class="n">successfully</span><span class="p">.</span>
</pre></div>


<h2 id="performance-tunning-tips">Performance tunning tips</h2>
<ol>
<li>Lock escalation<br />
  1) Find "lock escalation" warnings in the db2diag log.<br />
  2) Find the db parameter locklist parameter<br />
  3) Find the db parameter maxlocks parameter<br />
  4) Find the dynamic SQL</li>
</ol>
<div class="hlcode"><pre>    <span class="n">db2pd</span> <span class="o">-</span><span class="n">d</span> <span class="n">testdb</span> <span class="o">-</span><span class="n">locks</span> <span class="n">showlocks</span> <span class="n">wait</span> <span class="o">-</span><span class="n">tra</span> <span class="o">-</span><span class="n">app</span> <span class="o">-</span><span class="n">dyn</span> <span class="o">&gt;</span> <span class="n">db2pd</span><span class="p">.</span><span class="n">out</span>
    <span class="n">db2</span> <span class="n">get</span> <span class="n">snapshot</span> <span class="k">for</span> <span class="n">dynamic</span> <span class="n">sql</span> <span class="n">on</span> <span class="n">testdb</span>
</pre></div>


<ol>
<li>Taking snapshots<br />
  1) Find out what monitors are turning on (session level)</li>
</ol>
<div class="hlcode"><pre>    <span class="n">db2</span> <span class="o">-</span><span class="n">v</span> <span class="n">get</span> <span class="n">monitor</span> <span class="n">switches</span>
</pre></div>


<p>2) Turn on monitors(session level)</p>
<div class="hlcode"><pre>    <span class="n">db2</span> <span class="o">-</span><span class="n">v</span> <span class="n">update</span> <span class="n">monitor</span> <span class="n">switches</span> <span class="n">using</span> <span class="n">bufferpool</span> <span class="n">on</span>
    <span class="n">db2</span> <span class="o">-</span><span class="n">v</span> <span class="n">update</span> <span class="n">monitor</span> <span class="n">switches</span> <span class="n">using</span> <span class="n">lock</span> <span class="n">on</span>
    <span class="n">db2</span> <span class="o">-</span><span class="n">v</span> <span class="n">update</span> <span class="n">monitor</span> <span class="n">switches</span> <span class="n">using</span> <span class="n">sort</span> <span class="n">on</span>
    <span class="n">db2</span> <span class="o">-</span><span class="n">v</span> <span class="n">update</span> <span class="n">monitor</span> <span class="n">switches</span> <span class="n">using</span> <span class="n">statement</span> <span class="n">on</span>
    <span class="n">db2</span> <span class="o">-</span><span class="n">v</span> <span class="n">update</span> <span class="n">monitor</span> <span class="n">switches</span> <span class="n">using</span> <span class="n">table</span> <span class="n">on</span>
    <span class="n">db2</span> <span class="o">-</span><span class="n">v</span> <span class="n">update</span> <span class="n">monitor</span> <span class="n">switches</span> <span class="n">using</span> <span class="n">UOW</span> <span class="n">on</span>
    <span class="o">--</span><span class="n">turn</span> <span class="n">on</span> <span class="n">all</span> <span class="n">monitors</span> <span class="p">(</span><span class="n">session</span> <span class="n">level</span><span class="p">)</span>
    <span class="n">db2</span> <span class="n">update</span> <span class="n">monitor</span> <span class="n">switches</span> <span class="n">using</span> <span class="n">bufferpool</span> <span class="n">on</span> <span class="n">lock</span> <span class="n">on</span> <span class="n">sort</span> <span class="n">on</span> <span class="n">statement</span> <span class="n">on</span> <span class="n">table</span> <span class="n">on</span> <span class="n">timestamp</span> <span class="n">on</span> <span class="n">uow</span> <span class="n">on</span>
    <span class="o">--</span><span class="n">turn</span> <span class="n">on</span> <span class="n">monitors</span> <span class="p">(</span><span class="n">instance</span> <span class="n">level</span><span class="p">)</span>
    <span class="n">db2</span> <span class="n">update</span> <span class="n">dbm</span> <span class="n">cfg</span> <span class="n">using</span> <span class="n">DFT_MON_BUFPOOL</span> <span class="n">ON</span>
    <span class="n">db2</span> <span class="n">update</span> <span class="n">dbm</span> <span class="n">cfg</span> <span class="n">using</span> <span class="n">DFT_MON_LOCK</span> <span class="n">ON</span>
    <span class="n">db2</span> <span class="n">update</span> <span class="n">dbm</span> <span class="n">cfg</span> <span class="n">using</span> <span class="n">DFT_MON_SORT</span> <span class="n">ON</span>
    <span class="n">db2</span> <span class="n">update</span> <span class="n">dbm</span> <span class="n">cfg</span> <span class="n">using</span> <span class="n">DFT_MON_STMT</span> <span class="n">ON</span>
    <span class="n">db2</span> <span class="n">update</span> <span class="n">dbm</span> <span class="n">cfg</span> <span class="n">using</span> <span class="n">DFT_MON_TABLE</span> <span class="n">ON</span>
    <span class="n">db2</span> <span class="n">update</span> <span class="n">dbm</span> <span class="n">cfg</span> <span class="n">using</span> <span class="n">DFT_MON_UOW</span> <span class="n">ON</span>
</pre></div>


<p>3) Run the applications<br />
  4) close monitor (instance level)</p>
<div class="hlcode"><pre>    <span class="n">db2</span> <span class="o">-</span><span class="n">v</span> <span class="n">reset</span> <span class="n">monitor</span> <span class="n">all</span>
    <span class="o">--</span><span class="n">database</span> <span class="n">level</span>
    <span class="n">db2</span> <span class="n">reset</span> <span class="n">monitor</span> <span class="k">for</span> <span class="n">database</span> <span class="n">database_name</span>
</pre></div>


<p>5) get snapshots</p>
<div class="hlcode"><pre>    <span class="n">Lock</span> <span class="n">snapshot</span><span class="o">:</span>      <span class="n">db2</span> <span class="n">get</span> <span class="n">snapshot</span> <span class="k">for</span> <span class="n">locks</span> <span class="n">on</span> <span class="n">DB_NAME</span>
    <span class="n">DBM</span> <span class="n">snapshot</span><span class="o">:</span>       <span class="n">db2</span> <span class="n">get</span> <span class="n">snapshot</span> <span class="k">for</span> <span class="n">dbm</span>
    <span class="n">DB</span> <span class="n">snapshot</span><span class="o">:</span>        <span class="n">db2</span> <span class="n">get</span> <span class="n">snapshot</span> <span class="k">for</span> <span class="n">database</span> <span class="n">on</span> <span class="n">DB_NAME</span>
    <span class="n">TBS</span> <span class="n">snapshot</span><span class="o">:</span>       <span class="n">db2</span> <span class="n">get</span> <span class="n">snapshot</span> <span class="k">for</span> <span class="n">tablespaces</span> <span class="n">on</span> <span class="n">DB_NAME</span>
    <span class="nl">Bufferpool:</span>         <span class="n">db2</span> <span class="n">get</span> <span class="n">snapshot</span> <span class="k">for</span> <span class="n">bufferpools</span> <span class="n">on</span> <span class="n">DB_NAME</span>
    <span class="nl">Applications:</span>       <span class="n">db2</span> <span class="n">get</span> <span class="n">snapshot</span> <span class="k">for</span> <span class="n">applications</span> <span class="n">on</span> <span class="n">DB_NAME</span>
    <span class="n">Dynamic</span> <span class="n">SQL</span><span class="o">:</span>        <span class="n">db2</span> <span class="n">get</span> <span class="n">snapshot</span> <span class="k">for</span> <span class="n">dynamic</span> <span class="n">sql</span> <span class="n">on</span> <span class="n">DB_NAME</span>
    <span class="nl">Table:</span>              <span class="n">db2</span> <span class="n">get</span> <span class="n">snapshot</span> <span class="k">for</span> <span class="n">tables</span> <span class="n">on</span> <span class="n">DB_NAME</span>
</pre></div>


<p>--Run the following command to take a snapshot and report the read times:</p>
<div class="hlcode"><pre><span class="n">db2</span> <span class="n">get</span> <span class="n">snapshot</span> <span class="k">for</span> <span class="n">bufferpools</span> <span class="n">on</span> <span class="n">ODRPTDB</span> <span class="o">|</span><span class="n">awk</span> <span class="err">&#39;</span><span class="p">{</span> <span class="k">if</span> <span class="p">(</span> <span class="err">$</span><span class="mi">1</span><span class="o">==</span><span class="s">&quot;Bufferpool&quot;</span> <span class="o">&amp;&amp;</span> <span class="err">$</span><span class="mi">2</span><span class="o">==</span><span class="s">&quot;name&quot;</span> <span class="p">){</span><span class="n">print</span> <span class="err">$</span><span class="mi">0</span><span class="p">}</span> <span class="k">if</span> <span class="p">(</span> <span class="n">index</span><span class="p">(</span><span class="err">$</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;pool read time&quot;</span><span class="p">)){</span><span class="n">print</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="err">$</span><span class="mi">0</span><span class="p">}}</span><span class="err">&#39;</span>
</pre></div>


<p>--Run the following command to take a snapshot and report the number of logical and physical reads:</p>
<div class="hlcode"><pre><span class="n">db2</span> <span class="n">get</span> <span class="n">snapshot</span> <span class="k">for</span> <span class="n">bufferpools</span> <span class="n">on</span> <span class="n">ODRPTDB</span> <span class="o">|</span> <span class="n">awk</span> <span class="err">&#39;</span><span class="p">{</span>
<span class="k">if</span><span class="p">(</span><span class="err">$</span><span class="mi">1</span><span class="o">==</span><span class="s">&quot;Bufferpool&quot;</span> <span class="o">&amp;&amp;</span> <span class="err">$</span><span class="mi">2</span><span class="o">==</span><span class="s">&quot;name&quot;</span><span class="p">){</span><span class="n">print</span><span class="err">$</span><span class="mi">0</span><span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="n">index</span><span class="p">(</span><span class="err">$</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;cal reads&quot;</span><span class="p">)){</span><span class="n">print</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="err">$</span><span class="mi">0</span><span class="p">}</span>
<span class="p">}</span><span class="err">&#39;</span> <span class="o">|</span> <span class="n">grep</span> <span class="o">-</span><span class="n">v</span> <span class="n">temp</span>
</pre></div>


<p>6) event monitor</p>
<div class="hlcode"><pre>    <span class="o">--</span><span class="n">create</span> <span class="n">Event</span> <span class="n">Monitor</span> <span class="n">mymon1</span>
    <span class="n">db2</span> <span class="s">&quot;create event monitor mymon1 for database, tables, statements, DEADLOCKS, tablespaces, bufferpools, connections,transactions write to file &#39;/restore&#39;&quot;</span>
    <span class="o">--</span><span class="n">turn</span> <span class="n">on</span> <span class="n">Event</span> <span class="n">Monitor</span>
    <span class="n">db2</span> <span class="s">&quot;set event monitor mymon1 STATE=1&quot;</span>
    <span class="n">db2</span> <span class="s">&quot;select * from t&quot;</span>
    <span class="o">--</span><span class="n">turn</span> <span class="n">off</span> <span class="n">Event</span> <span class="n">Monitor</span>
    <span class="n">db2</span> <span class="s">&quot;set event monitor mymon1 STATE=0&quot;</span>
    <span class="o">--</span><span class="n">the</span> <span class="n">Event</span> <span class="n">Monitor</span> <span class="n">is</span> <span class="n">dropped</span>
    <span class="n">db2</span> <span class="s">&quot;drop event monitor mymon1&quot;</span>
    <span class="o">--</span><span class="n">analyze</span> <span class="n">with</span> <span class="n">command</span> <span class="n">db2evmon</span>
    <span class="n">db2evmon</span> <span class="o">-</span><span class="n">path</span> <span class="o">/</span><span class="n">restore</span>
</pre></div>


<div class="hlcode"><pre><span class="n">Check</span> <span class="n">Evnet</span> <span class="n">Monitor</span> <span class="n">State</span> <span class="o">:</span>
</pre></div>


<p>--the Function event_mon_state() can be used to check the monitor status, to see if it is active or inactive.<br />
    Example:<br />
    The following example selects all of the defined event monitors, and indicates whether each is active or inactive:</p>
<div class="hlcode"><pre>    <span class="n">db2</span> <span class="s">&quot;SELECT EVMONNAME,CASE WHEN EVENT_MON_STATE(EVMONNAME) = 0 THEN &#39;In-active&#39; WHEN EVENT_MON_STATE(EVMONNAME) = 1 THEN &#39;Active&#39; END FROM SYSCAT.EVENTMONITORS&quot;</span>
</pre></div>


<ol>
<li>How to diagnose high CPU<br />
  1) using db2pd to find out top 5 high CPU</li>
</ol>
<div class="hlcode"><pre>  <span class="n">db2pd</span> <span class="o">-</span><span class="n">edus</span> <span class="n">interval</span><span class="o">=</span><span class="mi">10</span> <span class="n">top</span><span class="o">=</span><span class="mi">5</span>
</pre></div>


<p>2) using the EDU ID to find out the application handle</p>
<div class="hlcode"><pre>  <span class="n">db2pd</span> <span class="o">-</span><span class="n">agents</span> <span class="n">EDU_ID</span>
</pre></div>


<p>3) db2 get snapshot for application agentid Appl.Handle<br />
    Some of the typical reasons why an application consumes a lot of CPU time are: frequent query compilation; too many sorts or large sorts; too many table scans.<br />
-- finding most sort SQL in dynamic SQL</p>
<div class="hlcode"><pre><span class="n">db2</span> <span class="s">&quot;select STMT_SORTS,SORTS_PER_EXECUTION,SUBSTR(STMT_TEXT,1,60) AS STMT_TEXT from sysibmadm.TOP_DYNAMIC_SQL order by STMT_SORTS desc fetch first 5 rows only&quot;</span>
</pre></div>


<p>--Query focused on CPU cycles using MON_GET_PKG_CACHE_STMT</p>
<div class="hlcode"><pre><span class="n">db2</span> <span class="s">&quot;</span>
<span class="n">WITH</span> <span class="n">SUM_TAB</span> <span class="p">(</span><span class="n">SUM_CPU</span><span class="p">)</span> <span class="n">AS</span> <span class="p">(</span>
        <span class="n">SELECT</span> <span class="n">FLOAT</span><span class="p">(</span><span class="n">SUM</span><span class="p">(</span><span class="n">TOTAL_CPU_TIME</span><span class="p">))</span>
        <span class="n">FROM</span> <span class="n">TABLE</span><span class="p">(</span><span class="n">MON_GET_PKG_CACHE_STMT</span> <span class="p">(</span> <span class="sc">&#39;D&#39;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">))</span> <span class="n">AS</span> <span class="n">T</span><span class="p">)</span>
<span class="n">SELECT</span>
        <span class="n">SUBSTR</span><span class="p">(</span><span class="n">STMT_TEXT</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">80</span><span class="p">)</span> <span class="n">AS</span> <span class="n">STATEMENT</span><span class="p">,</span>
        <span class="n">TOTAL_CPU_TIME</span><span class="p">,</span>
        <span class="n">DECIMAL</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="n">FLOAT</span><span class="p">(</span><span class="n">TOTAL_CPU_TIME</span><span class="p">)</span><span class="o">/</span><span class="n">SUM_TAB</span><span class="p">.</span><span class="n">SUM_CPU</span><span class="p">),</span><span class="mi">5</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="n">AS</span> <span class="n">PCT_TOT_CPU</span><span class="p">,</span>
        <span class="n">DECIMAL</span><span class="p">(</span><span class="n">FLOAT</span><span class="p">(</span><span class="n">TOTAL_CPU_TIME</span><span class="p">)</span><span class="o">/</span><span class="n">FLOAT</span><span class="p">(</span><span class="n">NUM_EXECUTIONS</span><span class="p">),</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="n">AS</span> <span class="n">AVG_CPU_TIME_PER_EXE</span><span class="p">,</span>
        <span class="n">NUM_EXECUTIONS</span>
    <span class="n">FROM</span> <span class="n">TABLE</span><span class="p">(</span><span class="n">MON_GET_PKG_CACHE_STMT</span> <span class="p">(</span> <span class="sc">&#39;D&#39;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">))</span> <span class="n">AS</span> <span class="n">T</span><span class="p">,</span> <span class="n">SUM_TAB</span>
    <span class="n">ORDER</span> <span class="n">BY</span> <span class="n">TOTAL_CPU_TIME</span> <span class="n">DESC</span> <span class="n">FETCH</span> <span class="n">FIRST</span> <span class="mi">5</span> <span class="n">ROWS</span> <span class="n">ONLY</span> <span class="n">WITH</span> <span class="n">UR</span>
<span class="s">&quot;</span>
</pre></div>


<ol>
<li>DIAGNOSING LOCK PROBLEMS<br />
  1) db2 list applications show detail<br />
    Focus on "status","status change time","Appl.Handle"<br />
    Status: A value of Lock-wait means the application is blocked by a lock held by a different application. Don’t be confused by a value of UOW Waiting, which  means that the application (unit of work) is in progress and not blocked by a lock. It is simply not doing any work at the moment.<br />
    Status change time: This is of particular interest for an application with Lock-wait status. The value shows when the lock wait began. Note that the UOW monitor switch must be on for the status change time to be reported.<br />
  2) if needed, force application handle</li>
</ol>
<div class="hlcode"><pre>    <span class="n">db2</span> <span class="n">force</span> <span class="n">application</span> <span class="p">(</span><span class="n">Appl</span><span class="p">.</span><span class="n">Handle</span><span class="p">,</span><span class="n">Appl</span><span class="p">.</span><span class="n">Handle</span><span class="p">)</span>
</pre></div>


<ol>
<li>Explain tool and Explain tables<br />
  1) create Explain table manually</li>
</ol>
<div class="hlcode"><pre>    <span class="p">[</span><span class="n">db2v97i</span><span class="err">@</span><span class="n">db2srv</span> <span class="n">NODE0000</span><span class="p">]</span><span class="err">$</span> <span class="n">find</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">ibm</span><span class="o">/</span><span class="n">db2</span><span class="o">/</span><span class="n">V10</span><span class="mf">.1</span><span class="n">_FP5</span><span class="o">/</span> <span class="o">-</span><span class="n">name</span> <span class="s">&quot;EXPLAIN*&quot;</span>
    <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">ibm</span><span class="o">/</span><span class="n">db2</span><span class="o">/</span><span class="n">V10</span><span class="mf">.1</span><span class="n">_FP5</span><span class="o">/</span><span class="n">misc</span><span class="o">/</span><span class="n">EXPLAIN</span><span class="p">.</span><span class="n">DDL</span>
    <span class="n">db2</span> <span class="o">-</span><span class="n">tvf</span> <span class="n">EXPLAIN</span><span class="p">.</span><span class="n">DDL</span>
</pre></div>


<p>2) Explain for query</p>
<div class="hlcode"><pre>    <span class="n">db2</span> <span class="n">explain</span> <span class="n">plan</span> <span class="n">with</span> <span class="n">snapshot</span> <span class="k">for</span> <span class="s">&quot;select * from t&quot;</span>
    <span class="nl">or:</span>
    <span class="n">db2</span> <span class="n">set</span> <span class="n">current</span> <span class="n">explain</span> <span class="n">mode</span> <span class="n">yes</span>
    <span class="n">db2</span> <span class="n">set</span> <span class="n">current</span> <span class="n">explain</span> <span class="n">snapshot</span> <span class="n">yes</span>
    <span class="n">query</span>
    <span class="o">--</span><span class="n">format</span> <span class="n">the</span> <span class="n">explain</span> <span class="n">table</span>
    <span class="n">db2exfmt</span>
</pre></div>


<ol>
<li>Design Advisor<br />
  1) Using below SQL to find out bad SQLs:</li>
</ol>
<div class="hlcode"><pre>  <span class="n">db2</span> <span class="s">&quot;SELECT</span>
<span class="p">(</span><span class="k">case</span>
<span class="n">when</span> <span class="n">num_executions</span> <span class="o">&gt;</span><span class="mi">0</span> <span class="n">then</span> <span class="p">(</span><span class="n">rows_read</span> <span class="o">/</span> <span class="n">num_executions</span><span class="p">)</span>
<span class="k">else</span> <span class="mi">0</span>
<span class="n">end</span><span class="p">)</span> <span class="n">as</span> <span class="n">avg_rows_read</span><span class="p">,</span>
<span class="p">(</span><span class="k">case</span>
<span class="n">when</span> <span class="n">num_executions</span> <span class="o">&gt;</span><span class="mi">0</span> <span class="n">then</span> <span class="p">(</span><span class="n">rows_written</span> <span class="o">/</span> <span class="n">num_executions</span><span class="p">)</span>
<span class="k">else</span> <span class="mi">0</span>
<span class="n">end</span><span class="p">)</span> <span class="n">as</span> <span class="n">avg_rows_written</span><span class="p">,</span>
<span class="p">(</span><span class="k">case</span>
<span class="n">when</span> <span class="n">num_executions</span> <span class="o">&gt;</span><span class="mi">0</span> <span class="n">then</span> <span class="p">(</span><span class="n">stmt_sorts</span> <span class="o">/</span> <span class="n">num_executions</span><span class="p">)</span>
<span class="k">else</span> <span class="mi">0</span>
<span class="n">end</span><span class="p">)</span> <span class="n">as</span> <span class="n">avg_sorts</span><span class="p">,</span>
<span class="p">(</span><span class="k">case</span>
<span class="n">when</span> <span class="n">num_executions</span> <span class="o">&gt;</span><span class="mi">0</span> <span class="n">then</span> <span class="p">(</span><span class="n">total_exec_time</span> <span class="o">/</span> <span class="n">num_executions</span><span class="p">)</span>
<span class="k">else</span> <span class="mi">0</span>
<span class="n">end</span><span class="p">)</span> <span class="n">as</span> <span class="n">avg_exec_time</span><span class="p">,</span>
<span class="n">substr</span><span class="p">(</span><span class="n">stmt_text</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">200</span><span class="p">)</span> <span class="n">as</span> <span class="n">SQL_Stmt</span>
<span class="n">FROM</span> <span class="n">table</span> <span class="p">(</span><span class="n">snapshot_dyn_sql</span> <span class="p">(</span><span class="err">&#39;</span><span class="n">DB_NAME</span><span class="err">&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span> <span class="n">as</span> <span class="n">snapshot_dyn_sql</span> <span class="s">&quot;</span>
</pre></div>


<p>2) extract the statement text from the output above, and put it into the file bad.sql<br />
  3) db2advis -d DB_NAME -i bad.sql</p>
<ol>
<li>snapshot_ tables<br />
  Snapshot_ table functions: return information from a snapshot, these snapshot can be :<br />
  1) SNAPSHOT_AGENT: Deprecated and replaced by SNAP_GET_AGENT.Returns information about agents from an application snapshot.<br />
  2) SNAPSHOT_APPL: Deprecated and replaced by SNAP_GET_APPL.Returns general information from an application snapshot.<br />
  3) SNAPSHOT_APPL_INFO: Deprecated and replaced by SNAP_GET_APPL_INFO.Returns general information from an application snapshot.<br />
  4) SNAPSHOT_BP: Deprecated and replaced by SNAP_GET_BP.Returns information from a buffer pool snapshot.<br />
  5) SNAPSHOT_CONTAINER: Deprecated and replaced by SNAP_GET_CONTAINER.Returns container configuration information from a table space snapshot.<br />
  6) SNAPSHOT_DATABASE: Deprecated and replaced by SNAP_GET_DB.Returns information from a database snapshot.<br />
  7) SNAPSHOT_DBM: Deprecated and replaced by  SNAP_GET_DBM.Returns information from a snapshot of the DB2® database manager.<br />
  8) SNAPSHOT_DYN_SQL: Deprecated and replaced by SNAP_GET_DYN_SQL.<br />
  9) SNAPSHOT_LOCK: Deprecated and replaced by MON_GET_APPL_LOCKWAIT table function, MON_GET_LOCKS table function, and MON_FORMAT_LOCK_NAME table function.<br />
  10) SNAPSHOT_LOCKWAIT: Deprecated and replaced by MON_GET_APPL_LOCKWAIT table function, MON_GET_LOCKS table function, and MON_FORMAT_LOCK_NAME table function.<br />
  11) SNAPSHOT_STATEMENT: Deprecated and replaced by SNAP_GET_STMT.<br />
  12) SNAPSHOT_TABLE: Deprecated and replaced by SNAP_GET_TAB.<br />
  13) SNAPSHOT_TBREORG: Deprecated and replaced by SNAP_GET_TAB_REORG.Retrieve table reorganization snapshot information.<br />
  14) SNAPSHOT_TBS: Deprecated and replaced by SNAP_GET_TBSP.<br />
  15) SNAPSHOT_TBS_CFG: Deprecated and replaced by SNAP_GET_TBSP_PART.<br />
  Usages:</li>
</ol>
<div class="hlcode"><pre>    <span class="n">db2</span> <span class="s">&quot;select * from table(snapshot_tbs(&#39;mysample&#39;,-1)) as snapshot_*&quot;</span>
    <span class="o">--</span><span class="n">mysample</span> <span class="n">means</span> <span class="n">DB_NAME</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="n">means</span> <span class="n">current</span> <span class="n">database</span> <span class="n">member</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span> <span class="n">means</span> <span class="n">all</span> <span class="n">active</span> <span class="n">database</span> <span class="n">members</span><span class="p">.</span>
</pre></div>


<ol>
<li>snapshot views<br />
Function map elements from sections of get snapshot reports:</li>
</ol>
<table>
<thead>
<tr>
<th>snapshot report</th>
<th>table function</th>
<th>views</th>
</tr>
</thead>
<tbody>
<tr>
<td>Application</td>
<td>snap_get_agent</td>
<td>snapagent</td>
</tr>
<tr>
<td></td>
<td>SNAP_GET_AGENT_MEMORY_POOL</td>
<td>snapagent_memory_pool</td>
</tr>
<tr>
<td></td>
<td>snap_get_appl</td>
<td>snapappl</td>
</tr>
<tr>
<td></td>
<td>SNAP_GET_APPL_INFO</td>
<td>snapappl_info</td>
</tr>
<tr>
<td></td>
<td>snap_get_stmt</td>
<td>snapstmt</td>
</tr>
<tr>
<td></td>
<td>snap_get_subsection</td>
<td>snapsubsection</td>
</tr>
<tr>
<td></td>
<td>snap_get_lockwait</td>
<td>snaplockwait</td>
</tr>
<tr>
<td>Buffer pool</td>
<td>snap_get_bp</td>
<td>snapbp</td>
</tr>
<tr>
<td></td>
<td>snap_get_bp_part</td>
<td>snapbp_part</td>
</tr>
<tr>
<td>Locks</td>
<td>snap_get_lock</td>
<td>snaplock</td>
</tr>
<tr>
<td>Tables</td>
<td>snap_get_tab_v91</td>
<td>snaptab</td>
</tr>
<tr>
<td></td>
<td>snap_get_tab_reorg</td>
<td>snaptab_reorg</td>
</tr>
<tr>
<td>Dynamic SQL</td>
<td>snap_get_dyn_sql_v91</td>
<td>snapdyn_sql</td>
</tr>
<tr>
<td>Database</td>
<td>snap_get_db_v91</td>
<td>snapdb</td>
</tr>
<tr>
<td></td>
<td>snap_get_detaillog_v91</td>
<td>snapdetaillog</td>
</tr>
<tr>
<td></td>
<td>snap_get_db_memory_pool</td>
<td>snapdb_memory_pool</td>
</tr>
<tr>
<td></td>
<td>snap_get_hadr</td>
<td>snaphadr</td>
</tr>
<tr>
<td></td>
<td>snap_get_storage_paths</td>
<td>snapstorage_paths</td>
</tr>
<tr>
<td>Tablespace</td>
<td>snap_get_tbsp_v91</td>
<td>snaptbsp</td>
</tr>
<tr>
<td></td>
<td>snap_get_tbsp_part_v91</td>
<td>snaptbsp_part</td>
</tr>
<tr>
<td></td>
<td>snap_get_container_v91</td>
<td>snapcontainer</td>
</tr>
<tr>
<td></td>
<td>snap_get_tbsp_quiescer</td>
<td>snaptbsp_quiescer</td>
</tr>
<tr>
<td></td>
<td>snap_get_tbsp_range</td>
<td>snaptbsp_range</td>
</tr>
<tr>
<td>DBM</td>
<td>snap_get_dbm</td>
<td>snapdbm</td>
</tr>
<tr>
<td></td>
<td>snap_get_dbm_memory_pool</td>
<td>snapdbm_memory_pool</td>
</tr>
<tr>
<td></td>
<td>snap_get_fcm</td>
<td>snapfcm</td>
</tr>
<tr>
<td></td>
<td>snap_get_fcm_part</td>
<td>snapfcm_part</td>
</tr>
<tr>
<td></td>
<td>snap_get_switches</td>
<td>snapswitches</td>
</tr>
</tbody>
</table>
<h2 id="db2-utilities">DB2 utilities</h2>
<ol>
<li>load query--finding table status<br />
load query used to obtain the table state.</li>
</ol>
<div class="hlcode"><pre><span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="n">load</span> <span class="n">query</span> <span class="n">table</span> <span class="n">t</span>
<span class="nl">Tablestate:</span>
  <span class="n">Normal</span>
</pre></div>


<ol>
<li>list utilities<br />
This command display the list of active utilities on the instance:</li>
</ol>
<div class="hlcode"><pre><span class="n">db2</span> <span class="n">list</span> <span class="n">utilities</span> <span class="n">show</span> <span class="n">detail</span>
</pre></div>


<ol>
<li>db2relocatedb<br />
db2 set write suspend for database<br />
This utility renames a database or relocates a database in a parameter file, you can alter the following properties of a database:<br />
1) the database name<br />
2) the instance belongs to<br />
3) the database directory<br />
4) the database partition number<br />
5) the log directory<br />
6) the location of table space containers</li>
</ol>
<p>db2relocatedb -f param.file<br />
param.file内容如下：</p>
<div class="hlcode"><pre><span class="n">DB_NAME</span><span class="o">=</span><span class="n">oldName</span><span class="p">,</span><span class="n">newName</span>
<span class="n">DB_PATH</span><span class="o">=</span><span class="n">oldName</span><span class="p">,</span><span class="n">newName</span>
<span class="n">INSTANCE</span><span class="o">=</span><span class="n">oldInst</span><span class="p">,</span><span class="n">newInst</span>
<span class="n">NODENUM</span><span class="o">=</span><span class="n">nodeNumber</span>
<span class="n">LOG_DIR</span><span class="o">=</span><span class="n">oldDirPath</span><span class="p">,</span><span class="n">newDirPath</span>
<span class="n">CONT_PATH</span><span class="o">=</span><span class="n">oldContPath</span><span class="p">,</span><span class="n">newContPath</span>
</pre></div>


<p>example:<br />
A. Change db name(database SAMPLE1 belongs to db2inst1, and the db path is under the /home/db2inst1, just change the db name from SAMPLE1 to SAMPLE)</p>
<div class="hlcode"><pre><span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="n">list</span> <span class="n">db</span> <span class="n">directory</span><span class="o">|</span><span class="n">grep</span> <span class="o">-</span><span class="n">i</span> <span class="n">sample</span> <span class="o">-</span><span class="n">A</span> <span class="mi">1</span>
 <span class="n">Database</span> <span class="n">alias</span>                       <span class="o">=</span> <span class="n">SAMPLE1</span>
 <span class="n">Database</span> <span class="n">name</span>                        <span class="o">=</span> <span class="n">SAMPLE1</span>
 <span class="n">Local</span> <span class="n">database</span> <span class="n">directory</span>             <span class="o">=</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">db2inst1</span>
<span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">cat</span> <span class="n">relocate</span><span class="p">.</span><span class="n">txt</span>
<span class="n">DB_NAME</span><span class="o">=</span><span class="n">sample1</span><span class="p">,</span><span class="n">sample</span>
<span class="n">DB_PATH</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="n">db2inst1</span>
<span class="n">INSTANCE</span><span class="o">=</span><span class="n">db2inst1</span>
<span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">db2relocatedb</span> <span class="o">-</span><span class="n">f</span> <span class="n">relocate</span><span class="p">.</span><span class="n">txt</span>
<span class="n">Files</span> <span class="n">and</span> <span class="n">control</span> <span class="n">structures</span> <span class="n">were</span> <span class="n">changed</span> <span class="n">successfully</span><span class="p">.</span>
<span class="n">Database</span> <span class="n">was</span> <span class="n">catalogued</span> <span class="n">successfully</span><span class="p">.</span>
<span class="n">DBT1000I</span>  <span class="n">The</span> <span class="n">tool</span> <span class="n">completed</span> <span class="n">successfully</span><span class="p">.</span>
<span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span>  <span class="n">db2</span> <span class="n">list</span> <span class="n">db</span> <span class="n">directory</span><span class="o">|</span><span class="n">grep</span> <span class="o">-</span><span class="n">i</span> <span class="n">sample</span> <span class="o">-</span><span class="n">A</span> <span class="mi">1</span>
 <span class="n">Database</span> <span class="n">alias</span>                       <span class="o">=</span> <span class="n">SAMPLE</span>
 <span class="n">Database</span> <span class="n">name</span>                        <span class="o">=</span> <span class="n">SAMPLE</span>
 <span class="n">Local</span> <span class="n">database</span> <span class="n">directory</span>             <span class="o">=</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">db2inst1</span>
</pre></div>


<p>B. To move the testdb database from the instance db2inst1 on path /db2/data to db2inst2 on the same path, do the following:<br />
a) Move the all the files in /db2/data/db2inst1 to /db2/data/db2inst2<br />
b) Edit the relocate parameter file</p>
<div class="hlcode"><pre><span class="n">DB_NAME</span><span class="o">=</span><span class="n">SAMPLE</span>
<span class="n">DB_PATH</span><span class="o">=/</span><span class="n">db2</span><span class="o">/</span><span class="n">data</span>
<span class="n">INSTANCE</span><span class="o">=</span><span class="n">db2inst1</span><span class="p">,</span> <span class="n">dn2inst2</span>
</pre></div>


<ol>
<li>
<p>db2look<br />
db2look extracts DDL of database objects, beside that, the tool can also generate the following:<br />
1) UPDATE statistics statements<br />
2) DCL, such as GRANT, REVOKE<br />
3) UPDATE command for DBM configuration</p>
</li>
<li>
<p>runstats<br />
The RUNSTATS utility updates statistics about the physical characteristics of a table and the associated indexes.Characteristics include the number of records (cardinality), the number of pages, the average record length, and so on.</p>
</li>
<li>
<p>reorg and reorgchk<br />
  runstats=&gt;reorgchk=&gt;reorg=&gt;runstats=&gt;rebind<br />
  1) offline reorg (default)<br />
  2) online (inplace) reorg</p>
</li>
</ol>
<p>only for needed no index:</p>
<div class="hlcode"><pre><span class="n">db2</span> <span class="o">-</span><span class="n">x</span> <span class="s">&quot;call sysproc.REORGCHK_TB_STATS(&#39;T&#39;,&#39;ALL&#39;)&quot;</span><span class="o">|</span><span class="n">grep</span> <span class="s">&quot;\*&quot;</span><span class="o">|</span><span class="n">awk</span> <span class="err">&#39;</span><span class="p">{</span><span class="n">print</span> <span class="s">&quot;REORG TABLE &quot;</span><span class="err">$</span><span class="mi">1</span><span class="s">&quot;.&quot;</span><span class="err">$</span><span class="mi">2</span><span class="s">&quot;;&quot;</span><span class="p">;</span><span class="n">print</span> <span class="s">&quot;RUNSTATS on table &quot;</span><span class="err">$</span><span class="mi">1</span><span class="s">&quot;.&quot;</span><span class="err">$</span><span class="mi">2</span><span class="s">&quot; and indexes all&quot;&quot;;&quot;</span><span class="p">}</span><span class="err">&#39;</span> <span class="o">&gt;</span> <span class="n">reorg_runstat</span><span class="p">.</span><span class="n">ddl</span>

<span class="n">db2</span> <span class="o">-</span><span class="n">v</span> <span class="s">&quot;reorgchk current statistics on table all&quot;</span> <span class="o">|</span><span class="n">grep</span> <span class="o">-</span><span class="n">v</span> <span class="s">&quot;SYSIBM&quot;</span> <span class="o">|</span><span class="n">grep</span> <span class="o">-</span><span class="n">v</span> <span class="s">&quot;SYSCAT&quot;</span> <span class="o">|</span><span class="n">grep</span> <span class="o">-</span><span class="n">v</span> <span class="s">&quot;SYSSTAT&quot;</span> <span class="o">|</span><span class="n">grep</span> <span class="o">-</span><span class="n">v</span> <span class="s">&quot;SYSTOOLS&quot;</span><span class="o">&gt;&gt;</span><span class="n">db2reorgchk</span><span class="mf">.20160417</span>
</pre></div>


<ol>
<li>db2pd<br />
The tool collects information without acquiring any latches or using any engine resources.It is therefore possible (and expected) to retrieve information that is changing while db2pd is collecting information; hence the data might not be completely accurate.<br />
  1) Find the wait locks</li>
</ol>
<div class="hlcode"><pre>    <span class="n">db2pd</span> <span class="o">-</span><span class="n">d</span> <span class="n">DB_NAME</span> <span class="o">-</span><span class="n">wlocks</span>
    <span class="n">db2pd</span> <span class="o">-</span><span class="n">d</span> <span class="n">DB_NAME</span> <span class="o">-</span><span class="n">apinfo</span> <span class="n">APPHandle</span>
    <span class="n">db2pd</span> <span class="o">-</span><span class="n">d</span> <span class="n">DB_NAME</span> <span class="o">-</span><span class="n">locks</span> <span class="o">-</span><span class="n">transactions</span> <span class="o">-</span><span class="n">applications</span> <span class="o">-</span><span class="n">dynamic</span>

    <span class="n">SELECT</span> <span class="n">SUBSTR</span><span class="p">(</span><span class="n">TABSCHEMA</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span> <span class="n">AS</span> <span class="n">TABSCHEMA</span><span class="p">,</span>
    <span class="n">SUBSTR</span><span class="p">(</span><span class="n">TABNAME</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">15</span><span class="p">)</span> <span class="n">AS</span> <span class="n">TABNAME</span><span class="p">,</span>
    <span class="n">LOCK_OBJECT_TYPE</span><span class="p">,</span> <span class="n">LOCK_MODE</span><span class="p">,</span> <span class="n">LOCK_MODE_REQUESTED</span><span class="p">,</span>
    <span class="n">AGENT_ID_HOLDING_LK</span>
    <span class="n">FROM</span> <span class="n">SYSIBMADM</span><span class="p">.</span><span class="n">LOCKWAITS</span>
</pre></div>


<p>2) Monitoring memory Usage</p>
<div class="hlcode"><pre>    <span class="n">db2pd</span> <span class="o">-</span><span class="n">memblock</span>
    <span class="n">db2pd</span> <span class="o">-</span><span class="n">memb</span> <span class="n">pid</span><span class="o">=</span>
</pre></div>


<p>3) tablesapce</p>
<div class="hlcode"><pre>    <span class="n">db2pd</span> <span class="o">-</span><span class="n">d</span> <span class="n">DB_NAME</span> <span class="o">-</span><span class="n">tcbstats</span>
    <span class="n">db2pd</span> <span class="o">-</span><span class="n">d</span> <span class="n">DB_NAME</span> <span class="o">-</span><span class="n">tablespaces</span>
</pre></div>


<p>4) dynamic SQL</p>
<div class="hlcode"><pre>    <span class="n">db2pd</span> <span class="o">-</span><span class="n">d</span> <span class="n">DB_NAME</span> <span class="o">-</span><span class="n">dyn</span>
</pre></div>


<p>5) agent</p>
<div class="hlcode"><pre>    <span class="n">db2pd</span> <span class="o">-</span><span class="n">agent</span>
</pre></div>


<p>6) monitoring recovery</p>
<div class="hlcode"><pre>    <span class="n">db2pd</span> <span class="o">-</span><span class="n">d</span> <span class="n">DB_NAME</span> <span class="o">-</span><span class="n">recovery</span>
</pre></div>


<p>7) Determining the amount of resources a transaction is using</p>
<div class="hlcode"><pre>    <span class="n">db2pd</span> <span class="o">-</span><span class="n">d</span> <span class="n">DB_NAME</span> <span class="n">transactions</span>
</pre></div>


<p>8) monitoring log Usage</p>
<div class="hlcode"><pre>    <span class="n">db2pd</span> <span class="o">-</span><span class="n">d</span> <span class="n">DB_NAME</span> <span class="o">-</span><span class="n">logs</span>
</pre></div>


<p>9) Monitoring the progress of index reorganization</p>
<div class="hlcode"><pre>    <span class="n">db2pd</span> <span class="o">-</span><span class="n">d</span> <span class="n">mysample</span> <span class="o">-</span><span class="n">reorgs</span> <span class="n">index</span>
</pre></div>


<p>10)  Displaying the top EDUs by processor time consumption and displaying EDU stack information</p>
<div class="hlcode"><pre>    <span class="n">db2pd</span> <span class="o">-</span><span class="n">edus</span> <span class="n">interval</span><span class="o">=</span><span class="mi">5</span> <span class="n">top</span><span class="o">=</span><span class="mi">5</span>
</pre></div>


<p>11) monitoring runstats</p>
<div class="hlcode"><pre>    <span class="n">db2pd</span> <span class="o">-</span><span class="n">d</span> <span class="n">DB_NAME</span> <span class="n">runstats</span>
</pre></div>


<p>12) db2pd -d mysample -dbcfg</p>
<p>13) restart the tsm vendor process:</p>
<div class="hlcode"><pre>  <span class="n">db2pd</span> <span class="o">-</span><span class="n">d</span> <span class="n">db_name</span> <span class="o">-</span><span class="n">fvp</span> <span class="n">LOGARCHMETH1</span> <span class="n">term</span>
</pre></div>


<h2 id="generate-duplicate-database-ddl-by-using-db2look">generate duplicate database DDL by using db2look</h2>
<div class="hlcode"><pre>  <span class="n">db2look</span> <span class="o">-</span><span class="n">d</span> <span class="n">mysample</span> <span class="o">-</span><span class="n">a</span> <span class="o">-</span><span class="n">e</span> <span class="o">-</span><span class="n">m</span> <span class="o">-</span><span class="n">l</span> <span class="o">-</span><span class="n">x</span> <span class="o">-</span><span class="n">f</span> <span class="o">-</span><span class="n">o</span> <span class="n">mysample</span><span class="p">.</span><span class="n">sql</span>
  <span class="o">--</span><span class="n">edit</span> <span class="n">output</span> <span class="n">file</span><span class="p">,</span> <span class="n">modify</span> <span class="n">database</span> <span class="n">names</span><span class="p">,</span> <span class="n">container</span> <span class="n">path</span><span class="p">,</span> <span class="n">and</span> <span class="n">adjust</span> <span class="n">the</span> <span class="n">tbs</span> <span class="n">size</span>
</pre></div>


<h2 id="data-movement">Data movement</h2>
<p>--duplicate table data</p>
<div class="hlcode"><pre><span class="n">db2</span> <span class="s">&quot;create table t1 like t&quot;</span>
<span class="n">db2</span> <span class="s">&quot;insert into t1 select * from t&quot;</span>
</pre></div>


<p>IXF formatted file contains tables and indexes defination, but not contains constraint violation check defination<br />
1. export import --essentially, export/import just a set of SQL, INSERT,UPDATE OR DELETE, so it may generate lots of logs<br />
  --export table to ixf format</p>
<div class="hlcode"><pre>  <span class="n">db2</span> <span class="s">&quot;export to t1.ixf of ixf messages export.out select * from t1 &quot;</span>
</pre></div>


<p>--import from an ixf format file</p>
<div class="hlcode"><pre>  <span class="n">db2</span> <span class="s">&quot;import from t1.ixf of ixf messages import.out replace_create into t2&quot;</span>
</pre></div>


<p>there are 5 methods to import into a table: INSERT,INSERT_UPDATE,REPLACE, above 3 methods only can be used when target table exist. The last 2 are: REPLACE_CREATE and CREATE, can be used when table target table not exist.<br />
  1) INSERT:   only append data to target table, do not change any data in the target table.<br />
  2) INSERT_UPDATE:  insert data into target table, but when the data confilct with target table, will update the data. Only use when the target table have PK constraint.<br />
  3) REPLACE: delete exsist data and insert new one.<br />
  4) REPLACE_CREATE: like REPLACE, delete exsist data, if target table or index do not exsist, then create it.<br />
  5) CREATE: create target table or index, can specify new tablespaces</p>
<p>some parameters within import utilities need to pay attention to:<br />
  1) Access method<br />
    when loading data from a file by using import, you can specify whether the target table can be accessed or not when the import is in progress<br />
    ALLOW NO ACCESS: will lock target table with X lock, so other application cannot access this table while import happened.<br />
    ALLOW WRITE ACCESS:<br />
  2) COMMITCOUNT  n<br />
    every import n records will commit.<br />
  3) RESTARTCOUNT n<br />
    when import failed, you can specify from which record to continue. For example, if you were importing 500 records table while import terminated by accident and still imported 400 records, you can using RESTARTCOUNT 401, and import can be continue starts from the 401  record.</p>
<ol>
<li>
<p>load--load skip trigger and log mechanism, it load formatted data into database directly, so it's more efficiency then export/import<br />
  The load process can be divided into 4 parts: LOAD, BUILD, DELETE, INDEX COPY:<br />
  1) LOAD<br />
    during LOAD phase, data is loaded into table, index keys and table statistics are collected<br />
  2) BUILD<br />
    during BUILD phase, indexes are produced based on the index keys collected during LOAD phase. The index keys are sorted during the LOAD phase, and index statistics are collected. The statistics are similar to those collected through the RUNSTATS command<br />
  3) DELETE<br />
    druing the DELETE phase, the rows data that caused a unique or primary key violation are removed from the table, the deleted rows are stored in the load exception table, if one was specified.<br />
  4) INDEX COPY<br />
    during the INDEX COPY phase, the index data is copied from a system temporary tablespace to original tablespace, this will only occur if a system temp tablespace was specified for index creation during load operation with the read access option specified.<br />
  When loading data, the following information must be required:<br />
  1) the path and the input file name<br />
  2) the name of target table<br />
  3) the format of input source, like IXF, ASC, DEL<br />
  4) whether the input data is to be appended to the table or replace the data<br />
  Load methods:<br />
  1) INSERT: just append data into target table without any changing to the exsiting data<br />
  2) REPLACE: deletes exsiting data from the table and populcates it with input data<br />
  3) RESTART: when an interruptted occur, in most case, the load utility can resume from the phase it failed in<br />
  4) TERMINATE: a failed load operation is rolled back<br />
  Monitoring load process<br />
  1) db2 list utilities<br />
  2) db2 load query table schema_name.table_name</p>
</li>
<li>
<p>db2move--have 3 modes, EXPORT,IMPORT,LOAD and COPY, COPY mode is for duplication of schema. Only extract data, not DDL.<br />
The tool queries the system catalog tables for a particular database and compiles a list of all user tables. It then exports these tables in PC/IXF format. The PC/IXF files can be imported or loaded to another local DB2 database on the same system, or can be transferred to another workstation platform and imported or loaded to a DB2 database on that platform. Tables with structured type columns are not moved when this tool is used.<br />
  1) Command syntax: action must be EXPORT, IMPORT, LOAD OR COPY.</p>
</li>
</ol>
<div class="hlcode"><pre>                                <span class="p">.</span><span class="o">----------------------------</span><span class="p">.</span>
                            <span class="n">V</span>                            <span class="o">|</span>
<span class="o">&gt;&gt;-</span><span class="n">db2move</span><span class="o">--</span><span class="n">dbname</span><span class="o">--</span><span class="n">action</span><span class="o">----+------------------------+-+-----&gt;&lt;</span>
                              <span class="o">+-</span> <span class="o">-</span><span class="n">tc</span><span class="o">--</span><span class="n">table</span><span class="o">-</span><span class="n">definers</span><span class="o">---+</span>
                              <span class="o">+-</span> <span class="o">-</span><span class="n">tn</span><span class="o">--</span><span class="n">table</span><span class="o">-</span><span class="n">names</span><span class="o">------+</span>
                              <span class="o">+-</span> <span class="o">-</span><span class="n">sn</span><span class="o">--</span><span class="n">schema</span><span class="o">-</span><span class="n">names</span><span class="o">-----+</span>
                              <span class="o">+-</span> <span class="o">-</span><span class="n">ts</span><span class="o">--</span><span class="n">tablespace</span><span class="o">-</span><span class="n">names</span><span class="o">-+</span>
                              <span class="o">+-</span> <span class="o">-</span><span class="n">tf</span><span class="o">--</span><span class="n">filename</span><span class="o">---------+</span>
                              <span class="o">+-</span> <span class="o">-</span><span class="n">io</span><span class="o">--</span><span class="n">import</span><span class="o">-</span><span class="n">option</span><span class="o">----+</span>
                              <span class="o">+-</span> <span class="o">-</span><span class="n">lo</span><span class="o">--</span><span class="n">load</span><span class="o">-</span><span class="n">option</span><span class="o">------+</span>
                              <span class="o">+-</span> <span class="o">-</span><span class="n">co</span><span class="o">--</span><span class="n">copy</span><span class="o">-</span><span class="n">option</span><span class="o">------+</span>
                              <span class="o">+-</span> <span class="o">-</span><span class="n">l</span><span class="o">--</span><span class="n">lobpaths</span><span class="o">----------+</span>
                              <span class="o">+-</span> <span class="o">-</span><span class="n">u</span><span class="o">--</span><span class="n">userid</span><span class="o">------------+</span>
                              <span class="o">+-</span> <span class="o">-</span><span class="n">p</span><span class="o">--</span><span class="n">password</span><span class="o">----------+</span>
                              <span class="err">&#39;</span><span class="o">-</span> <span class="o">-</span><span class="n">aw</span><span class="o">-------------------</span><span class="err">&#39;</span> <span class="o">--</span><span class="n">allow</span> <span class="n">waring</span>
</pre></div>


<p>2) Examples<br />
    --export all tables in the MYSAMPLE database, be careful, when default options is used, this command can generate lots of files under the current folder.</p>
<div class="hlcode"><pre>    <span class="n">db2move</span> <span class="n">mysample</span> <span class="n">export</span>
    <span class="o">--</span><span class="n">load</span><span class="o">/</span><span class="n">import</span> <span class="n">all</span> <span class="n">tables</span> <span class="n">in</span> <span class="n">the</span> <span class="n">mysample</span> <span class="n">database</span><span class="p">,</span> <span class="n">lobpath</span> <span class="n">and</span> <span class="o">/</span><span class="n">tmp</span> <span class="n">are</span> <span class="n">used</span> <span class="k">for</span> <span class="n">search</span> <span class="n">LOB</span> <span class="n">objects</span>
    <span class="n">db2move</span> <span class="n">mysample</span> <span class="n">load</span><span class="o">/</span><span class="n">import</span> <span class="o">-</span><span class="n">l</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">db2v97i</span><span class="o">/</span><span class="n">lobpath</span><span class="p">,</span><span class="o">/</span><span class="n">tmp</span>
    <span class="o">--</span><span class="n">duplicate</span> <span class="n">schema</span> <span class="n">db2v97i</span> <span class="n">to</span> <span class="n">fungkong</span>
    <span class="n">db2move</span> <span class="n">mysample</span> <span class="n">copy</span> <span class="o">-</span><span class="n">sn</span> <span class="n">db2v97i</span> <span class="o">-</span><span class="n">co</span> <span class="n">target_db</span> <span class="n">sample</span> <span class="n">USER</span> <span class="n">myuser1</span> <span class="n">using</span> <span class="n">mypass1</span> <span class="n">SCHEMA_MAP</span> <span class="err">\</span><span class="p">(</span><span class="err">\</span><span class="p">(</span><span class="n">db2v97i</span><span class="p">,</span><span class="n">fungkong</span><span class="err">\</span><span class="p">)</span><span class="err">\</span><span class="p">)</span> <span class="n">TABLESPACE_MAP</span> <span class="p">((</span><span class="n">ts1</span><span class="p">,</span><span class="n">ts2</span><span class="p">),</span> <span class="n">SYS_ANY</span><span class="p">))</span>
</pre></div>


<ol>
<li>db2look--extract DDL<br />
  db2look extracts DDL of database objects, beside that, the tool can also generate the following:<br />
  1) UPDATE statistics statements<br />
  2) DCL, such as GRANT, REVOKE<br />
  3) UPDATE command for DBM configuration</li>
</ol>
<div class="hlcode"><pre>  <span class="n">db2look</span> <span class="o">-</span><span class="n">d</span> <span class="n">mysample</span> <span class="o">-</span><span class="n">e</span> <span class="o">-</span><span class="n">a</span> <span class="o">-</span><span class="n">o</span> <span class="n">db2look_mysample</span><span class="p">.</span><span class="n">sql</span>
</pre></div>


<ol>
<li>heterogeneous migration of db2 by using db2move and db2look<br />
  1) export all tables in the source db</li>
</ol>
<div class="hlcode"><pre>    <span class="n">db2move</span> <span class="n">source_db_name</span> <span class="n">export</span>
</pre></div>


<p>2) extracts all DDL from source db</p>
<div class="hlcode"><pre>    <span class="n">db2look</span> <span class="o">-</span><span class="n">d</span> <span class="n">source_db_name</span> <span class="o">-</span><span class="n">e</span> <span class="o">-</span><span class="n">a</span> <span class="o">-</span><span class="n">o</span> <span class="n">db2look_mysample</span><span class="p">.</span><span class="n">sql</span>
</pre></div>


<p>3) transfer all the files that generated by db2move, involving all *.ixf files, db2move.lst and db2look generated files<br />
  4) create target db in the target server</p>
<div class="hlcode"><pre>    <span class="n">db2</span> <span class="n">create</span> <span class="n">db</span> <span class="n">target_db_name</span>
</pre></div>


<p>5) create objects defination by using db2look generated file</p>
<div class="hlcode"><pre>    <span class="n">db2</span> <span class="n">connect</span> <span class="n">to</span> <span class="n">target_db_name</span>
    <span class="n">db2</span> <span class="o">-</span><span class="n">tvf</span> <span class="n">db2look_mysample</span><span class="p">.</span><span class="n">sql</span>
</pre></div>


<p>6) load the data into target db</p>
<div class="hlcode"><pre>    <span class="n">db2move</span> <span class="n">target_db_name</span> <span class="n">load</span>
</pre></div>


<p>7) constraints violation check</p>
<div class="hlcode"><pre>    <span class="n">db2</span> <span class="n">connect</span> <span class="n">to</span> <span class="n">target_db_name</span>
    <span class="n">db2</span> <span class="n">set</span> <span class="n">integrity</span> <span class="k">for</span> <span class="n">schema</span><span class="p">.</span><span class="n">table</span> <span class="n">immediate</span> <span class="n">checked</span>
</pre></div>


<h3 id="find-the-special-build-version-of-db2-source-code">find the special build version of db2 source code</h3>
<div class="hlcode"><pre><span class="n">cd</span> <span class="err">$</span><span class="n">CODEDIR</span><span class="o">/</span><span class="p">.</span><span class="n">metadata</span><span class="o">/</span><span class="n">BASE_CLIENT_R</span><span class="o">/</span>
<span class="n">cat</span> <span class="n">spec</span>
<span class="err">$</span> <span class="n">ccat</span> <span class="n">spec</span>
<span class="n">arch</span><span class="o">=</span><span class="n">x86_64</span>
<span class="n">baseptf</span><span class="o">=</span><span class="n">IP23657</span>
<span class="n">bldlevel</span><span class="o">=</span><span class="mi">20141015</span>
<span class="n">ext_buildlevel</span><span class="o">=</span><span class="n">s141015</span>
<span class="n">fixpack</span><span class="o">=</span><span class="mi">10</span>
<span class="n">interim</span><span class="o">=</span>
<span class="n">minimum_version</span><span class="o">=</span><span class="mf">9.7.0.0</span>
<span class="n">os</span><span class="o">=</span><span class="n">Linux</span>
<span class="n">ptf</span><span class="o">=</span><span class="n">IP23657</span>
<span class="n">sb</span><span class="o">=</span><span class="mi">0</span>
<span class="n">specialbuild</span><span class="o">=</span>
<span class="n">vrmf</span><span class="o">=</span><span class="mf">9.7.0.10</span>
</pre></div>


<h3 id="db2updv97-sqlcode-912">db2updv97: sqlcode -912</h3>
<div class="hlcode"><pre><span class="nl">error:</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">ibm</span><span class="o">/</span><span class="n">db2</span><span class="o">/</span><span class="n">V9</span><span class="mf">.7</span><span class="n">_FP11_SB_35317</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">db2updv97</span> <span class="o">-</span><span class="n">d</span> <span class="n">mlmdb</span> <span class="o">|</span><span class="n">tee</span> <span class="o">-</span><span class="n">a</span> <span class="n">db2updv97</span><span class="p">.</span><span class="n">mlmdb</span><span class="p">.</span><span class="n">out</span>
<span class="nl">MESSAGE:</span> <span class="n">Error</span> <span class="n">creating</span> <span class="n">system</span> <span class="n">module</span> <span class="o">:</span> <span class="n">SYSIBMADM</span><span class="p">.</span><span class="n">MONREPORT_LOCKWAIT</span>
<span class="nl">MESSAGE:</span> <span class="n">Rolling</span> <span class="n">back</span> <span class="n">work</span> <span class="n">due</span> <span class="n">to</span> <span class="n">sqlcode</span><span class="o">:</span> <span class="o">-</span><span class="mi">912</span> <span class="n">on</span> <span class="n">line</span> <span class="mf">998.</span>
<span class="n">db2updv97</span> <span class="n">processing</span> <span class="n">failed</span> <span class="k">for</span> <span class="n">database</span> <span class="err">&#39;</span><span class="n">mlmdb</span><span class="err">&#39;</span><span class="p">.</span>
</pre></div>


<p>Solution:<br />
Cause:<br />
Any one of the following may be the reason:<br />
1) The maximum number of lock requests has been reached for the database.<br />
2) The whole database and it's active and archive logs are using one rather small file system.</p>
<p>Diagnosing the problem<br />
1) Check the value assigned to LOCKLIST using below command:</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">db2</span> <span class="n">get</span> <span class="n">db</span> <span class="n">cfg</span> <span class="k">for</span> <span class="n">SAMPLE</span> <span class="o">|</span> <span class="n">find</span> <span class="o">/</span><span class="n">i</span> <span class="s">&quot;LOCKLIST&quot;</span>
</pre></div>


<p>2) File system on which database, its active and archive logs is same and smaller one.</p>
<p>Resolving the problem<br />
One of the following is recommended:<br />
1) The maximum number of locks for the database was reached because insufficient memory was allocated to the lock list.<br />
Consider increasing the database configuration parameter (locklist) to allow more lock list space.<br />
You might want to double the locklist value and rerun the db2updv97 program.<br />
For Example :<br />
Update LOCKLIST using the command:<br />
$ db2 "update db cfg for SAMPLE using LOCKLIST <new_value>".<br />
2) Either increase the file system on which the whole database and it's active and archive logs resides, or delete the old archived logs which are not required.</p>
<h3 id="finding-the-table-stataus">Finding the table stataus</h3>
<div class="hlcode"><pre><span class="n">db2</span> <span class="s">&quot;select substr(tabschema,1,10) as owner,substr(tabname,1,10) as tabname,status from syscat.tables where owner=&#39;SYSCAT&#39;&quot;</span>
</pre></div>


<h3 id="finding-all-database-path">Finding all database path</h3>
<div class="hlcode"><pre><span class="n">db2</span> <span class="s">&quot;select DBPARTITIONNUM, substr(TYPE,1,15) as TYPE, substr(PATH,1,70) as PATH from sysibmadm.DBPATHS&quot;</span>
</pre></div>


<h3 id="finding-db2level-via-sys-views">Finding db2level via sys views</h3>
<div class="hlcode"><pre><span class="n">db2</span> <span class="s">&quot;select substr(inst_name,1,20) as inst_name, substr(service_level,1,20) as db_level,substr(bld_level,1,15) as bld_level,fixpack_num from SYSIBMADM.ENV_INST_INFO&quot;</span>
</pre></div>


<h3 id="discovering-and-hiding-server-instances-and-databases">Discovering and hiding server instances and databases</h3>
<p>To allow clients to discover server instances on a system, set the discover_inst database manager configuration parameter in each server instance on the system to ENABLE (this is the default value). Set this parameter to DISABLE to hide this instance and its databases from Discovery.</p>
<p>To allow a database to be discovered from a client, set the discover_db database configuration parameter to ENABLE (this is the default value). Set this parameter to DISABLE to hide the database from Discovery.</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">db2</span> <span class="n">get</span> <span class="n">dbm</span> <span class="n">cfg</span> <span class="o">|</span><span class="n">grep</span> <span class="o">-</span><span class="n">i</span> <span class="n">discover_inst</span>
 <span class="n">Discover</span> <span class="n">server</span> <span class="n">instance</span>                <span class="p">(</span><span class="n">DISCOVER_INST</span><span class="p">)</span> <span class="o">=</span> <span class="n">ENABLE</span>
</pre></div>


<h3 id="finding-all-tables-status">Finding all tables status</h3>
<div class="hlcode"><pre><span class="n">Select</span> <span class="n">substr</span><span class="p">(</span><span class="n">tabschema</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span> <span class="n">as</span> <span class="s">&quot;Qualified Name&quot;</span><span class="p">,</span>
<span class="n">substr</span><span class="p">(</span><span class="n">tabname</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">50</span><span class="p">)</span> <span class="n">as</span> <span class="s">&quot;Table name&quot;</span><span class="p">,</span>
<span class="n">CASE</span> <span class="n">type</span>
<span class="n">WHEN</span> <span class="sc">&#39;A&#39;</span> <span class="n">THEN</span> <span class="err">&#39;</span><span class="n">Alias</span><span class="err">&#39;</span>
<span class="n">WHEN</span> <span class="sc">&#39;H&#39;</span> <span class="n">THEN</span> <span class="err">&#39;</span><span class="n">Hierarchy</span> <span class="n">Table</span><span class="err">&#39;</span>
<span class="n">WHEN</span> <span class="sc">&#39;N&#39;</span> <span class="n">THEN</span> <span class="err">&#39;</span><span class="n">Nickname</span><span class="err">&#39;</span>
<span class="n">WHEN</span> <span class="sc">&#39;S&#39;</span> <span class="n">THEN</span> <span class="err">&#39;</span><span class="n">Summary</span> <span class="n">Table</span><span class="err">&#39;</span>
<span class="n">WHEN</span> <span class="sc">&#39;T&#39;</span> <span class="n">THEN</span> <span class="err">&#39;</span><span class="n">Table</span><span class="err">&#39;</span>
<span class="n">WHEN</span> <span class="sc">&#39;U&#39;</span> <span class="n">THEN</span> <span class="err">&#39;</span><span class="n">Typed</span> <span class="n">Table</span><span class="err">&#39;</span>
<span class="n">WHEN</span> <span class="sc">&#39;V&#39;</span> <span class="n">THEN</span> <span class="err">&#39;</span><span class="n">View</span><span class="err">&#39;</span>
<span class="n">WHEN</span> <span class="sc">&#39;W&#39;</span> <span class="n">THEN</span> <span class="err">&#39;</span><span class="n">Typed</span> <span class="n">View</span><span class="err">&#39;</span>
<span class="n">END</span> <span class="n">as</span> <span class="s">&quot;Table Type&quot;</span><span class="p">,</span>
<span class="n">CASE</span> <span class="n">status</span>
<span class="n">WHEN</span> <span class="sc">&#39;N&#39;</span> <span class="n">THEN</span> <span class="err">&#39;</span><span class="n">Normal</span><span class="err">&#39;</span>
<span class="n">WHEN</span> <span class="sc">&#39;C&#39;</span> <span class="n">THEN</span> <span class="err">&#39;</span><span class="n">Check</span> <span class="n">Pending</span><span class="err">&#39;</span>
<span class="n">WHEN</span> <span class="sc">&#39;X&#39;</span> <span class="n">THEN</span> <span class="err">&#39;</span><span class="n">Inoperative</span><span class="err">&#39;</span>
<span class="n">END</span> <span class="n">as</span> <span class="s">&quot;Table Status&quot;</span>
<span class="n">from</span> <span class="n">syscat</span><span class="p">.</span><span class="n">tables</span><span class="p">;</span>
</pre></div>


<h3 id="health-monitor-tablespace">health monitor -- tablespace</h3>
<div class="hlcode"><pre><span class="n">db2</span> <span class="n">get</span> <span class="n">health</span> <span class="n">monitor</span> <span class="n">snapshot</span> <span class="k">for</span> <span class="n">database</span> <span class="n">on</span> <span class="n">db_name</span>
</pre></div>


<h3 id="log-utilization">Log utilization</h3>
<div class="hlcode"><pre><span class="n">db2</span> <span class="s">&quot;select * from sysibmadm.log_utilization&quot;</span>
</pre></div>


<h1 id="windows-server-operations">Windows server operations</h1>
<h3 id="multiple-instances-switch">Multiple instances switch</h3>
<p>When there are multiple DB2 copies on the same computer, the PATH environment variable can only point to one of them: the DEFAULT COPY. For example, if DB2COPY1 is under c:\sqllib\bin and is the default copy; and DB2COPY2 is under d:\sqllib\bin. If you want to use DB2COPY2 in a regular command window, you would run d:\sqllib\bin\db2envar.bat in that command window. This adjusts the PATH (and some other environment variables) for this command window so that it will pick up binaries from d:\sqllib\bin.<br />
DB2INSTANCE is only valid for instances under the DB2 copy that you are using. However, if you switch copies by running the db2envar.bat command, DB2INSTANCE will be updated to the value of DB2INSTDEF for the DB2 copy that you switched to initially.<br />
DB2INSTANCE is the current DB2 instance that will be used by applications that are executing in that DB2 copy. When you switch between copies, by default, DB2INSTANCE is changed to the value of DB2INSTDEF for that copy. DB2INSTDEF is less meaningful on a one copy system because all the instances are in the current copy; however, it is still applicable as being the default instance, if another instance is not set.</p>
<h3 id="issues">Issues</h3>
<p>Attempts to open a DB2 Command Window or DB2 Command Line Processor fail with:<br />
DB2CMD fails with 'C:\Program' is not recognized as an internal or external command, operable program or batch file.</p>
<p>Resolving the problem</p>
<p>Windows support for 8.3 short names is normally enabled by default, and is controlled by this registry key:</p>
<div class="hlcode"><pre>    <span class="n">HKLM</span><span class="err">\</span><span class="n">SYSTEM</span><span class="err">\</span><span class="n">CurrentControlSet</span><span class="err">\</span><span class="n">Control</span><span class="err">\</span><span class="n">FileSystem</span><span class="err">\</span><span class="n">NtfsDisable8dot3NameCreation</span>
</pre></div>


<p>8.3 short names are enabled if it is set to 0 or 2.</p>
<p>Setting the above key to 0 will not create 8.3 short names for existing directories that were created when 8.3 short names was disabled. Unfortunately, if DB2 was installed when 8.3 short names was disabled, DB2 must be re-installed after 8.3 short names have been enabled in Windows.</p>
<p>Windows 7 and later versions include the 'fsutil' command that can be used to create the 8dot3 name once the registry key is set. For example,</p>
<div class="hlcode"><pre>    <span class="n">fsutil</span> <span class="n">file</span> <span class="n">setshortname</span> <span class="s">&quot;C:\Program Files\IBM\DB2&quot;</span> <span class="n">PROGRA</span><span class="o">~</span><span class="mi">1</span>
</pre></div>


<p>The use of the 'fsutil' command will avoid the requirement for re-installing DB2.</p>
<p>This problem can also be avoided by alternately installing DB2 in a directory that does not contain spaces.</p>
<h2 id="converting-sms-tablespace-to-dms-tablespacemigrating-the-data-from-one-tablespace-to-another-tablespace">Converting SMS tablespace to DMS tablespace(Migrating the data from one tablespace to another tablespace)</h2>
<div class="hlcode"><pre><span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="s">&quot;select substr(TABLE_SCHEMA,1,10) as schema,substr(TABLE_NAME,1,15) as tabname,substr(TABLESPACE_NAME,1,15) as tbsname from sysibmadm.dba_all_tables where TABLESPACE_NAME=&#39;USERSPACE1&#39;&quot;</span>
<span class="n">SCHEMA</span>     <span class="n">TABNAME</span>         <span class="n">TBSNAME</span>
<span class="o">----------</span> <span class="o">---------------</span> <span class="o">---------------</span>
<span class="n">DB2INST1</span>   <span class="n">CL_SCHED</span>        <span class="n">USERSPACE1</span>
<span class="n">DB2INST1</span>   <span class="n">DEPARTMENT</span>      <span class="n">USERSPACE1</span>
<span class="n">DB2INST1</span>   <span class="n">EMPLOYEE</span>        <span class="n">USERSPACE1</span>
<span class="n">DB2INST1</span>   <span class="n">EMP_PHOTO</span>       <span class="n">USERSPACE1</span>
<span class="n">DB2INST1</span>   <span class="n">EMP_RESUME</span>      <span class="n">USERSPACE1</span>
<span class="n">DB2INST1</span>   <span class="n">PROJECT</span>         <span class="n">USERSPACE1</span>
<span class="n">DB2INST1</span>   <span class="n">PROJACT</span>         <span class="n">USERSPACE1</span>
<span class="n">DB2INST1</span>   <span class="n">EMPPROJACT</span>      <span class="n">USERSPACE1</span>
<span class="n">DB2INST1</span>   <span class="n">ACT</span>             <span class="n">USERSPACE1</span>
<span class="n">DB2INST1</span>   <span class="n">IN_TRAY</span>         <span class="n">USERSPACE1</span>
<span class="n">DB2INST1</span>   <span class="n">ORG</span>             <span class="n">USERSPACE1</span>
<span class="n">DB2INST1</span>   <span class="n">STAFF</span>           <span class="n">USERSPACE1</span>
<span class="n">DB2INST1</span>   <span class="n">SALES</span>           <span class="n">USERSPACE1</span>
<span class="n">DB2INST1</span>   <span class="n">STAFFG</span>          <span class="n">USERSPACE1</span>
<span class="n">DB2INST1</span>   <span class="n">ADEFUSR</span>         <span class="n">USERSPACE1</span>
<span class="n">FUNG</span>       <span class="n">CL_SCHED</span>        <span class="n">USERSPACE1</span>
<span class="n">FUNG</span>       <span class="n">DEPARTMENT</span>      <span class="n">USERSPACE1</span>
<span class="n">FUNG</span>       <span class="n">EMPLOYEE</span>        <span class="n">USERSPACE1</span>
<span class="n">FUNG</span>       <span class="n">EMP_PHOTO</span>       <span class="n">USERSPACE1</span>
<span class="n">FUNG</span>       <span class="n">EMP_RESUME</span>      <span class="n">USERSPACE1</span>
<span class="n">FUNG</span>       <span class="n">PROJECT</span>         <span class="n">USERSPACE1</span>
<span class="n">FUNG</span>       <span class="n">PROJACT</span>         <span class="n">USERSPACE1</span>
<span class="n">FUNG</span>       <span class="n">EMPPROJACT</span>      <span class="n">USERSPACE1</span>
<span class="n">FUNG</span>       <span class="n">ACT</span>             <span class="n">USERSPACE1</span>
<span class="n">FUNG</span>       <span class="n">IN_TRAY</span>         <span class="n">USERSPACE1</span>
<span class="n">FUNG</span>       <span class="n">ORG</span>             <span class="n">USERSPACE1</span>
<span class="n">FUNG</span>       <span class="n">STAFF</span>           <span class="n">USERSPACE1</span>
<span class="n">FUNG</span>       <span class="n">SALES</span>           <span class="n">USERSPACE1</span>
<span class="n">FUNG</span>       <span class="n">STAFFG</span>          <span class="n">USERSPACE1</span>
<span class="n">FUNG</span>       <span class="n">ADEFUSR</span>         <span class="n">USERSPACE1</span>
</pre></div>


<h2 id="option-1-extract-the-whole-ddls-by-the-specific-schema">Option 1. Extract the whole DDLs by the specific schema</h2>
<div class="hlcode"><pre><span class="n">db2look</span> <span class="o">-</span><span class="n">d</span> <span class="n">testdb</span> <span class="o">-</span><span class="n">z</span> <span class="n">FUNG</span> <span class="o">-</span><span class="n">e</span> <span class="o">-</span><span class="n">o</span> <span class="n">fung_schema</span><span class="p">.</span><span class="n">sql</span>
<span class="n">db2look</span> <span class="o">-</span><span class="n">d</span> <span class="n">testdb</span> <span class="o">-</span><span class="n">z</span> <span class="n">DB2INST1</span> <span class="o">-</span><span class="n">e</span> <span class="o">-</span><span class="n">o</span> <span class="n">db2inst1_schema</span><span class="p">.</span><span class="n">sql</span>
</pre></div>


<h2 id="option-2-extract-the-whole-ddls-by-the-specific-tablespace">Option 2. Extract the whole DDLs by the specific tablespace</h2>
<div class="hlcode"><pre><span class="n">db2</span> <span class="s">&quot;select &#39;db2look -d testdb -t &#39;|| rtrim(TABSCHEMA) ||&#39;.&#39;||&#39;</span><span class="se">\&quot;</span><span class="s">&#39;||TABNAME||&#39;</span><span class="se">\&quot;</span><span class="s">&#39;|| &#39; -e&#39; from syscat.tables where TBSPACEID=&#39;2&#39;&quot;</span> <span class="o">&gt;</span> <span class="n">db2look</span><span class="p">.</span><span class="n">sql</span>
<span class="p">.</span><span class="o">/</span><span class="n">db2look</span><span class="p">.</span><span class="n">sql</span> <span class="o">&gt;</span><span class="n">o</span><span class="p">.</span><span class="n">txt</span>
<span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="err">&#39;</span><span class="o">/^</span><span class="n">COMMIT</span><span class="err">\</span> <span class="n">WORK</span><span class="o">/</span><span class="n">d</span><span class="err">&#39;</span> <span class="n">o</span><span class="p">.</span><span class="n">txt</span>
<span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="err">&#39;</span><span class="o">/^</span><span class="n">CONNECT</span><span class="err">\</span> <span class="n">RESET</span><span class="o">/</span><span class="n">d</span><span class="err">&#39;</span> <span class="n">o</span><span class="p">.</span><span class="n">txt</span>
<span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="err">&#39;</span><span class="o">/^</span><span class="n">TERMINATE</span><span class="o">/</span><span class="n">d</span><span class="err">&#39;</span> <span class="n">o</span><span class="p">.</span><span class="n">txt</span>
</pre></div>


<h2 id="2-export-all-the-data-belong-to-the-tbs">2. Export all the data belong to the TBS</h2>
<div class="hlcode"><pre><span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="n">db2move</span><span class="p">;</span> <span class="n">cd</span> <span class="n">db2move</span>
<span class="n">db2move</span> <span class="n">testdb</span> <span class="n">export</span> <span class="o">-</span><span class="n">ts</span> <span class="n">USERSPACE1</span>
</pre></div>


<h2 id="3-create-new-tbs">3. Create new tbs</h2>
<div class="hlcode"><pre><span class="n">db2</span> <span class="s">&quot;create tablespace convert1&quot;</span>
</pre></div>


<h2 id="4-drop-the-tbs">4. Drop the tbs</h2>
<div class="hlcode"><pre><span class="n">db2</span> <span class="s">&quot;drop tablespace userspace1&quot;</span>
</pre></div>


<h2 id="5-replace-the-tablespace-to-convert1-in-the-fung_schemasql-and-db2inst1_schemasql">5. Replace the tablespace to convert1 in the fung_schema.sql and db2inst1_schema.sql</h2>
<div class="hlcode"><pre><span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="err">&#39;</span><span class="o">/</span><span class="n">USERSPACE1</span><span class="o">/</span><span class="n">s</span><span class="o">/</span><span class="n">USERSPACE1</span><span class="o">/</span><span class="n">CONVERT1</span><span class="o">/</span><span class="n">g</span><span class="err">&#39;</span> <span class="n">fung_schema</span><span class="p">.</span><span class="n">sql</span>
<span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="err">&#39;</span><span class="o">/</span><span class="n">USERSPACE1</span><span class="o">/</span><span class="n">s</span><span class="o">/</span><span class="n">USERSPACE1</span><span class="o">/</span><span class="n">CONVERT1</span><span class="o">/</span><span class="n">g</span><span class="err">&#39;</span> <span class="n">db2inst1_schema</span><span class="p">.</span><span class="n">sql</span>
</pre></div>


<h2 id="6-create-the-table">6. Create the table</h2>
<div class="hlcode"><pre><span class="n">db2</span> <span class="n">connect</span> <span class="n">to</span> <span class="n">testdb</span>
<span class="n">db2</span> <span class="o">-</span><span class="n">tvf</span> <span class="n">fung_schema</span><span class="p">.</span><span class="n">sql</span>
<span class="n">db2</span> <span class="o">-</span><span class="n">tvf</span> <span class="n">db2inst1_schema</span><span class="p">.</span><span class="n">sql</span>
</pre></div>


<h2 id="7-load-the-data-back-to-the-new-tablespace">7. Load the data back to the new tablespace</h2>
<div class="hlcode"><pre><span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="n">db2move</span><span class="p">]</span><span class="err">$</span> <span class="n">db2move</span> <span class="n">testdb</span> <span class="n">load</span> <span class="o">-</span><span class="n">l</span> <span class="p">.</span><span class="o">/</span>
</pre></div>


<h2 id="8-set-integrity">8. Set integrity</h2>
<h3 id="finding-the-table-status">Finding the table status</h3>
<div class="hlcode"><pre><span class="n">Select</span> <span class="n">substr</span><span class="p">(</span><span class="n">tabschema</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span> <span class="n">as</span> <span class="s">&quot;Qualified Name&quot;</span><span class="p">,</span>
<span class="n">substr</span><span class="p">(</span><span class="n">tabname</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">50</span><span class="p">)</span> <span class="n">as</span> <span class="s">&quot;Table name&quot;</span><span class="p">,</span>
<span class="n">CASE</span> <span class="n">type</span>
<span class="n">WHEN</span> <span class="sc">&#39;A&#39;</span> <span class="n">THEN</span> <span class="err">&#39;</span><span class="n">Alias</span><span class="err">&#39;</span>
<span class="n">WHEN</span> <span class="sc">&#39;H&#39;</span> <span class="n">THEN</span> <span class="err">&#39;</span><span class="n">Hierarchy</span> <span class="n">Table</span><span class="err">&#39;</span>
<span class="n">WHEN</span> <span class="sc">&#39;N&#39;</span> <span class="n">THEN</span> <span class="err">&#39;</span><span class="n">Nickname</span><span class="err">&#39;</span>
<span class="n">WHEN</span> <span class="sc">&#39;S&#39;</span> <span class="n">THEN</span> <span class="err">&#39;</span><span class="n">Summary</span> <span class="n">Table</span><span class="err">&#39;</span>
<span class="n">WHEN</span> <span class="sc">&#39;T&#39;</span> <span class="n">THEN</span> <span class="err">&#39;</span><span class="n">Table</span><span class="err">&#39;</span>
<span class="n">WHEN</span> <span class="sc">&#39;U&#39;</span> <span class="n">THEN</span> <span class="err">&#39;</span><span class="n">Typed</span> <span class="n">Table</span><span class="err">&#39;</span>
<span class="n">WHEN</span> <span class="sc">&#39;V&#39;</span> <span class="n">THEN</span> <span class="err">&#39;</span><span class="n">View</span><span class="err">&#39;</span>
<span class="n">WHEN</span> <span class="sc">&#39;W&#39;</span> <span class="n">THEN</span> <span class="err">&#39;</span><span class="n">Typed</span> <span class="n">View</span><span class="err">&#39;</span>
<span class="n">END</span> <span class="n">as</span> <span class="s">&quot;Table Type&quot;</span><span class="p">,</span>
<span class="n">CASE</span> <span class="n">status</span>
<span class="n">WHEN</span> <span class="sc">&#39;N&#39;</span> <span class="n">THEN</span> <span class="err">&#39;</span><span class="n">Normal</span><span class="err">&#39;</span>
<span class="n">WHEN</span> <span class="sc">&#39;C&#39;</span> <span class="n">THEN</span> <span class="err">&#39;</span><span class="n">Check</span> <span class="n">Pending</span><span class="err">&#39;</span>
<span class="n">WHEN</span> <span class="sc">&#39;X&#39;</span> <span class="n">THEN</span> <span class="err">&#39;</span><span class="n">Inoperative</span><span class="err">&#39;</span>
<span class="n">END</span> <span class="n">as</span> <span class="s">&quot;Table Status&quot;</span>
<span class="n">from</span> <span class="n">syscat</span><span class="p">.</span><span class="n">tables</span><span class="p">;</span>

<span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="o">-</span><span class="n">tvf</span> <span class="n">finding_all_table_status</span><span class="p">.</span><span class="n">sql</span> <span class="o">|</span><span class="n">grep</span> <span class="o">-</span><span class="n">v</span> <span class="n">Normal</span>
<span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="s">&quot;select &#39;set integrity for &#39;|| rtrim(tabschema)||&#39;.&#39;||tabname|| &#39; IMMEDIATE CHECKED;&#39; from syscat.tables where status !=&#39;N&#39;&quot;</span><span class="o">&gt;</span><span class="n">setint</span><span class="p">.</span><span class="n">sql</span>
<span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="n">connect</span> <span class="n">to</span> <span class="n">testdb</span>
<span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="o">-</span><span class="n">tvf</span> <span class="n">setint</span><span class="p">.</span><span class="n">sql</span>
<span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="o">-</span><span class="n">tvf</span> <span class="n">finding_all_table_status</span><span class="p">.</span><span class="n">sql</span> <span class="o">|</span><span class="n">grep</span> <span class="o">-</span><span class="n">v</span> <span class="n">Normal</span>
</pre></div>


<h3 id="if-some-tables-are-co-dependents-tables-we-need-to-execute-the-tables-as-a-whole-set-integrity-command">If some tables are co-dependents tables, we need to execute the tables as a whole set integrity command</h3>
<div class="hlcode"><pre><span class="nb">SET</span> <span class="nx">INTEGRITY</span> <span class="nb">FOR</span> <span class="o">&lt;</span><span class="nx">table1</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nx">table2</span><span class="o">&gt;</span> <span class="nx">IMMEDIATE</span> <span class="nb">CHECKED</span>
</pre></div>


<h2 id="privilege">Privilege</h2>
<div class="hlcode"><pre><span class="n">db2</span> <span class="o">-</span><span class="n">x</span> <span class="s">&quot;select &#39;grant select on table &#39; || rtrim(tabschema) || &#39;.&#39; || rtrim(tabname) || &#39; to user JOHN_DOE&#39; from syscat.tables where tabschema like &#39;FOO%&#39; and (type = &#39;T&#39; or type = &#39;V&#39;)&quot;</span> <span class="o">|</span> <span class="n">db2</span> <span class="o">+</span><span class="n">p</span> <span class="o">-</span><span class="n">tv</span>

<span class="n">db2</span> <span class="s">&quot;SELECT substr(AUTHID,1,10) as AUTHID, PRIVILEGE, substr(OBJECTNAME,1,20) as OBJECTNAME, substr(OBJECTSCHEMA,1,10) as OBJECTSCHEMA, OBJECTTYPE</span>
       <span class="n">FROM</span> <span class="n">SYSIBMADM</span><span class="p">.</span><span class="n">PRIVILEGES</span> <span class="n">where</span> <span class="n">authid</span><span class="o">=</span><span class="err">&#39;</span><span class="n">LISHUAI</span><span class="err">&#39;</span><span class="s">&quot; |more</span>

<span class="n">db2</span> <span class="n">grant</span> <span class="n">dbadm</span> <span class="n">on</span> <span class="n">database</span> <span class="n">to</span> <span class="n">user</span>
<span class="n">db2</span> <span class="n">revoke</span> <span class="n">dbadm</span> <span class="n">on</span> <span class="n">database</span> <span class="n">from</span> <span class="n">user</span>
<span class="n">db2</span> <span class="s">&quot;select * from SYSCAT.DBAUTH  where GRANTEE = &#39;USER&#39; &quot;</span>

<span class="n">db2</span> <span class="s">&quot;select char(grantee,8) as grantee, char(granteetype,1) as type, \</span>
<span class="s">char(dbadmauth,1) as dbadm,  char(createtabauth,1) as createtab,  \</span>
<span class="s">char(bindaddauth,1) as bindadd,  char(connectauth,1) as connect,  \</span>
<span class="s">char(nofenceauth,1) as nofence,  char(implschemaauth,1) as implschema,  \</span>
<span class="s">char(loadauth,1) as load,  char(externalroutineauth,1) as extroutine,  \</span>
<span class="s">char(quiesceconnectauth,1) as quiesceconn,  \</span>
<span class="s">char(libraryadmauth,1) as libadm, char(securityadmauth,1) \</span>
<span class="s">as securityadm from  syscat.dbauth order by grantee&quot;</span>


<span class="n">db2</span> <span class="s">&quot;select substr(authority,1,25) as authority, d_user, d_group,</span>
<span class="n">d_public</span><span class="p">,</span> <span class="n">role_user</span><span class="p">,</span> <span class="n">role_group</span><span class="p">,</span> <span class="n">role_public_role</span> <span class="n">from</span> <span class="n">table</span><span class="p">(</span>
<span class="n">sysproc</span><span class="p">.</span><span class="n">auth_list_authorities_for_authid</span> <span class="p">(</span><span class="err">&#39;</span><span class="n">public</span><span class="sc">&#39;,&#39;</span><span class="n">g</span><span class="err">&#39;</span><span class="p">))</span><span class="n">as</span> <span class="n">t</span>
<span class="n">order</span> <span class="n">by</span> <span class="n">authority</span><span class="s">&quot;      &quot;</span>
</pre></div>


<h2 id="binding-packages">Binding Packages</h2>
<div class="hlcode"><pre><span class="n">bind</span> <span class="s">&quot;C:\PROGRA~1\IBM\SQLLIB</span><span class="se">\b</span><span class="s">nd\db2schema.bnd&quot;</span> <span class="n">blocking</span> <span class="n">all</span> <span class="n">grant</span> <span class="n">public</span>
<span class="n">bind</span> <span class="s">&quot;C:\PROGRA~1\IBM\SQLLIB</span><span class="se">\b</span><span class="s">nd\@db2ubind.lst&quot;</span> <span class="n">blocking</span> <span class="n">all</span> <span class="n">grant</span> <span class="n">public</span>
<span class="n">bind</span> <span class="s">&quot;C:\PROGRA~1\IBM\SQLLIB</span><span class="se">\b</span><span class="s">nd\@db2cli.lst&quot;</span> <span class="n">blocking</span> <span class="n">all</span> <span class="n">grant</span> <span class="n">public</span>
<span class="n">db2</span> <span class="n">bind</span> <span class="n">db2clpcs</span><span class="p">.</span><span class="n">bnd</span> <span class="n">blocking</span> <span class="n">all</span> <span class="n">grant</span> <span class="n">public</span>
</pre></div>


<h3 id="tsm-restart-db2vend">TSM restart db2vend</h3>
<div class="hlcode"><pre><span class="n">db2pd</span> <span class="o">-</span><span class="n">d</span> <span class="n">db_name</span> <span class="o">-</span><span class="n">fvp</span> <span class="n">lam1</span> <span class="n">term</span>
</pre></div>


<p>https://www.ibm.com/support/knowledgecenter/en/SSEPGG_10.1.0/com.ibm.db2.luw.admin.cmd.doc/doc/r0011729.html?cp=SSEPGG_10.1.0</p>
<h2 id="sql0551n-user-do-not-have-the-required-authorization">SQL0551N user do not have the required authorization</h2>
<p>After restoring from anther user and didn't set the db2set DB2_RESTORE_GRANT_ADMIN_AUTHORITIES=ON, the current user id would not have the access the previous user ID's table, to resolve this issue, grant the secadm with the previous user id(db2inst1) to current id(db2v97i), grant the dbamin to current id, assumed the two ids are located on the same machine:</p>
<div class="hlcode"><pre><span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="p">.</span> <span class="o">~</span><span class="n">db2v97i</span><span class="o">/</span><span class="n">sqllib</span><span class="o">/</span><span class="n">db2profile</span>
<span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="n">connect</span> <span class="n">to</span> <span class="n">testdbd</span>
<span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="n">grant</span> <span class="n">secadm</span> <span class="n">to</span> <span class="n">db2v97i</span>
<span class="p">[</span><span class="n">db2inst1</span><span class="err">@</span><span class="n">db2srv</span> <span class="o">~</span><span class="p">]</span><span class="err">$</span> <span class="n">db2</span> <span class="n">GRANT</span> <span class="n">DBADM</span> <span class="n">ON</span> <span class="n">DATABASE</span> <span class="n">TO</span> <span class="n">USER</span> <span class="n">db2v97i</span>
</pre></div>


<h3 id="getting-the-quiesce-status-of-instancedatabase">getting the quiesce status of instance/database</h3>
<div class="hlcode"><pre><span class="n">instgltp</span><span class="err">@</span><span class="n">g01acirdb009</span><span class="o">:/</span><span class="n">db</span><span class="o">/</span><span class="n">instgltp</span><span class="o">/</span><span class="n">db2diag</span><span class="err">$</span> <span class="n">db2</span> <span class="n">get</span> <span class="n">snapshot</span> <span class="k">for</span> <span class="n">database</span> <span class="n">on</span> <span class="n">MAXDBPRD</span> <span class="o">|</span><span class="n">grep</span> <span class="o">-</span><span class="n">i</span> <span class="n">status</span>
<span class="n">Database</span> <span class="n">status</span>                            <span class="o">=</span> <span class="n">Active</span>
<span class="n">instgltp</span><span class="err">@</span><span class="n">g01acirdb009</span><span class="o">:/</span><span class="n">db</span><span class="o">/</span><span class="n">instgltp</span><span class="o">/</span><span class="n">db2diag</span><span class="err">$</span> <span class="n">db2</span> <span class="n">get</span> <span class="n">snapshot</span> <span class="k">for</span> <span class="n">dbm</span> <span class="o">|</span><span class="n">grep</span> <span class="o">-</span><span class="n">i</span> <span class="n">status</span>
<span class="n">Database</span> <span class="n">manager</span> <span class="n">status</span>                        <span class="o">=</span> <span class="n">Active</span>
<span class="n">instgltp</span><span class="err">@</span><span class="n">g01acirdb009</span><span class="o">:/</span><span class="n">db</span><span class="o">/</span><span class="n">instgltp</span><span class="o">/</span><span class="n">db2diag</span><span class="err">$</span>
</pre></div>


<h3 id="tsm-kud-issue">TSM kud issue</h3>
<ol>
<li>Use Root user to stop the process(AIX team)</li>
</ol>
<div class="hlcode"><pre><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">IBM</span><span class="o">/</span><span class="n">ITM</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">itmcmd</span> <span class="n">agent</span> <span class="o">-</span><span class="n">o</span> <span class="n">instwem1</span> <span class="n">stop</span> <span class="n">ud</span>
</pre></div>


<ol>
<li>sudo to instance user and start the kud process.</li>
</ol>
<div class="hlcode"><pre><span class="n">nohup</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">IBM</span><span class="o">/</span><span class="n">ITM</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">itmcmd</span> <span class="n">agent</span> <span class="o">-</span><span class="n">o</span> <span class="n">instwem1</span> <span class="n">start</span> <span class="n">ud</span> <span class="o">&amp;</span>
</pre></div>


<p>DB2 trace<br />
the only thing I can suggest you is to collect DB2 trace when you will try to reproduce the issue again<br />
something like:</p>
<div class="hlcode"><pre><span class="n">db2trc</span> <span class="n">on</span> <span class="o">-</span><span class="n">f</span> <span class="n">db2trc</span><span class="p">.</span><span class="n">dmp</span>
<span class="n">db2</span> <span class="n">connect</span> <span class="n">to</span> <span class="n">ESWFE1</span> <span class="n">user</span> <span class="n">a1inoppt</span> <span class="n">using</span> <span class="n">password</span>
<span class="n">db2trc</span> <span class="n">off</span>
<span class="n">db2trc</span> <span class="n">fmt</span> <span class="n">db2trc</span><span class="p">.</span><span class="n">dmp</span> <span class="n">db2trc</span><span class="p">.</span><span class="n">fmt</span>
<span class="n">db2trc</span> <span class="n">flw</span> <span class="n">db2trc</span><span class="p">.</span><span class="n">dmp</span> <span class="n">db2trc</span><span class="p">.</span><span class="n">flw</span>
</pre></div>


<p>when you will be not able to connect due to the same reason</p>
<h2 id="stop-tivoli-monitoring-before-upgrade">stop tivoli monitoring before upgrade</h2>
<div class="hlcode"><pre><span class="p">/</span><span class="nx">opt</span><span class="p">/</span><span class="nx">IBM</span><span class="p">/</span><span class="nx">ITM</span><span class="p">/</span><span class="nx">bin</span><span class="p">/</span><span class="nx">itmcmd</span> <span class="nx">agent</span> <span class="na">-o</span> <span class="o">&lt;</span><span class="nx">instance_name</span><span class="o">&gt;</span> <span class="nb">stop</span> <span class="nx">ud</span>
<span class="p">/</span><span class="nx">opt</span><span class="p">/</span><span class="nx">IBM</span><span class="p">/</span><span class="nx">ITM</span><span class="p">/</span><span class="nx">bin</span><span class="p">/</span><span class="nx">itmcmd</span> <span class="nx">agent</span> <span class="na">-o</span> <span class="o">&lt;</span><span class="nx">instance_name</span><span class="o">&gt;</span> <span class="nb">start</span> <span class="nx">ud</span>
</pre></div>


<h2 id="db2-error-code">db2 error code:</h2>
<div class="hlcode"><pre><span class="n">db2</span> <span class="o">?</span> <span class="n">sqlstate</span> <span class="o">-</span><span class="mi">10060</span>
<span class="n">db2</span> <span class="o">?</span> <span class="n">SQLnnnn</span> <span class="p">(</span><span class="n">nnnn</span> <span class="o">=</span> <span class="mi">4</span> <span class="n">or</span> <span class="mi">5</span> <span class="n">digit</span> <span class="n">SQLCODE</span><span class="p">)</span>
<span class="n">db2</span> <span class="o">?</span> <span class="n">nnnnn</span> <span class="p">(</span><span class="n">nnnnn</span> <span class="o">=</span> <span class="mi">5</span> <span class="n">digit</span> <span class="n">SQLSTATE</span><span class="p">)</span>

<span class="n">db2diag</span> <span class="o">-</span><span class="n">rc</span> <span class="mi">2029059891</span>
</pre></div>


<h2 id="to-display-all-logged-error-messages-containing-the-db2-zrc-return-code">To display all logged error messages containing the DB2 ZRC return code</h2>
<div class="hlcode"><pre> <span class="mh">0x87040055</span><span class="o">=-</span><span class="mi">2029780907</span><span class="o">=</span><span class="n">SQLD_PRGERR</span><span class="p">,</span> <span class="n">enter</span><span class="o">:</span>
</pre></div>


<p>db2diag -g msg:=0x87040055 -l Error</p>
<h2 id="db2-privilege-catalog-view">DB2 privilege catalog view</h2>
<div class="hlcode"><pre><span class="n">SYSCAT</span><span class="p">.</span><span class="n">DBAUTH</span>              <span class="n">Database</span> <span class="n">privileges</span>
<span class="n">SYSCAT</span><span class="p">.</span><span class="n">COLAUTH</span>             <span class="n">Table</span> <span class="n">and</span> <span class="n">View</span> <span class="n">Column</span> <span class="n">privileges</span>
<span class="n">SYSCAT</span><span class="p">.</span><span class="n">INDEXAUTH</span>           <span class="n">Index</span> <span class="n">privileges</span>
<span class="n">SYSCAT</span><span class="p">.</span><span class="n">PACKAGEAUTH</span>         <span class="n">Access</span> <span class="n">Package</span> <span class="n">privileges</span>
<span class="n">SYSCAT</span><span class="p">.</span><span class="n">SCHEMAAUTH</span>          <span class="n">Schema</span> <span class="n">privileges</span>
<span class="n">SYSCAT</span><span class="p">.</span><span class="n">TABAUTH</span>             <span class="n">Table</span> <span class="n">and</span> <span class="n">view</span> <span class="n">privileges</span>
<span class="n">SYSCAT</span><span class="p">.</span><span class="n">TBSPACEAUTH</span>         <span class="n">Table</span> <span class="n">space</span> <span class="n">privileges</span>
</pre></div>


<h2 id="snap-catalog-view">snap catalog view</h2>
<div class="hlcode"><pre><span class="n">db2</span> <span class="s">&quot;select substr(VIEWSCHEMA,1,10) as viewschema, substr(VIEWNAME,1,20) as viewname from syscat.views where owner=&#39;SYSIBM&#39; and viewname like  &#39;%SNAP%&#39;&quot;</span>
<span class="n">VIEWSCHEMA</span> <span class="n">VIEWNAME</span>
<span class="o">----------</span> <span class="o">--------------------</span>
<span class="n">SYSIBMADM</span>  <span class="n">SNAPLOCK</span>
<span class="n">SYSIBMADM</span>  <span class="n">SNAPAGENT</span>
<span class="n">SYSIBMADM</span>  <span class="n">SNAPAGENT_MEMORY_POO</span>
<span class="n">SYSIBMADM</span>  <span class="n">SNAPAPPL</span>
<span class="n">SYSIBMADM</span>  <span class="n">SNAPAPPL_INFO</span>
<span class="n">SYSIBMADM</span>  <span class="n">SNAPBP</span>
<span class="n">SYSIBMADM</span>  <span class="n">SNAPBP_PART</span>
<span class="n">SYSIBMADM</span>  <span class="n">SNAPCONTAINER</span>
<span class="n">SYSIBMADM</span>  <span class="n">SNAPDB</span>
<span class="n">SYSIBMADM</span>  <span class="n">SNAPDB_MEMORY_POOL</span>
<span class="n">SYSIBMADM</span>  <span class="n">SNAPDBM</span>
<span class="n">SYSIBMADM</span>  <span class="n">SNAPDBM_MEMORY_POOL</span>
<span class="n">SYSIBMADM</span>  <span class="n">SNAPDETAILLOG</span>
<span class="n">SYSIBMADM</span>  <span class="n">SNAPDYN_SQL</span>
<span class="n">SYSIBMADM</span>  <span class="n">SNAPFCM</span>
<span class="n">SYSIBMADM</span>  <span class="n">SNAPFCM_PART</span>
<span class="n">SYSIBMADM</span>  <span class="n">SNAPHADR</span>
<span class="n">SYSIBMADM</span>  <span class="n">SNAPLOCKWAIT</span>
<span class="n">SYSIBMADM</span>  <span class="n">SNAPSTMT</span>
<span class="n">SYSIBMADM</span>  <span class="n">SNAPSTORAGE_PATHS</span>
<span class="n">SYSIBMADM</span>  <span class="n">SNAPSUBSECTION</span>
<span class="n">SYSIBMADM</span>  <span class="n">SNAPSWITCHES</span>
<span class="n">SYSIBMADM</span>  <span class="n">SNAPTAB_REORG</span>
<span class="n">SYSIBMADM</span>  <span class="n">SNAPTAB</span>
<span class="n">SYSIBMADM</span>  <span class="n">SNAPTBSP</span>
<span class="n">SYSIBMADM</span>  <span class="n">SNAPTBSP_PART</span>
<span class="n">SYSIBMADM</span>  <span class="n">SNAPTBSP_QUIESCER</span>
<span class="n">SYSIBMADM</span>  <span class="n">SNAPTBSP_RANGE</span>
<span class="n">SYSIBMADM</span>  <span class="n">SNAPUTIL</span>
<span class="n">SYSIBMADM</span>  <span class="n">SNAPUTIL_PROGRESS</span>
</pre></div>


<h2 id="db2-table-size">DB2 table size</h2>
<div class="hlcode"><pre><span class="n">select</span>
  <span class="kt">char</span><span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">stats_time</span><span class="p">))</span><span class="o">||</span><span class="sc">&#39; &#39;</span><span class="o">||</span><span class="kt">char</span><span class="p">(</span><span class="n">time</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">stats_time</span><span class="p">))</span> <span class="n">as</span> <span class="n">statstime</span>
  <span class="p">,</span><span class="n">substr</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">tabschema</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span><span class="o">||</span><span class="sc">&#39;.&#39;</span><span class="o">||</span><span class="n">substr</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">tabname</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">24</span><span class="p">)</span> <span class="n">as</span> <span class="n">tabname</span>
  <span class="p">,</span><span class="n">card</span> <span class="n">as</span> <span class="n">rows_per_table</span>
  <span class="p">,</span><span class="n">decimal</span><span class="p">(</span><span class="kt">float</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">npages</span><span class="p">)</span><span class="o">/</span> <span class="p">(</span> <span class="mi">1024</span> <span class="o">/</span> <span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">pagesize</span><span class="o">/</span><span class="mi">1024</span><span class="p">)),</span><span class="mi">9</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="n">as</span> <span class="n">used_mb</span>
  <span class="p">,</span><span class="n">decimal</span><span class="p">(</span><span class="kt">float</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">fpages</span><span class="p">)</span><span class="o">/</span> <span class="p">(</span> <span class="mi">1024</span> <span class="o">/</span> <span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">pagesize</span><span class="o">/</span><span class="mi">1024</span><span class="p">)),</span><span class="mi">9</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="n">as</span> <span class="n">allocated_mb</span>
<span class="n">from</span>
  <span class="n">syscat</span><span class="p">.</span><span class="n">tables</span> <span class="n">t</span> <span class="p">,</span> <span class="n">syscat</span><span class="p">.</span><span class="n">tablespaces</span> <span class="n">b</span>
<span class="n">where</span> <span class="n">t</span><span class="p">.</span><span class="n">tbspace</span><span class="o">=</span><span class="n">b</span><span class="p">.</span><span class="n">tbspace</span>
<span class="n">order</span> <span class="n">by</span> <span class="mi">5</span> <span class="n">desc</span> <span class="n">with</span> <span class="n">ur</span>
</pre></div>


<h2 id="db2-index-size">DB2 index size</h2>
<div class="hlcode"><pre><span class="n">select</span>
  <span class="n">rtrim</span><span class="p">(</span><span class="n">substr</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">tabschema</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span><span class="o">||</span><span class="sc">&#39;.&#39;</span><span class="o">||</span><span class="n">rtrim</span><span class="p">(</span><span class="n">substr</span><span class="p">(</span> <span class="n">i</span><span class="p">.</span><span class="n">tabname</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="mi">24</span><span class="p">))</span> <span class="n">as</span> <span class="n">tabname</span>
 <span class="p">,</span><span class="n">decimal</span><span class="p">(</span><span class="n">sum</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">nleaf</span><span class="p">)</span><span class="o">/</span><span class="p">(</span> <span class="mi">1024</span> <span class="o">/</span> <span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">pagesize</span><span class="o">/</span><span class="mi">1024</span><span class="p">)),</span><span class="mi">12</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="n">as</span> <span class="n">indx_used_per_table_mb</span>
<span class="n">from</span>
   <span class="n">syscat</span><span class="p">.</span><span class="n">indexes</span> <span class="n">i</span><span class="p">,</span> <span class="n">syscat</span><span class="p">.</span><span class="n">tables</span> <span class="n">t</span> <span class="p">,</span> <span class="n">syscat</span><span class="p">.</span><span class="n">tablespaces</span> <span class="n">b</span>
<span class="n">where</span>
   <span class="n">i</span><span class="p">.</span><span class="n">tabschema</span> <span class="n">is</span> <span class="n">not</span> <span class="n">null</span> <span class="n">and</span> <span class="n">i</span><span class="p">.</span><span class="n">tabname</span><span class="o">=</span><span class="n">t</span><span class="p">.</span><span class="n">tabname</span>
   <span class="n">and</span> <span class="n">i</span><span class="p">.</span><span class="n">tabschema</span><span class="o">=</span><span class="n">t</span><span class="p">.</span><span class="n">tabschema</span> <span class="n">and</span> <span class="n">t</span><span class="p">.</span><span class="n">tbspace</span><span class="o">=</span><span class="n">b</span><span class="p">.</span><span class="n">tbspace</span>
<span class="n">group</span> <span class="n">by</span>
   <span class="n">i</span><span class="p">.</span><span class="n">tabname</span><span class="p">,</span><span class="n">i</span><span class="p">.</span><span class="n">tabschema</span><span class="p">,</span> <span class="n">b</span><span class="p">.</span><span class="n">pagesize</span> <span class="n">order</span> <span class="n">by</span> <span class="mi">2</span> <span class="n">desc</span> <span class="n">with</span> <span class="n">ur</span>
</pre></div>


<h1 id="db2dart-demo">db2dart demo</h1>
<h2 id="1-extract-the-ddl-with-db2look">1. extract the DDL with db2look</h2>
<div class="hlcode"><pre><span class="n">db2look</span> <span class="o">-</span><span class="n">d</span> <span class="n">testdb</span> <span class="o">-</span><span class="n">e</span> <span class="o">-</span><span class="n">z</span> <span class="n">SCHEMA_NAME</span> <span class="o">-</span><span class="n">t</span> <span class="n">TABNAME</span> <span class="o">-</span><span class="n">o</span> <span class="n">OUTPUT</span><span class="p">.</span><span class="n">ddl</span>
</pre></div>


<h2 id="2-finding-the-specific-table-resided-in-which-tablespace">2. finding the specific table resided in which tablespace</h2>
<div class="hlcode"><pre><span class="n">db2</span> <span class="s">&quot;select substr(tabname,1,20) as tabname, TBSPACEID from syscat.tables where tabname=&#39;TABNAME&#39;&quot;</span>
</pre></div>


<h2 id="3-extract-the-data-with-db2dart">3. extract the data with db2dart</h2>
<div class="hlcode"><pre><span class="n">db2dart</span> <span class="n">testdb</span> <span class="o">/</span><span class="n">DDEL</span>
<span class="o">&gt;</span><span class="n">EMPLOYEE</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">100</span>
</pre></div>


<h2 id="4-load-the-data-into-the-table">4. load the data into the table</h2>
<div class="hlcode"><pre><span class="n">db2</span> <span class="o">-</span><span class="n">tvf</span> <span class="n">OUTPUT</span><span class="p">.</span><span class="n">ddl</span>
<span class="n">db2</span> <span class="s">&quot;load from TBALE.DEL of DEL insert into TABNAME&quot;</span>
<span class="n">db2</span> <span class="n">set</span> <span class="n">integrity</span> <span class="k">for</span> <span class="n">TABNAME</span> <span class="n">immediate</span> <span class="n">checked</span>
</pre></div>
  
</div>
    </div>
    <div id="footer">
      <!-- <div class="footer-left"> -->
      <!-- <div class="footer-center"> -->
        <center>
        <p>
        Copyright © 2012-2018 Fung Kong.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.
        Theme by <a href="https://github.com/tankywoo/yasimple_x2" target="_blank">YASimple_X2</a>.
        </p>
        </center>
      <!-- </div> [> end footer-left <] -->
      <!-- <div class="footer-right"> -->
        <!-- <p>站点最后生成 2018-01-31 17:22:28</p> -->
      <!-- </div> [> end footer-right <] -->
    </div>

    
    

  </body>
</html>